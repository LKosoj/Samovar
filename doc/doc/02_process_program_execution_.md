# Глава 2: Выполнение программы процесса

Добро пожаловать в учебник по самовару! В [Глава 1: Взаимодействие с пользователем (Web и LCD)](01_user_interaction__web___lcd__.md) мы узнали, как вы можете указать самовару, что делать, используя его физический или веб-интерфейс. Теперь давайте рассмотрим, что происходит *после* нажатия кнопки «Старт» или выбора программы: как самовар автоматически выполняет последовательность шагов для осуществления вашего процесса пивоварения или дистилляции.

Представьте, что вы следуете рецепту. Рецепт - это не просто одна инструкция, это список шагов: «Нагреть воду до X градусов», „Добавить ингредиент Y и перемешивать в течение Z минут“, „Выдержать температуру A градусов в течение B часов“ и так далее. Каждый шаг имеет определенные требования (температура, время, действие).

В проекте «Самовар» рассматриваются такие сложные процессы, как перегонка спирта (ректификация, дистилляция, НБК) или варка пива (этапы приготовления сусла, кипячение). Эти процессы также требуют соблюдения точной последовательности шагов с определенными параметрами. Контролировать все вручную по ходу процесса было бы невероятно утомительно и требовало бы постоянного внимания.

Именно здесь на помощь приходит **Process Program Execution**. Это похоже на то, как если бы автоматизированный шеф-повар точно следовал вашему рецепту.

## Что такое программа процесса?

В Samovar «программа» - это просто сохраненный список или последовательность шагов. Каждый шаг в программе указывает самовару на выполнение определенного действия с определенными параметрами до тех пор, пока не будет выполнено заданное условие.

Рассматривайте программу как электронную таблицу или список инструкций для самовара. Например, шаг в программе «Ректификация» может выглядеть следующим образом:

* **Тип:** Сбор голов
* ** Объем:** 100 мл
* **Скорость:** 0,1 л/ч
* **Целевая температура:** (необязательно, часто основывается на предыдущем шаге)
* **Сосуд для сбора:** Контейнер 1
**Мощность нагревателя:** 120 В (или эквивалентный процент/мощность)

Шаг в программе «Пиво» может выглядеть следующим образом:

* **Тип:** Температурная пауза (шаг затирания)
* **Целевая температура:** 65°C
* **Длительность:** 60 минут
**Миксер/насос:** Работает периодически
**Мощность нагревателя:** Контролируется ПИД для поддержания температуры

Как видите, параметры могут отличаться в зависимости от общего *режима* (ректификация, пиво, NBK), но основная идея та же: шаг определяет, *что* делать, *как много/как быстро/при какой температуре* делать, и *когда остановиться* и перейти к следующему шагу.

Самовару необходимо:
1.  Хранить эти программы.
2.  Знать, какой этап программы активен в данный момент.
3.  Выполнять действия, требуемые текущим шагом.
4.  Контролировать условия, чтобы определить, когда текущий шаг будет завершен.
5.  Автоматически переходить к следующему шагу.

## Программы и режимы

Самовар поддерживает различные режимы (Ректификация, Дистилляция, Пиво, НБК). Хотя все они используют концепцию программы, состоящей из шагов, значение параметров внутри шага может немного отличаться в зависимости от режима. Например, «Объем» в программе «Ректификация» означает сбор жидкости, а в программе «Пиво» - продолжительность работы миксера/насоса.

Встроенное программное обеспечение самовара использует общую структуру для хранения данных для каждого шага, а код, специфичный для каждого режима, интерпретирует эту структуру.

Структура, используемая для определения одного шага программы, называется `WProgram` в коде:

```c++
// Из Samovar.h
struct WProgram {
  String WType; // Тип шага (например, «Головы», «Тело», «Пауза», «Пюре», «Кипячение»)
  uint16_t Volume; // Объем (мл) или продолжительность (сек. для паузы/мешалки)
  float Скорость; // Скорость (л/ч) или значение (% алкоголя, температура)
  uint8_t capacity_num; // Номер сосуда или конфигурация режима миксера/насоса
  float Temp; // Целевая температура или дельта температуры
  uint16_t Power; // Настройка напряжения/мощности нагревателя
  uint8_t TempSensor; // Датчик температуры для мониторинга (используется в некоторых режимах, например, Пиво)
  float Time; // Рассчитанная продолжительность на основе объема/скорости или явное время
};

WProgram program[30]; // Массив для хранения шагов программы
```
