<html>
<head>
<meta charset='utf-8'>
<meta http-equiv="Cache-Control" content="no-cache">

<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<title>Самовар</title>

<link rel="stylesheet" href="/style.css">

<script>

var is_program = false;

function loadFile(e) {
	var file = e;
	var reader = new FileReader();
	reader.onload = function () {
		get_brew_info(reader.result);
	};
	reader.readAsText(file, "UTF-8");
}

function parseXml(xml, arrayTags) {
    let dom = null;
    if (window.DOMParser) dom = (new DOMParser()).parseFromString(xml, "text/xml");
    else if (window.ActiveXObject) {
        dom = new ActiveXObject('Microsoft.XMLDOM');
        dom.async = false;
        if (!dom.loadXML(xml)) throw dom.parseError.reason + " " + dom.parseError.srcText;
    }
    else throw new Error("cannot parse xml string!");

    function parseNode(xmlNode, result) {
        if (xmlNode.nodeName == "#text") {
            let v = xmlNode.nodeValue;
            if (v.trim()) result['#text'] = v;
            return;
        }

        let jsonNode = {},
            existing = result[xmlNode.nodeName];
        if (existing) {
            if (!Array.isArray(existing)) result[xmlNode.nodeName] = [existing, jsonNode];
            else result[xmlNode.nodeName].push(jsonNode);
        }
        else {
            if (arrayTags && arrayTags.indexOf(xmlNode.nodeName) != -1) result[xmlNode.nodeName] = [jsonNode];
            else result[xmlNode.nodeName] = jsonNode;
        }

        if (xmlNode.attributes) for (let attribute of xmlNode.attributes) jsonNode[attribute.nodeName] = attribute.nodeValue;

        for (let node of xmlNode.childNodes) parseNode(node, jsonNode);
    }

    let result = {};
    for (let node of dom.childNodes) parseNode(node, result);

    return result;
}

function isArray(myArray) {
  // checks for null and undefined
  if (myArray == null) {
    return false;
  }
  return Symbol.iterator in Object(myArray);
}

function isNumeric(str) {
  if (typeof str != "string") return false // we only process strings!  
  return !isNaN(str) && // use type coercion to parse the _entirety_ of the string (`parseFloat` alone does not do this)...
         !isNaN(parseFloat(str)) // ...and ensure strings of whitespace fail
}

function get_object_value(Obj, str = ""){
    if (typeof Obj != "undefined") {
      if (isNumeric(Obj["#text"])) return (parseFloat(Obj["#text"])) + str;
      else if (typeof Obj["#text"] != "undefined") return Obj["#text"] + str;
            else return "Нет в рецепте";
    }
    else return "Нет в рецепте";
}

function get_brew_info(xml){
    is_program = false;
	let recipe = parseXml(xml);
	//show main info
    document.getElementById("STYLE").textContent = get_object_value(recipe.RECIPES.RECIPE.STYLE.NAME);
    document.getElementById("NAME").textContent = get_object_value(recipe.RECIPES.RECIPE.NAME);
    document.getElementById("TYPE").textContent = get_object_value(recipe.RECIPES.RECIPE.TYPE);
    document.getElementById("BATCH_SIZE").textContent = get_object_value(recipe.RECIPES.RECIPE.BATCH_SIZE, " л.");
    document.getElementById("BOIL_SIZE").textContent = get_object_value(recipe.RECIPES.RECIPE.BOIL_SIZE, " л.");
    document.getElementById("BOIL_TIME").textContent = get_object_value(recipe.RECIPES.RECIPE.BOIL_TIME, " мин.");
    document.getElementById("NOTES").innerHTML = get_object_value(recipe.RECIPES.RECIPE.NOTES);
    document.getElementById("PRIMARY_TEMP").innerHTML = get_object_value(recipe.RECIPES.RECIPE.PRIMARY_TEMP, " &deg;С");
    
    //show ingredients
    var dl = document.createElement("div");
  
    var dl1 = document.createElement("div");
    dl1.className = "ingredients";
    var type = document.createElement("label");
    type.textContent = "Тип";
    type.className = "ingType";
    dl1.appendChild(type);
    var name = document.createElement("label");
    name.textContent = "Название";
    name.className = "ingName";
    name.style = "text-align: center;";
    dl1.appendChild(name);
    var amount = document.createElement("label");
    amount.textContent = "Количество";
    amount.className = "ingAmount";
    dl1.appendChild(amount);
    dl.appendChild(dl1);
    
    var ingr = document.getElementById("ingredients");
    ingr.innerHTML = "";
    ingr.appendChild(dl);

    var FERMENTABLE = [];
    if (Array.isArray(recipe.RECIPES.RECIPE.FERMENTABLES.FERMENTABLE)){
       FERMENTABLE = recipe.RECIPES.RECIPE.FERMENTABLES.FERMENTABLE;
    } else {FERMENTABLE.push(recipe.RECIPES.RECIPE.FERMENTABLES.FERMENTABLE) }
    //grain
    for (let ferm of FERMENTABLE){
      var dl1 = document.createElement("div");
      dl1.className = "ingredients";
  
      var type = document.createElement("label");
      type.textContent = "Солод";
      type.className = "ingType";
      dl1.appendChild(type);
      var name = document.createElement("label");
      name.textContent = get_object_value(ferm.NAME);
      name.className = "ingName";
      dl1.appendChild(name);
      var amount = document.createElement("label");
      amount.textContent = get_object_value(ferm.AMOUNT);
      amount.className = "ingAmount";
      dl1.appendChild(amount);
    
      dl.appendChild(dl1);
    }

    //hop
    var HOP = [];
    if (Array.isArray(recipe.RECIPES.RECIPE.HOPS.HOP)){
       HOP = recipe.RECIPES.RECIPE.HOPS.HOP;
    } else {HOP.push(recipe.RECIPES.RECIPE.HOPS.HOP) }
    for (let hop of HOP){
      var dl1 = document.createElement("div");
      dl1.className = "ingredients";
  
      var type = document.createElement("label");
      type.textContent = "Хмель";
      type.className = "ingType";
      dl1.appendChild(type);
      var name = document.createElement("label");
      name.textContent = get_object_value(hop.NAME);
      name.className = "ingName";
      dl1.appendChild(name);
      var amount = document.createElement("label");
      amount.textContent = get_object_value(hop.AMOUNT);
      amount.className = "ingAmount";
      dl1.appendChild(amount);
    
      dl.appendChild(dl1);
    }
    
    //yeast
    var YEAST = [];
    if (Array.isArray(recipe.RECIPES.RECIPE.YEASTS.YEAST)){
       YEAST = recipe.RECIPES.RECIPE.YEASTSYEAST;
    } else {YEAST.push(recipe.RECIPES.RECIPE.YEASTS.YEAST) }
    for (let yeast of YEAST){
      var dl1 = document.createElement("div");
      dl1.className = "ingredients";
  
      var type = document.createElement("label");
      type.textContent = "Дрожжи";
      type.className = "ingType";
      dl1.appendChild(type);
      var name = document.createElement("label");
      name.textContent = get_object_value(yeast.NAME)
      name.className = "ingName";
      dl1.appendChild(name);
      var amount = document.createElement("label");
      amount.textContent = get_object_value(yeast.AMOUNT);
      amount.className = "ingAmount";
      dl1.appendChild(amount);

      dl.appendChild(dl1);
    }
    
    //show mash step
    var dl = document.createElement("div");
    var dl1 = document.createElement("div");
    dl1.className = "ingredients";
  
    var name = document.createElement("label");
    name.textContent = "Название";
    name.className = "mashName";
    dl1.appendChild(name);
    var descr = document.createElement("label");
    descr.textContent = "Тип";
    descr.className = "mashType";
    dl1.appendChild(descr);
    var mtemp = document.createElement("label");
    mtemp.textContent = "Температура";
    mtemp.className = "mashTemp";
    dl1.appendChild(mtemp);
    var mtime = document.createElement("label");
    mtime.textContent = "Время";
    mtime.className = "mashTime";
    dl1.appendChild(mtime);
    dl.appendChild(dl1);
    
    //mash
    var MASH = [];
    if (Array.isArray(recipe.RECIPES.RECIPE.MASH.MASH_STEPS.MASH_STEP)){
       MASH = recipe.RECIPES.RECIPE.MASH.MASH_STEPS.MASH_STEP;
    } else {MASH.push(recipe.RECIPES.RECIPE.MASH.MASH_STEPS.MASH_STEP) }
    for (let mash of MASH){
      var dl1 = document.createElement("div");
      dl1.className = "ingredients";
  
      var name = document.createElement("label");
      name.textContent = get_object_value(mash.NAME)
      name.className = "mashName";
      dl1.appendChild(name);
      var type = document.createElement("label");
      type.textContent = get_object_value(mash.TYPE)
      type.className = "mashType";
      dl1.appendChild(type);
      var step_temp = document.createElement("label");
      step_temp.textContent = get_object_value(mash.STEP_TEMP)
      step_temp.className = "mashTemp";
      dl1.appendChild(step_temp);
      var step_time = document.createElement("label");
      step_time.textContent = get_object_value(mash.STEP_TIME)
      step_time.className = "mashTemp";
      dl1.appendChild(step_time);

      dl.appendChild(dl1);
    }

    var ingr = document.getElementById("mash");
    ingr.innerHTML = "";
    ingr.appendChild(dl);
    
    is_program = true;
}

function set_program(){
	if (is_program) alert("Ok");
	else alert("Error");
}
</script>
</head>
<body>
<form action='none' onsubmit='return false' name="mainform" id="mainform">
<h1>
<div class="message-box" style="display: none;" id="message"></div>
Samovar v. <span id='version'>%v%</span>
</h1>

<div class="text">Программа затирания</div>

<div style="margin: 0 auto; width: 200px;">
<label for="fileToLoad" class="button custom-file-upload">
    <i class="fa fa-cloud-upload"></i>Загрузить рецепт
</label>
<input type="file" id="fileToLoad" accept="application/xml" onchange="loadFile(this.files[0])" class="button"/>
</div>
</div>

<div class="tabcontent" style="display: block;border-top: solid;border-top-width: 1px;border-top-color: rgb(204, 204, 204);">
<div id="brew">
<label style="font-size: 20px; font-weight: 600;">Описание рецепта:</label>
<div class="container_row" style="border: 1px dashed #bbb; margin-bottom: 1em;">
<div class="specs">
<div>
<label>Стиль: </label><label class="specs" id="STYLE"></label>
</div>
<div>
<label>Сорт: </label><label class="specs" id="NAME"></label>
</div>
<div>
<label>Тип: </label><label class="specs" id="TYPE"></label>
</div>
<div>
<label>Выход: </label><label class="specs" id="BATCH_SIZE"></label>
</div>
<div>
<label>Объем кипения: </label><label class="specs" id="BOIL_SIZE"></label>
</div>
<div>
<label>Температура брожения: </label><label class="specs" id="PRIMARY_TEMP"></label>
</div>
<div>
<label>Время кипения: </label><label class="specs" id="BOIL_TIME"></label>
</div>
<div>
<label>Заметки: </label><label class="specs" id="NOTES"></label>
</div>
</div>
</div>

<div className="ingredients">
<label style="font-size: 20px; font-weight: 600;">Ингредиенты:</label>
<div class="container_row" style="border: 1px dashed #bbb; margin-bottom: 1em;">
<div id="ingredients">
</div>
</div>
</div>

<div className="ingredients">
<label style="font-size: 20px; font-weight: 600;">Температурные паузы:</label>
<div class="container_row" style="border: 1px dashed #bbb; margin-bottom: 1em;">
<div id="mash">
</div>
</div>
</div>

<div style="margin: 0 auto; width: 450px;">
<input id='setprogram' type='button' name='setprogram' value='Установить программу' onclick='set_program();' class="button">
<input id='return' type='button' name='return' value='На главную' onclick='javascript:location.href="/index.htm"' class="button">
</div>


</div>
</div>
</form>
</body>