<html><head><meta charset=utf-8 /><meta http-equiv=Cache-Control content=no-cache /><link rel="shortcut icon" href=/favicon.ico type=image/x-icon /><link rel=stylesheet href=/style.css /><title>Самовар</title><script>function ConnectError(n){n?OfflineCouner?(document.getElementById("connection_indicator").innerHTML=`
          <img src="Red_light.gif" style="margin: 0!important; width: 20px">`,addMessage("Обрыв связи!",0),setTimeout(()=>{IsOffline=!0,OfflineCouner=0},100)):OfflineCouner++:(document.getElementById("connection_indicator").innerHTML=`
        <img src="Green.png" style="margin: 0 !important; width: 20px">`,IsOffline=!1,OfflineCouner=0)}function setPowerUnit(){let t,i,r,u,n;pwr_unit==="P"?(t="Мощность регулятора: ",i="Установить мощность",r="Текущая мощн.: ",u="Целевая мощн.: ",n=" Вт",document.getElementById("current_power_line").style="visibility: hidden",document.getElementById("PWR").style=""):pwr_unit==="V"?(t="Напряжение регулятора: ",i="Установить напряжение",r="Текущее напр.: ",u="Целевое напр.: ",n=" V",document.getElementById("current_power_line").style="visibility: visible",document.getElementById("PWR").style=""):document.getElementById("PWR").style="visibility: hidden;position: fixed;";document.getElementById("set_power_label").innerHTML=t;document.getElementById("SetVoltage").value=i;document.getElementById("power_current").innerHTML=r;document.getElementById("power_target").innerHTML=u;document.getElementById("power_unit_current").innerHTML=n;document.getElementById("power_unit_target").innerHTML=n}function AddLuaButtons(){let n="%btn_list%";if(n!==""){let t=n.split(",");for(z=0;z<t.length;z++)if(t[z]!==""){let i=t[z].split("|"),n=document.createElement("input");n.type="submit";n.name="luabtn"+z;n.value=i[1];n.className="button";n.setAttribute("onclick",'run_lua("'+i[0]+'");');document.getElementById("lua_btn_ln").appendChild(n);document.getElementById("lua_btn").style="visibility: visible"}}}function playSound(n){!sound_is_playing&&n?(sound.play(),sound_is_playing=!0):sound_is_playing&&!n&&(sound.pause(),sound_is_playing=!1)}function addMessage(n,t){if(!IsOffline){let r=(new Date).toLocaleTimeString("ru-RU"),i=null;switch(t){case 0:i="message_0";is_ALARM=!0;break;case 1:i="message_1";break;case 2:i="message_2";break;default:i="message_0";is_ALARM=!0}let u=`
            <div align="left" class=${i} onclick=removeLastMessage() style="cursor: pointer">
              ${r}  ${n}
            </div>`;if(Messages_Array.push(u),Messages_Array.length>1){previousMsg=Messages_Array[Messages_Array.length-2];let n=previousMsg.replace('onclick=removeLastMessage() style="cursor: pointer"',"");Messages_Array[Messages_Array.length-2]=n}showMessages()}}function removeLastMessage(){if(Messages_Array.pop(),Messages_Array.length>0){lastMsg=Messages_Array[Messages_Array.length-1];let n=lastMsg.replace('<div align="left"','<div align="left" onclick=removeLastMessage() style="cursor: pointer"');Messages_Array[Messages_Array.length-1]=n}else is_ALARM=!1,IsCalmingPause=!1;showMessages()}function showMessages(){if(Messages_Array.length>0){let n=[];document.getElementById("messages").innerHTML="";Messages_Array.forEach(t=>{document.getElementById("messages").innerHTML+=t,n.push(t.includes("class=message_0"))});document.getElementById("messagesBox").style.display="block";let t=document.getElementById("messagesBox");t.scrollTop=t.scrollHeight;function i(n){return n===!0}is_ALARM=n.some(i);sound_is_on&is_ALARM?playSound(!0):playSound(!1)}else document.getElementById("messagesBox").style.display="none",playSound(!1)}function clearMessages(){Messages_Array=[];showMessages()}function headerClick(){this.nextElementSibling.classList.toggle("spoiler-body");var n=this.parentNode.getElementsByClassName("spoiler-sign");n[0].innerHTML=n[0].innerHTML=="[+]"?"[-]":"[+]"}function loadFile(n){var i=n,t=new FileReader;t.onload=function(){for(var n=document.getElementById("prg");n.firstChild;)n.removeChild(n.firstChild);document.getElementById("WProgram").value=t.result;glcalcnum=!1;getProgram()};t.readAsText(i,"UTF-8")}function SaveProgramToFile(){var t,i,n;t="programbackup.txt";i=document.getElementById("WProgram").value;n=document.createElement("a");n.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(i));n.setAttribute("download",t);n.style.display="none";document.body.appendChild(n);n.click();document.body.removeChild(n)}function openTab(n,t){for(var r,u=document.getElementsByClassName("tabcontent"),i=0;i<u.length;i++)u[i].style.display="none";for(r=document.getElementsByClassName("tablinks"),i=0;i<r.length;i++)r[i].className=r[i].className.replace(" active","");return document.getElementById(t).style.display="block",n.currentTarget.className+=" active",0}function check_program(n){var r=n.split("\n"),u=0,f=!0,t,e;for(i=0;i<r.length;i++)e=r[i].split(";"),t=e.length,t==1&&e[0]!=""&&r.length==i-1?f=!1:u>0&&t>1&&u!=t&&(f=!1),u=t;return f}function set_program(){if(document.getElementById("WProgram").value=document.getElementById("WProgram").value.replace(",","."),!check_program(document.getElementById("WProgram").value)){alert("Program error!");return}request=new XMLHttpRequest;request.onreadystatechange=function(){if(this.readyState==4&&this.status==200){var n=this.responseText;n!="OK"&&(document.getElementById("WProgram").value=n,alert("Ok"))}};request.open("POST","/program",!1);let n=new FormData(document.forms.mainform);return request.send(n),request.status!=200&&alert(request.status+": "+request.statusText),0}function sleep(n){for(var i=(new Date).getTime(),t=0;t<1e7;t++)if((new Date).getTime()-i>n)break}function sendbutton(n){var t="/command?"+n;return request=new XMLHttpRequest,request.open("GET",t,!1),request.send(),request.status!=200&&alert("sendbutton ERROR! "+request.status+": "+request.statusText),sleep(1e3),0}function sendvoltage(){var n=document.getElementById("Voltage").value,t;return!n.match(/^\d+\.\d+$/)&&!n.match(/^-{0,1}\d+$/)?(alert("Введите напряжение!"),0):(t="voltage="+n,sendbutton(t),alert("Установлено."),0)}function sendpumpspeed(){var n=document.getElementById("pumpspeed").value,t;return!n.match(/^\d+\.\d+$/)&&!n.match(/^-{0,1}\d+$/)?(alert("Введите скорость!"),0):(t="pumpspeed="+n,sendbutton(t),alert("Ok"),0)}function loadDoc(){var n=new XMLHttpRequest;n.timeout=4e3;n.onreadystatechange=function(){var n,t,i;this.readyState==4&&this.status==200&&(ConnectError(!1),n=JSON.parse(this.responseText),document.getElementById("version").innerHTML=n.version,document.getElementById("crnt_tm").innerHTML=n.crnt_tm,document.getElementById("stm").innerHTML=n.stm,document.getElementById("TankTemp").innerHTML=n.TankTemp.toFixed(3),document.getElementById("WthdrwlProgress").innerHTML=n.WthdrwlProgress,n.PrgType==="P"?n.PrgType="Пауза; ":n.PrgType==="M"?n.PrgType="Темп. закладки солода; ":n.PrgType==="B"?n.PrgType="Кипячение; ":n.PrgType==="C"?n.PrgType="Охлаждение; ":n.PrgType==="W"?n.PrgType="Ожидание; ":n.PrgType==="F"&&(n.PrgType="Брожение; "),document.getElementById("Status").innerHTML=n.PrgType+n.Status,document.getElementById("current_power_volt").innerHTML=n.current_power_volt,document.getElementById("target_power_volt").innerHTML=n.target_power_volt,document.getElementById("current_power_mode").innerHTML=n.current_power_mode,document.getElementById("current_power_p").innerHTML=n.current_power_p,document.getElementById("bme_temp").innerHTML=n.bme_temp,document.getElementById("heap").innerHTML=n.heap,document.getElementById("rssi").innerHTML=n.rssi,document.getElementById("fr_bt").innerHTML=n.fr_bt,sound_is_on=!!n.UseBBuzzer,n.Lstatus&&n.Lstatus!=""&&(document.getElementById("Lstatus").innerHTML=n.Lstatus),n.Msg&&n.Msg!==""&&addMessage(n.Msg,n.msglvl),n.LogMsg&&n.LogMsg!==""&&console.log(n.crnt_tm+"; "+n.LogMsg),n.PowerOn==1?(t="Выключить нагрев",i="red"):(t="Включить нагрев",i="lightgreen"),document.getElementById("power").value=t,document.getElementById("power").style.backgroundColor=i)};n.onerror=function(){ConnectError(!0)};n.ontimeout=function(){ConnectError(!0)};n.open("GET","/ajax",!0);n.send()}function calc_program(){if(!check_program(document.getElementById("WProgram").value)){alert("Program error!");return}var t=document.getElementsByClassName("prgline"),r,n;for(n="",i=1;i<t.length;i++){for(r=t[i].childNodes,j=1;j<5;j++)n=n+r[j].value+";";n=n.slice(0,-1);n=n+"\n"}document.getElementById("WProgram").value=n;set_num()}function set_num(){var t=document.getElementById("prg").childNodes,n;for(i=1;i<t.length;i++)n=t[i].childNodes[0],n.innerText="",i<10&&(n.innerText="0"),n.innerText=n.innerText+i}function removeLine(n){var i=document.getElementById("prg").childNodes.length,t;i<3||(t=document.getElementById(n),t.remove(),calc_program())}function addLine(n,t){var s=t.split(";"),i=document.createElement("div"),h,r,u,f,e,o,c,l,a;i.className="prgline";i.id="prgln"+_lnIdx;h=document.createElement("label");h.className="prglabel";i.appendChild(h);h.insertAdjacentHTML("afterend",'<select id="ptype'+_lnIdx+'" name="ptype'+_lnIdx+'" onchange="set_bgcolor('+_lnIdx+')"><option value="P">Пауза<\/option><option value="M">Темп. закладки солода&nbsp;&nbsp;<\/option><option value="B">Кипячение<\/option><option value="C">Охлаждение<\/option><option value="W">Ожидание<\/option><option value="F">Брожение<\/option><\/select>');r=document.createElement("input");r.type="text";r.name="ptemp"+_lnIdx;r.value=s[1];r.setAttribute("onchange","calc_program();");i.appendChild(r);u=document.createElement("input");u.type="text";u.name="ptime"+_lnIdx;u.value=s[2];u.setAttribute("onchange","calc_program();");i.appendChild(u);f=document.createElement("input");f.type="text";f.name="pmixer"+_lnIdx;f.value=s[3];f.setAttribute("onchange","calc_program();");i.appendChild(f);e=document.createElement("img");e.src="/plus.png";e.setAttribute("width","20");e.setAttribute("onclick","addLine('prgln"+_lnIdx+"','W;0;0')");i.appendChild(e);o=document.createElement("img");o.src="/minus.png";o.setAttribute("width","20");o.setAttribute("onclick","removeLine('prgln"+_lnIdx+"')");i.appendChild(o);n?(c=document.getElementById(n),c.after(i)):(c=document.getElementById("prg"),c.appendChild(i));l="ptype"+_lnIdx;a=document.getElementById(l);a.value=s[0];set_bgcolor(_lnIdx);_lnIdx++;calc_program()}function getProgram(){var t,i,n;if(!check_program(document.getElementById("WProgram").value)){alert("Program error!");return}for(t=document.getElementById("prg"),t.insertAdjacentHTML("afterbegin",'<div class="prgline" id="hdr"><label class="tooltip">№<\/label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="tooltip">Тип программы<\/label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="tooltip">Темп<span class="tooltiptext">Задается для программ "Пауза", "Охлаждение", "Темп. закладки солода" и "Брага"<\/span><\/label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="tooltip">Время<span class="tooltiptext">Задается для программ "Пауза", "Ожидание" и "Кипячение"<\/span><\/label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="tooltip">Мешалка<span class="tooltiptext">Управление мешалкой<\/span><\/label><\/div>'),i=document.getElementById("WProgram"),n=i.value.split("\n"),z=0;z<n.length;z++)n[z]!=""&&addLine(!1,n[z])}function set_bgcolor(n){var u=document.getElementById("prgln"+n),i=document.getElementById("ptype"+n).value,r;let t="black";for(i=="M"?t="background-color: #FFFF00;":i=="B"?t="background-color: #FF6347;":i=="C"?t="background-color: #00BFFF;":i=="P"?t="background-color: #FFA500;":i=="W"?t="background-color: #98FB98;":i=="F"&&(t="background-color: #DACEFF;"),u.setAttribute("style",t),r=u.childNodes,q=0;q<r.length;q++)q==4?r[q].setAttribute("style",t+"width:150"):r[q].setAttribute("style",t);calc_program()}function run_lua(n){sendbutton("lua="+n)}var IsOffline=!1,OfflineCouner=0,sound_is_on=!0,IsCalmingPause=!1,Messages_Array=[],sound_is_playing=!1,is_ALARM=!1;const sound=new Audio("alarm.mp3");sound.loop=!0;sound.preload="auto";sound.autoplay=!1;var pwr_unit="%pwr_unit%",_lnIdx=0,headers=document.querySelectorAll("[data-name='spoiler-title']");setInterval(loadDoc,2e3);window.onload=function(){headers=document.querySelectorAll("[data-name='spoiler-title']");headers.forEach(function(n){n.addEventListener("click",headerClick)});getProgram();document.getElementById("WProgram").addEventListener("change",function(){if(!check_program(document.getElementById("WProgram").value)){alert("Program error!");return}for(var n=document.getElementById("prg");n.firstChild;)n.removeChild(n.firstChild);getProgram()});setPowerUnit();AddLuaButtons()}</script></head><body><form action=none onsubmit="return false" name=mainform id=mainform><div class=tab><input type=button class="tablinks active" onclick="openTab(event, 'Main');" value=Затирание /><input type=button class=tablinks onclick="openTab(event, 'Prog');" value=Программа /><input type=button class=tablinks onclick="openTab(event, 'Other');" value=Дополнительно /></div><div id=Main class=tabcontent style="display: block;"><div class=container_row style="justify-content: space-between; font-size: 1em; margin-bottom: 0.5em;"><div style="display: flex; flex-direction: row; justify-content: flex-start; align-items: center; font-weight: bold"><div style="display: flex; flex-direction: column; justify-content: flex-start; align-items: center"><div>Samovar</div><span id=crnt_tm style="height: 0; visibility: hidden"></span><div style="display: flex; flex-direction: row; justify-content: flex-start; align-items: center;"><div>v.</div><div id=version></div></div></div><div style="width: 21px; display: flex; flex-direction: column; justify-content: center; align-items: center"><div id=connection_indicator><img src=Green.png style="margin: 0 !important; width: 20px" /></div></div><div class=messages_box style="display: none;" id=messagesBox><div style="position: absolute; height: 0.6em; top: 0; right: 0.5em; cursor: pointer" onclick=clearMessages()>[x] очистить</div><div class=messages_array id=messages></div></div></div><div style="display: flex; flex-direction: column; align-items: center; font-weight: bold;">Работа: <span id=stm></span></div></div><div class=container_column style="border: 1px dashed #bbb; margin-bottom: 1em;"><div class=container><div class="text column" style="color: %TankColor%;">Т в кубе: <span id=TankTemp style="font-size: xx-large;"></span>°C</div></div></div><div class=container_row style="margin-top: 1em; background-color: #7cfc0063; padding-top: 0.5em; padding-bottom: 0.5em;"><span style="padding-left: 1em; font-size: 1.5em; font-weight: bold; color: #333">Статус: <span id=Status></span></span></div><div class=container_column style="border: 1px dashed #bbb; margin-bottom: 1em;"><div class=container><div class=text>Прогресс: <span id=WthdrwlProgress></span>%</div></div></div><div class=container_row style="border: 1px dashed #bbb; margin-bottom: 1em; justify-content: space-between;" id=PWR><div class=container_column style="border: 1px dashed #bbb; margin-bottom: 1em;"><div class=text id=VoltH2 style="visibility: hidden; position: absolute;"><div class=container_row style="padding-left: 2em; justify-content: space-around; align-items:center;"><span id=set_power_label></span><input name=Voltage id=Voltage type=text /></div><input id=SetVoltage type=submit name=SetVoltage class=button /></div><div class=dvcs id=regulator style="padding-left: 0 !important; padding-right: 0 !important;"><span class=dvcs><span id=power_current></span> <span id=current_power_volt></span> <span id=power_unit_current></span></span> <span class=dvcs><span id=power_target></span> <span id=target_power_volt></span> <span id=power_unit_target></span></span> <span class=dvcs>Режим регулятора: <span id=current_power_mode></span></span> <span class=dvcs id=current_power_line>Мощность: <span id=current_power_p></span> Вт</span></div></div></div><div><span class=dvcs>Системные параметры: Heap=<span id=heap></span>; BME temp=<span id=bme_temp></span>; RSSI = <span id=rssi></span>; Свободно: <span id=fr_bt></span></span></div><div><input id=power type=submit name=power class=button value="Включить нагрев" onclick='sendbutton("power=1");' /><input id=start type=submit name=start class=button value="Следующая программа" onclick='sendbutton("start=1");' /><input id=chart type=submit name=chart class=button value=График onclick='javascript:location.href="/chart.htm"' /><input id=setup type=submit name=setup class=button value=Настройки onclick='javascript:location.href="/setup.htm"' /></div></div><div id=Prog class=tabcontent><div class=text>Программа затирки:</div><div class=prg id=prg></div><div class=list-group><div class="list-group-item list-header" data-name=spoiler-title><span class=spoiler-sign>[+]</span>Описание программы затирки:</div>
        <div class="list-group-item list-content spoiler-body">
          <textarea cols=40 rows=7 id=WProgram name=WProgram>%WProgram%</textarea><div class=dvcs><p><span>Параметры программы затирания: Тип программы;Температура;Время;Режим работы мешалки</span></p><p><span> </span></p><p><span>M - malt application temp (температура закладки солода), P - pause (пауза при заданной температуре),</span></p><p><span>B - boil (кипячение и засыпка хмеля в конце), C - cool (охлаждение до заданной температуры),</span></p><p><span>W - wait (режим ожидания, ничего не делает до смены строки программы), F - ferment (ферментирование, режим браги, поддерживает заданную температуру до сменты строки программы).</span></p><p><span> </span></p><p><span>Пример программы отбора:</span></p><p><span>M;45.00;0;1^1.00^1^1</span></p><p><span>P;60.00;1;1^1.00^1^1</span></p><p><span>W;0.00;1;1^1.00^1^1</span></p><p><span>B;0.00;1;1^1.00^1^1</span></p><p><span>C;30.00;0;1^1.00^1^1</span></p><p><span> </span></p><p><span> </span></p><p><span>Описание режима работы мешалки: последним значением задается режим работы мешалки. 1^-1.00^2^3, где</span></p><p><span>1 - Тип устройства - 1 - мешалка, 2 - насос, 3 - мешалка и насос одновременно</span></p><p><span>-1.00 - Направление вращения, если задано отрицательное значение - мешалка после паузы меняет направление вращения (если поддерживает оборудование)</span></p><p><span>2 - Время включения в мин</span></p><p><span>3 - Время выключения в мин</span></p></div></div></div><div class=list-group><div class="list-group-item list-header" data-name=spoiler-title><span class=spoiler-sign>[+]</span>Описание программы затирки в текстовом формате для сохранения в облаке:</div>
        <div class="list-group-item list-content spoiler-body">
          <textarea cols=40 rows=5 id=Descr name=Descr maxlength=250>%Descr%</textarea></div></div><hr style="margin-bottom: 20px !important; margin-top: 20px !important;" /><div style="margin: 0 auto; width: 200px;"><input id=saveform type=button name=saveform value="Сохранить программу" onclick=SaveProgramToFile(); class=button /></div><div style="margin: 0 auto; width: 200px;"><label for=fileToLoad class="button custom-file-upload" style="margin-left: 0px !important;"><i class="fa fa-cloud-upload"></i> Загрузить программу</label><input type=file id=fileToLoad accept=text/plain onchange=loadFile(this.files[0]) class=button /></div><div style="margin: 0 auto; margin-top: 20px !important; width: 200px;"><input id=setprogram type=button name=setprogram value="Установить программу" onclick=set_program(); class=button /></div><div style="margin: 0 auto; margin-top: 20px !important; width: 200px;"><input id=loadprogram type=button name=loadprogram value="Загрузить рецепт из XML" onclick='javascript:location.href="/brewxml.htm"' class=button /></div></div><div id=Other class=tabcontent><div style="visibility: hidden" id=lua_btn><div class=container_row style="border: 1px dashed #bbb; margin-bottom: 1em; justify-content: space-between;"><div class=container_column style="flex: 1.1; padding-left: 2em;"><div class=container_row style="justify-content: space-around; align-items: center;" id=lua_btn_ln></div><div class=container_row style="margin-top: 10px !important; margin-bottom: 10px !important;"><span>Статус Lua:</span><span id=Lstatus></span></div></div></div></div></div></form></body></html>