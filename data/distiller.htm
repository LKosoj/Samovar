<html><head><meta charset=utf-8 /><meta http-equiv=Cache-Control content=no-cache /><link rel="shortcut icon" href=/favicon.ico type=image/x-icon /><link rel=stylesheet href=/style.css /><title>Самовар</title><script>function ConnectError(n){n?OfflineCouner?(document.getElementById("connection_indicator").innerHTML=`
          <img src="Red_light.gif" style="margin: 0!important; width: 20px">`,addMessage("Обрыв связи!",0),setTimeout(()=>{IsOffline=!0,OfflineCouner=0},100)):OfflineCouner++:(document.getElementById("connection_indicator").innerHTML=`
        <img src="Green.png" style="margin: 0 !important; width: 20px">`,IsOffline=!1,OfflineCouner=0)}function setPowerUnit(){let t,i,r,u,n;pwr_unit==="P"?(t="Мощность регулятора: ",i="Установить мощность",r="Текущая мощн.: ",u="Целевая мощн.: ",n=" Вт",document.getElementById("current_power_line").style="visibility: hidden",document.getElementById("PWR").style=""):pwr_unit==="V"?(t="Напряжение регулятора: ",i="Установить напряжение",r="Текущее напр.: ",u="Целевое напр.: ",n=" V",document.getElementById("current_power_line").style="visibility: visible",document.getElementById("PWR").style=""):document.getElementById("PWR").style="visibility: hidden;position: fixed;";document.getElementById("set_power_label").innerHTML=t;document.getElementById("SetVoltage").value=i;document.getElementById("power_current").innerHTML=r;document.getElementById("power_target").innerHTML=u;document.getElementById("power_unit_current").innerHTML=n;document.getElementById("power_unit_target").innerHTML=n}function AddLuaButtons(){let n="%btn_list%";if(n!==""){let t=n.split(",");for(z=0;z<t.length;z++)if(t[z]!==""){let i=t[z].split("|"),n=document.createElement("input");n.type="submit";n.name="luabtn"+z;n.value=i[1];n.className="button";n.setAttribute("onclick",'run_lua("'+i[0]+'");');document.getElementById("lua_btn_ln").appendChild(n);document.getElementById("lua_btn").style="visibility: visible"}}}function playSound(n){!sound_is_playing&&n?(sound.play(),sound_is_playing=!0):sound_is_playing&&!n&&(sound.pause(),sound_is_playing=!1)}function addMessage(n,t){if(!IsOffline){let r=(new Date).toLocaleTimeString("ru-RU"),i=null;switch(t){case 0:i="message_0";is_ALARM=!0;break;case 1:i="message_1";break;case 2:i="message_2";break;default:i="message_0";is_ALARM=!0}let u=`
            <div align="left" class=${i} onclick=removeLastMessage() style="cursor: pointer">
              ${r}  ${n}
            </div>`;if(Messages_Array.push(u),Messages_Array.length>1){previousMsg=Messages_Array[Messages_Array.length-2];let n=previousMsg.replace('onclick=removeLastMessage() style="cursor: pointer"',"");Messages_Array[Messages_Array.length-2]=n}showMessages()}}function removeLastMessage(){if(Messages_Array.pop(),Messages_Array.length>0){lastMsg=Messages_Array[Messages_Array.length-1];let n=lastMsg.replace('<div align="left"','<div align="left" onclick=removeLastMessage() style="cursor: pointer"');Messages_Array[Messages_Array.length-1]=n}else is_ALARM=!1,IsCalmingPause=!1;showMessages()}function showMessages(){if(Messages_Array.length>0){let n=[];document.getElementById("messages").innerHTML="";Messages_Array.forEach(t=>{document.getElementById("messages").innerHTML+=t,n.push(t.includes("class=message_0"))});document.getElementById("messagesBox").style.display="block";let t=document.getElementById("messagesBox");t.scrollTop=t.scrollHeight;function i(n){return n===!0}is_ALARM=n.some(i);sound_is_on&is_ALARM?playSound(!0):playSound(!1)}else document.getElementById("messagesBox").style.display="none",playSound(!1)}function clearMessages(){Messages_Array=[];showMessages()}function openTab(n,t){for(var r,u=document.getElementsByClassName("tabcontent"),i=0;i<u.length;i++)u[i].style.display="none";for(r=document.getElementsByClassName("tablinks"),i=0;i<r.length;i++)r[i].className=r[i].className.replace(" active","");return document.getElementById(t).style.display="block",n.currentTarget.className+=" active",0}function setDistCommand(){var n="distiller=";n=document.getElementById("power").value=="Выключить нагрев"?n+"0":n+"1";sendbutton(n)}function sleep(n){for(var i=(new Date).getTime(),t=0;t<1e7;t++)if((new Date).getTime()-i>n)break}function sendbutton(n){var t="/command?"+n;return request=new XMLHttpRequest,request.open("GET",t,!1),request.send(),request.status!=200&&alert("sendbutton ERROR! "+request.status+": "+request.statusText),sleep(1e3),0}function sendvoltage(){var n="voltage="+document.getElementById("Voltage").value;return sendbutton(n),alert("Установлено."),0}function loadDoc(){var n=new XMLHttpRequest;n.timeout=4e3;n.onreadystatechange=function(){var n,t,i;this.readyState==4&&this.status==200&&(ConnectError(!1),n=JSON.parse(this.responseText),document.getElementById("version").innerHTML=n.version,document.getElementById("crnt_tm").innerHTML=n.crnt_tm,document.getElementById("stm").innerHTML=n.stm,document.getElementById("WaterTemp").innerHTML=n.WaterTemp.toFixed(3),document.getElementById("TankTemp").innerHTML=n.TankTemp.toFixed(3),document.getElementById("ACPTemp").innerHTML=n.ACPTemp.toFixed(3),document.getElementById("bme_pressure").innerHTML=n.bme_pressure.toFixed(3),document.getElementById("start_pressure").innerHTML=n.start_pressure.toFixed(3),document.getElementById("Status").innerHTML=n.Status,document.getElementById("current_power_volt").innerHTML=n.current_power_volt.toFixed(1),document.getElementById("target_power_volt").innerHTML=n.target_power_volt.toFixed(1),document.getElementById("current_power_mode").innerHTML=n.current_power_mode,document.getElementById("current_power_p").innerHTML=n.current_power_p,document.getElementById("WFtotalMl").innerHTML=n.WFtotalMl,document.getElementById("WFflowRate").innerHTML=n.WFflowRate,document.getElementById("bme_temp").innerHTML=n.bme_temp,document.getElementById("heap").innerHTML=n.heap,document.getElementById("rssi").innerHTML=n.rssi,document.getElementById("fr_bt").innerHTML=n.fr_bt,sound_is_on=!!n.UseBBuzzer,n.Lstatus&&n.Lstatus!=""&&(document.getElementById("Lstatus").innerHTML=n.Lstatus),n.Msg&&n.Msg!==""&&addMessage(n.Msg,n.msglvl),n.LogMsg&&n.LogMsg!==""&&console.log(n.crnt_tm+"; "+n.LogMsg),document.getElementById("flowsensor").style=n.WFflowRate===undefined?"visibility: hidden; position: fixed;":"",n.PowerOn==1?(t="Выключить нагрев",i="red"):(t="Включить нагрев",i="lightgreen"),document.getElementById("power").value=t,document.getElementById("power").style.backgroundColor=i)};n.onerror=function(){ConnectError(!0)};n.ontimeout=function(){ConnectError(!0)};n.open("GET","/ajax",!0);n.send()}function run_lua(n){sendbutton("lua="+n)}var IsOffline=!1,IsOffline=!1,OfflineCouner=0,sound_is_on=!0,IsCalmingPause=!1,Messages_Array=[],sound_is_playing=!1,is_ALARM=!1,pwr_unit;const sound=new Audio("alarm.mp3");sound.loop=!0;sound.preload="auto";sound.autoplay=!1;pwr_unit="%pwr_unit%";setInterval(loadDoc,2e3);window.onload=function(){setPowerUnit();AddLuaButtons()}</script></head><body><form action=none onsubmit="return false" name=mainform id=mainform><div class=tab><input type=button class="tablinks active" onclick="openTab(event, 'Main');" value=Дистилляция /><input type=button class=tablinks onclick="openTab(event, 'Other');" value=Дополнительно /><input type=button class=tablinks onclick="openTab(event, 'Video');" value=Видео style="display: %showvideo%;" /></div><div id=Main class=tabcontent style="display: block;"><div class=container_row style="justify-content: space-between; font-size: 1em; margin-bottom: 0.5em;"><div style="display: flex; flex-direction: row; justify-content: flex-start; align-items: center; font-weight: bold"><div style="display: flex; flex-direction: column; justify-content: flex-start; align-items: center"><div>Samovar</div><span id=crnt_tm style="height: 0; visibility: hidden"></span><div style="display: flex; flex-direction: row; justify-content: flex-start; align-items: center;"><div>v.</div><div id=version></div></div></div><div style="width: 21px; display: flex; flex-direction: column; justify-content: center; align-items: center"><div id=connection_indicator><img src=Green.png style="margin: 0 !important; width: 20px" /></div></div><div class=messages_box style="display: none;" id=messagesBox><div style="position: absolute; height: 0.6em; top: 0; right: 0.5em; cursor: pointer" onclick=clearMessages()>[x] очистить</div><div class=messages_array id=messages></div></div></div><div style="display: flex; flex-direction: column; align-items: center; font-weight: bold;">Работа: <span id=stm></span></div></div><div class=container_row style="border: 1px dashed #bbb; margin-bottom: 1em;"><div class=container><div class="text column" style="color: %WaterColor%;">Т воды: <span id=WaterTemp style="font-size: xx-large;"></span>°C</div></div><div class=container><div class="text column" style="color: %TankColor%;">Т в кубе: <span id=TankTemp style="font-size: xx-large;"></span>°C</div></div></div><div class=container_row style="border: 1px dashed #bbb; margin-bottom: 1em;"><div class=container><div class=text style="color: %ACPColor%;">Т в ТСА:    <span id=ACPTemp style="font-size: xx-large;"></span> °C</div></div></div><div class=container_row style="margin-top: 1em; background-color: #7cfc0063; padding-top: 0.5em; padding-bottom: 0.5em;"><span style="padding-left: 1em; font-size: 1.5em; font-weight: bold; color: #333">Статус: <span id=Status></span></span></div><div class=container_row style="border: 1px dashed #bbb; margin-bottom: 1em; justify-content: space-between;" id=PWR><div class=container_column style="border: 1px dashed #bbb; margin-bottom: 1em;"><div class=text id=VoltH2><div class=container_row style="padding-left: 2em; justify-content: space-around; align-items:center;"><div><span id=set_power_label></span><input name=Voltage id=Voltage type=text /></div><input id=SetVoltage type=submit name=SetVoltage onclick=sendvoltage(); class=button /></div></div><div class=dvcs id=regulator style="padding-left: 0 !important; padding-right: 0 !important;"><span class=dvcs><span id=power_current></span> <span id=current_power_volt></span> <span id=power_unit_current></span></span> <span class=dvcs><span id=power_target></span> <span id=target_power_volt></span> <span id=power_unit_target></span></span> <span class=dvcs>Режим регулятора: <span id=current_power_mode></span></span> <span class=dvcs id=current_power_line>Мощность: <span id=current_power_p></span> Вт</span></div></div></div><div class=container_column style="border: 1px dashed #bbb; margin-bottom: 1em;"><div class=dvcs id=flowsensor style="visibility: hidden;position: fixed;"><span class=dvcs>Расход воды: <span id=WFtotalMl></span> мл</span> <span class=dvcs>Скорость расхода воды: <span id=WFflowRate></span> л/мин</span></div></div><div class=container_row style="border: 1px dashed #bbb; margin-bottom: 1em; justify-content: space-between;"><div class=text>Давление:   <span id=bme_pressure></span> мм рт.ст.</div><div class=text>В начале:   <span id=start_pressure></span> мм рт.ст.</div></div><div><span class=dvcs>Системные параметры: Heap=<span id=heap></span>; BME temp=<span id=bme_temp></span>; RSSI = <span id=rssi></span>; Свободно: <span id=fr_bt></span></span></div><div><input id=power type=submit name=power value="Включить нагрев" onclick=setDistCommand(); class=button /><input id=chart type=submit name=chart value=График onclick='javascript:location.href="/chart.htm"' class=button /><input id=setup type=submit name=setup value=Настройки onclick='javascript:location.href="/setup.htm"' class=button /></div></div><div id=Video class=tabcontent><img src=%videourl% /></div><div id=Other class=tabcontent><div style="visibility: hidden" id=lua_btn><div class=container_row style="border: 1px dashed #bbb; margin-bottom: 1em; justify-content: space-between;"><div class=container_column style="flex: 1.1; padding-left: 2em;"><div class=container_row style="justify-content: space-around; align-items: center;" id=lua_btn_ln></div><div class=container_row style="margin-top: 10px !important; margin-bottom: 10px !important;"><span>Статус Lua:</span><span id=Lstatus></span></div></div></div></div></div></form></body></html>