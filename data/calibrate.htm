<html>
<head>
<meta charset='utf-8'>
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" href="style.css">
<title>Самовар</title>

<script>
const stepperStepMlLocal = %StepperStepMl%;
const stepperStepMlI2C = %StepperStepMlI2C%;

function getPumpType(){
  var sel = document.getElementById('pump_type');
  if (sel && sel.style.display !== 'none') return sel.value;
  return 'local';
}

function onPumpTypeChange(){
  var t = getPumpType();
  if (t === 'i2c') {
    document.getElementById('stepperstepml').value = stepperStepMlI2C;
  } else {
    document.getElementById('stepperstepml').value = stepperStepMlLocal;
  }
}

function calibrate(){
if (document.getElementById('calibrateid').value == 'Начать калибровку'){
  document.getElementById('calibrateid').value = 'Зафиксировать 100 мл';
  command='stpstep=' + document.getElementById('kstepperspd').value + '&pump=' + getPumpType() + '&start';
} else {
  document.getElementById('calibrateid').value = 'Начать калибровку';
  command='pump=' + getPumpType() + '&finish';
}
var server = '/calibrate?' + command + '=1';
request = new XMLHttpRequest();
request.onreadystatechange = function() {
if (this.readyState == 4 && this.status == 200) {
var myObj = this.responseText;
if (myObj != "OK") document.getElementById('stepperstepml').value = myObj;
}
};
request.open('GET', server, false);
request.send();
if(request.status != 200) {
alert( request.status + ': ' + request.statusText );
}
return 0;
};

window.onload = function() {
  onPumpTypeChange();
};
</script>
</head>

<body>
<form action='/save' method="post" name="setupform">
<h1>Калибровка шагового двигателя</h1>
<div class="tabcontent" style="display: block;border-top: solid;border-top-width: 1px;border-top-color: rgb(204, 204, 204);">
<h2>Насос: 
  <select id='pump_type' onchange='onPumpTypeChange();' style="display: %I2CPumpTab%;">
    <option value="local" selected>Встроенный</option>
    <option value="i2c">Внешний (I2C)</option>
  </select>
  <span style="display: %I2CPumpTab%;">(I2C)</span>
</h2>
<h2>Объем жидкости : <span id='start_pressure'>100</span> мл.</h2>
<h2>Скорость шагового двигателя : <input id='kstepperspd' name='kstepperspd' type='text' value='%StepperStep%' style="width: 6em;"> шагов/сек.</h2>
<h2>Шагов на 100 мл: <input id='stepperstepml' name='stepperstepml' type='text' value='%StepperStepMl%' style="width: 6em;"></h2>
<input id='calibrateid' type='button' name='calibratenm' value='Начать калибровку' onclick='calibrate();' class="button">
<input id='return' type='button' name='return' value='К настройкам' onclick='javascript:location.href="/setup.htm"' class="button">
</div>
</form>
</body>
</html>
