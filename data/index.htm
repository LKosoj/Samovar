<head>
<meta charset='utf-8'>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<title>Самовар</title>

<style>#file-input,input{width:200;height:34px;border-radius:4px;margin:10 10 0 10;font-size:15px}
input{background:#f1f1f1;border:0;padding:0 15px;}
input[type='text']{background:#f1f1f1;border:0;padding:0 15px;width:80;margin:0}
#file-input{padding:0;border:1px solid #ddd;line-height:44px;text-align:left;display:block;cursor:pointer}
body{background:#3498db;font-family:sans-serif;font-size:12px;color:#777}
#bar,#prgbar{background-color:#f1f1f1;border-radius:10px}#bar{background-color:#3498db;width:0;height:10px}
form{background:#fff;max-width:800px;margin:25px auto;padding:30px;border-radius:5px;text-align:left}
h1{text-align:center}
.btn{background:#3498db;color:#fff;cursor:pointer}
.dvcs{padding: 10px;margin: 10px;}

.message-box {
	width: fit-content;
	margin: auto;
	padding: 10px;
	margin-bottom: 10px;
	background-color: #ffcccc;
	font: 400 16px 'Open Sans', sans-serif;
	border: 1px solid #dfd087;
	border-radius: 10px;    
    transition: all 0.8s ease-in-out;
}
</style>

<script>
function sendbutton(command){
var server = '/command?' + command;
request = new XMLHttpRequest();
request.open('GET', server, false);
request.send();
if(request.status != 200) {
alert( request.status + ': ' + request.statusText );
}
return 0;
};

function sendvoltage(){
var command = 'voltage=' + document.getElementById('Voltage').value;
sendbutton(command);
return 0;
};

setInterval(loadDoc,2000);
setInterval(loadHeap,19000);

function loadHeap() {
var xhttp = new XMLHttpRequest();
xhttp.onreadystatechange = function() {
if (this.readyState == 4 && this.status == 200) {
var myObj = this.responseText;
document.getElementById('Heap').innerHTML = myObj;
}
};
xhttp.open("GET", "/heap", true);
xhttp.send();
};


function loadDoc() {
var xhttp = new XMLHttpRequest();
xhttp.onreadystatechange = function() {
if (this.readyState == 4 && this.status == 200) {
var myObj = JSON.parse(this.responseText);
document.getElementById('version').innerHTML = myObj.version;
document.getElementById('crnt_tm').innerHTML = myObj.crnt_tm;
document.getElementById('stm').innerHTML = myObj.stm;
document.getElementById('SteamTemp').innerHTML = myObj.SteamTemp;
document.getElementById('PipeTemp').innerHTML = myObj.PipeTemp;
document.getElementById('WaterTemp').innerHTML = myObj.WaterTemp;
document.getElementById('TankTemp').innerHTML = myObj.TankTemp;
document.getElementById('bme_pressure').innerHTML = myObj.bme_pressure;
document.getElementById('start_pressure').innerHTML = myObj.start_pressure;
document.getElementById('VolumeAll').innerHTML = myObj.VolumeAll;
document.getElementById('ActualVolumePerHour').innerHTML = myObj.ActualVolumePerHour;
document.getElementById('WthdrwlProgress').innerHTML = myObj.WthdrwlProgress;
document.getElementById('CurrrentSpeed').innerHTML = myObj.CurrrentSpeed;
document.getElementById('CurrrentStepps').innerHTML = myObj.CurrrentStepps;
document.getElementById('TargetStepps').innerHTML = myObj.TargetStepps;
document.getElementById('Status').innerHTML = myObj.Status;
document.getElementById('current_power_volt').innerHTML = myObj.current_power_volt;
document.getElementById('target_power_volt').innerHTML = myObj.target_power_volt;
document.getElementById('current_power_mode').innerHTML = myObj.current_power_mode;
document.getElementById('current_power_p').innerHTML = myObj.current_power_p;
document.getElementById('WFtotalMl').innerHTML = myObj.WFtotalMl;
document.getElementById('WFflowRate').innerHTML = myObj.WFflowRate;
document.getElementById('DeltaTemp').innerHTML = myObj.PipeTemp - myObj.SteamTemp;
if (myObj.Msg){
  if (myObj.Msg != "") {
    showMessage(myObj.Msg);
  }
}

if (!myObj.current_power_volt){
  document.getElementById('regulator').style = 'visibility: hidden;position: fixed;';
  document.getElementById('VoltH2').style = 'visibility: hidden;position: fixed;';
} else {
  document.getElementById('regulator').style = '';
  document.getElementById('VoltH2').style = '';
}

if (!myObj.WFflowRate){
  document.getElementById('flowsensor').style = 'visibility: hidden;position: fixed;';
} else {
  document.getElementById('flowsensor').style = '';
}

var powerstr;
var powerstyle;
if (myObj.PowerOn == 1){
  powerstr = 'Выключить питание';
  powerstyle='red';
} else {
  powerstr = 'Включить питание';
  powerstyle='lightgreen';
}
document.getElementById('power').value = powerstr;
document.getElementById('power').style.backgroundColor = powerstyle;

var pausestr;
var pausestyle;
if (myObj.PauseOn == 1){
  pausestr = 'Продолжить';
  pausestyle='lightgreen';
} else {
  pausestr = 'Поставить на паузу';
  pausestyle='#3498db';
}
document.getElementById('pause').value = pausestr;
document.getElementById('pause').style.backgroundColor = pausestyle;
  
}
};
xhttp.open("GET", "/ajax", true);
xhttp.send();
};

function showMessage(Msg){
    document.getElementById('message').innerHTML = Msg;
    document.getElementById('message').style.display = 'block';
   
setTimeout(function(){
	document.getElementById('message').style.display = 'none';
}, 20000);
}
</script>
</head>

<form action='none' onsubmit='return false'>
<h1>Samovar v. <span id='version'></span></h1>
<div class="message-box" style="display: none;" id="message"></div>
<h2>Текущее время: <span id='crnt_tm'></span></h2>
<h2>Время работы Samovar: <span id='stm'></span></h2>
<h2 style="color: blue;">Температура пара перед дефлегматором: <span id='SteamTemp'></span>&#176C</h2>
<h2 style="color: darkmagenta;">Температура пара в царге на 2/3 колонны: <span id='PipeTemp'></span>&#176C</h2>
<h2 style="color: black;">Дельта температур: <span id='DeltaTemp'></span>&#176C</h2>
<h2 style="color: cornflowerblue;">Температура флегмы или воды: <span id='WaterTemp'></span>&#176C</h2>
<h2 style="color: crimson;">Температура в кубе: <span id='TankTemp'></span>&#176C</h2>
<h2>Атмосферное давление в начале работы: <span id='start_pressure'></span> мм рт. ст.</h2>
<h2>Текущее атмосферное давление: <span id='bme_pressure'></span> мм рт. ст.</h2>
<h2>Отобранный объем: <span id='VolumeAll'></span> мл</h2>
<h2>Скорость отбора: <span id='ActualVolumePerHour'></span> л/ч</h2>
<h2>Скорость шагового двигателя: <span id='CurrrentSpeed'></span> шагов/сек</h2>
<h2>Прогресс отбора: <span id='WthdrwlProgress'></span>%</h2>
<h2>Питание включено: <span id='PowerOn'></span></h2>
<h2 id='VoltH2' style='visibility: hidden;position: fixed;'>Напряжение регулятора: <input name='Voltage' id='Voltage' type='text' value=''>
<input id='SetVoltage' type='submit' name='SetVoltage' value='Установить напряжение' onclick='sendvoltage();'>
</h2>
<div class='dvcs' id='regulator' style='visibility: hidden;position: fixed;'>
<span class='dvcs'>Текущее напряжение: <span id='current_power_volt'></span> V</span>
<span class='dvcs'>Целевое напряжение: <span id='target_power_volt'></span> V</span>
<span class='dvcs'>Режим регулятора: <span id='current_power_mode'></span></span>
<span class='dvcs'>Мощность: <span id='current_power_p'></span></span>
</div>
<input id='power' type='submit' name='power' value='Включить питание' onclick='sendbutton("power=1");'>
<input id='start' type='submit' name='start' value='Начать отбор' onclick='sendbutton("start=1");'>
<input id='pause' type='submit' name='pause' value='Пауза' onclick='sendbutton("pause=1");'>
<input id='reset' type='submit' name='reset' value='Сбросить процесс' onclick='sendbutton("reset=1");'>
<input id='chart' type='submit' name='chart' value='График' onclick='javascript:location.href="/chart.htm"'>
<input id='setup' type='submit' name='setup' value='Настройки' onclick='javascript:location.href="/setup.htm"'>
<div class='dvcs'>
<span class='dvcs'>Статус работы: <span id='Status'></span></span>
</div>
<div>
<div class='dvcs'>
<span class='dvcs'>Текущие шаги: <span id='CurrrentStepps'></span></span>
<span class='dvcs'>Целевое шагов: <span id='TargetStepps'></span></span>
<div>
<span class='dvcs'>Системные параметры: <span id='Heap'></span></span>
</div></div>
<div class='dvcs' id='flowsensor' style='visibility: hidden;position: fixed;'>
<span class='dvcs'>Расход воды: <span id='WFtotalMl'></span> мл</span>
<span class='dvcs'>Скорость расхода воды: <span id='WFflowRate'></span> л/мин</span>
</div>
</form>