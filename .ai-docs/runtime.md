# Запуск и окружение

```markdown
# Запуск и окружение

## Требования к окружению

### Аппаратные требования
- **Микроконтроллер**: ESP32 (рекомендуется WROOM или WROVER).
- **Память**: минимум 4 МБ Flash, 520 КБ RAM.
- **Интерфейсы**: Wi-Fi 2.4 ГГц, UART, I2C, OneWire, ШИМ.
- **Периферия**:
  - Датчики температуры: DS18B20 (1-Wire).
  - Датчики давления: BMP280/BME280, MPX5010D, XGZP6897D.
  - Исполнительные устройства: реле, шаговый двигатель, сервопривод, насос.
  - Дисплей: I2C LCD (16x2, 20x4) или OLED.
  - Кнопки, энкодер, зуммер.

### Программные требования
- **Среда разработки**: PlatformIO (рекомендуется) или Arduino IDE.
- **Фреймворк**: Arduino для ESP32.
- **Библиотеки** (указаны в `platformio.ini`):
  - `ESPAsyncWebServer`, `AsyncTCP`
  - `ArduinoJson`
  - `DallasTemperature`, `OneWire`
  - `LiquidCrystal_I2C`
  - `GyverPID`
  - `LittleFS`
  - `ESPmDNS`

## Сборка и прошивка

### PlatformIO
1. Установите [PlatformIO IDE](https://platformio.org/install).
2. Откройте проект в VS Code.
3. Убедитесь, что `platformio.ini` содержит:
   ```ini
   [env:doit-devkit-v1]
   platform = espressif32
   board = doit-devkit-v1
   framework = arduino
   ```
4. Выполните сборку и загрузку:
   ```bash
   pio run -t upload
   ```

### Arduino IDE
1. Установите ESP32 в Менеджере плат.
2. Откройте скетч `Samovar.ino`.
3. Выберите плату: **ESP32 Dev Module**.
4. Загрузите прошивку.

## Конфигурация платы

Выбор платы осуществляется в `samovar_pin.h`:
- `ESP32S3` — для плат с полной периферией.
- `LILYGO T-RELAY` — для T-RELAY 4.
- `ESP32 DEVKIT` — базовая конфигурация.

Если плата не определяется автоматически, задайте вручную:
```cpp
#define BOARD ESP32S3
```

## Файловая система (LittleFS)

1. Соберите веб-интерфейс и скрипты.
2. Загрузите файлы в LittleFS:
   ```bash
   pio run -t uploadfs
   ```
   Или в Arduino IDE: **Инструменты → Загрузить файловую систему**.

Обязательные файлы:
- `/index.htm` — веб-интерфейс.
- `/init.lua` — стартовый Lua-скрипт.
- `/.exclude.files` — маски скрытых файлов.

## Настройка Wi-Fi

При первом запуске устройство создаёт точку доступа `Samovar-XXXX` (пароль `12345678`). Подключитесь и откройте `http://192.168.4.1`.

Настройте:
- Сеть Wi-Fi (SSID/пароль).
- Имя устройства (`SAMOVAR_HOST`).
- Часовой пояс (`TimeZone`).

## Запуск системы

1. Подайте питание.
2. Устройство:
   - Инициализирует датчики.
   - Подключится к Wi-Fi.
   - Запустит веб-сервер (порт 80).
   - Загрузит `init.lua` (если `USE_LUA`).
3. Доступ к интерфейсу: `http://samovar.local` или по IP.

## Отладка

### Последовательный порт
- Скорость: 115200 бод.
- Используйте монитор порта для просмотра логов.

### Условная компиляция
Для включения отладки добавьте в `platformio.ini`:
```ini
build_flags = -D__SAMOVAR_DEBUG
```

### GDB-отладка
1. Подключите JTAG (например, ESP-Prog).
2. Запустите OpenOCD:
   ```bash
   openocd -f board/esp32-wrover-kit-3.3v.cfg
   ```
3. Подключитесь через GDB:
   ```bash
   xtensa-esp32-elf-gdb .pio/build/doit-devkit-v1/firmware.elf
   ```

## Обновление прошивки (OTA)

1. В веб-интерфейсе перейдите в **Настройки → Обновление**.
2. Загрузите `.bin`-файл прошивки.
3. Или используйте `platformio.ini`:
   ```ini
   upload_protocol = espota
   upload_port = 192.168.1.100
   ```

## Восстановление после сбоя

Если устройство не запускается:
1. Удерживайте кнопку **ALARM_BTN** при включении.
2. Система сбросит настройки и перейдёт в режим AP.
3. Перенастройте через веб-интерфейс.
```
