# Архитектура

```mermaid
graph TD
    subgraph "Устройство: Самовар"
        A[ESP32] --> B[Датчики]
        A --> C[Исполнительные устройства]
        A --> D[Пользовательский интерфейс]
    end

    subgraph "Датчики"
        B --> B1[TankSensor]
        B --> B2[WaterSensor]
        B --> B3[SteamSensor]
        B --> B4[PipeSensor]
        B --> B5[ACPSensor]
        B --> B6[WF Датчик потока]
        B --> B7[Датчик давления]
    end

    subgraph "Исполнительные устройства"
        C --> C1[Нагрев (SSR/Реле)]
        C --> C2[Насос охлаждения]
        C --> C3[Клапан подачи воды]
        C --> C4[Шаговый двигатель (насос отбора)]
        C --> C5[Зуммер]
    end

    subgraph "Пользовательский интерфейс"
        D --> D1[LCD + Энкодер]
        D --> D2[Веб-интерфейс]
        D --> D3[Мобильные приложения (Blynk, Telegram)]
    end

    A --> E[Логика управления]
    E --> E1[distiller_proc]
    E --> E2[run_dist_program]
    E --> E3[check_alarm_distiller]
    E --> E4[process_impurity_detector]
    E --> E5[timePredictor]

    E1 --> E2
    E2 --> E3
    E3 --> C1
    E3 --> C2
    E3 --> C3
    E3 --> C5

    B --> E
    E --> C

    A --> F[Связь и интеграция]
    F --> F1[Wi-Fi]
    F --> F2[MQTT]
    F --> F3[HTTP API]
    F --> F4[OTA-обновления]

    F1 --> D2
    F1 --> F2
    F1 --> F3
    F2 --> D3
    F3 --> D2

    A --> G[Хранение данных]
    G --> G1[NVS (настройки)]
    G --> G2[SPIFFS/LittleFS (логи, скрипты, веб-интерфейс)]
    G1 --> E
    G2 --> D2
    G2 --> E4

    A --> H[Расширяемость]
    H --> H1[Samovar_Lua.h]
    H1 --> H2[Lua-скрипты]
    H2 --> E
    H2 --> C
    H2 --> D2
```

### Архитектура

Архитектура системы "Самовар" построена вокруг микроконтроллера ESP32 и представляет собой модульную, многоуровневую систему автоматизации дистилляции и смежных процессов.

**Центральное ядро** — микроконтроллер ESP32, выполняющий роль центрального процессора. Он объединяет все компоненты системы, обеспечивая синхронную работу логики, датчиков, исполнительных устройств и интерфейсов.

**Слой датчиков** обеспечивает сбор данных о состоянии процесса. Ключевые параметры — температура в различных точках (куб, пар, царга, охлаждение), давление, расход воды и уровень жидкости. Данные поступают в ядро по шинам 1-Wire (DS18B20) и I2C (BME, XGZP6897D), где обрабатываются и корректируются (например, температура кипения по давлению).

**Слой исполнительных устройств** реализует физическое воздействие на процесс. Управление осуществляется через реле, ШИМ и шаговые драйверы. Ключевые функции: регулирование мощности нагрева, подача охлаждающей воды, отбор дистиллята и аварийная сигнализация.

**Слой логики управления** — ядро автоматизации. Основная функция `distiller_proc` инициирует процесс, запуская программу отбора (`run_dist_program`). Логика включает:
- Управление по температуре и спиртуозности.
- Динамическую коррекцию скорости отбора.
- Детекцию примесей по тренду температуры пара.
- Прогноз времени завершения на основе `timePredictor`.
- Обработку аварийных ситуаций (`check_alarm_distiller`).

**Слой хранения данных** использует NVS для хранения настроек и SPIFFS/LittleFS для логов, веб-интерфейса и Lua-скриптов. Это обеспечивает сохранность конфигурации и возможность автономной работы.

**Слой связи и интеграции** обеспечивает удаленное управление и мониторинг. Через Wi-Fi реализованы:
- Веб-интерфейс с графиками и настройками.
- MQTT для интеграции с IoT-платформами.
- HTTP API для внешних вызовов.
- OTA-обновления прошивки.

**Слой расширяемости** реализован через встроенный интерпретатор Lua (`Samovar_Lua.h`). Пользовательские скрипты позволяют реализовывать сложную, адаптивную логику без перекомпиляции прошивки, обеспечивая высокую гибкость системы.

Архитектура обеспечивает надежность, гибкость и безопасность, позволяя управлять сложными технологическими процессами с высокой степенью автоматизации.
