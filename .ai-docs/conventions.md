# Соглашения

```markdown
# Соглашения

## Общие принципы
- **Модульность**: Каждый файл решает одну задачу (управление, датчик, интерфейс).
- **Условная компиляция**: Функционал включается/отключается через `#define` (например, `USE_MQTT`, `USE_WATER_PUMP`).
- **Глобальные переменные**: Именуются с префиксом типа (`SteamSensor`, `Samovar_Mode`) или в `snake_case` (`wp_count`).
- **Константы**: `UPPER_SNAKE_CASE` (например, `MAX_WATER_TEMP`, `PREDICTOR_UPDATE_MS`).
- **Семафоры**: Используются для синхронизации доступа к ресурсам (I2C, EEPROM) в FreeRTOS.

## Именование
- **Функции**: `snake_case` (например, `set_pump_speed_pid`, `get_alcohol`).
- **Классы/структуры**: `PascalCase` (например, `TimePredictor`, `QualityParams`).
- **Переменные экземпляров**: `camelCase` (например, `timePredictor`, `impurityDetector`).
- **Макросы**: `UPPER_SNAKE_CASE` (например, `USE_LUA`, `STEPPER_MAX_SPEED`).

## Управление ресурсами
- **I2C**: Доступ защищён семафором `xI2CSemaphore`.
- **EEPROM**: Запись только при изменении значений, с буферизацией.
- **Файловая система**: Используется LittleFS, файлы кэшируются при чтении.
- **Память**: Строки формируются в статических буферах (`Msg`, `jsonstr`), длина контролируется.

## Обработка ошибок
- **Датчики**: При сбое возвращают `DEVICE_DISCONNECTED`, логируется ошибка.
- **Аварии**: Фиксируются в `alarm_event`, вызывается `check_alarm_*`, отключается нагрев.
- **Сетевые операции**: Используются таймауты, повторные попытки (MQTT, HTTP).
- **Сбои**: При `USE_CRASH_HANDLER` стектрейс сохраняется в файл.

## Логирование и отладка
- **Уровни**: `SendMsg(type, text)` с типами `NOTIFY_MSG`, `WARNING_MSG`, `ERROR_MSG`.
- **Отладка**: Активируется через `__SAMOVAR_DEBUG`, вывод в `Serial`.
- **Статистика**: Собирается в `create_data()`, сохраняется в `data.csv`.

## Конфигурация
- **Аппаратная часть**: Настройка в `samovar_pin.h` по типу платы.
- **Параметры процесса**: Задаются в `samovar_i.h` (температуры, режимы, пороги).
- **EEPROM**: Хранит калибровки, уставки, адреса датчиков.
- **Версионирование**: `SAMOVAR_VERSION` в `Samovar.h`.

## Кодировка и формат
- **Кодировка**: UTF-8.
- **Отступы**: 2 пробела.
- **Символы**: Кастомные символы (градус) определяются как `uint8_t` массив.
- **Бинарные данные**: Хранятся в PROGMEM, сжимаются (GZIP) для экономии памяти.
```
