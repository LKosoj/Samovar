# Соглашения

## Именование переменных и функций

*   **Переменные и функции C/C++**: Используется `snake_case` (например, `distiller_proc`, `SamSetup`, `get_alcohol`).
*   **Переменные Lua**: Используется `snake_case` (например, `set_power`, `get_timer`).
*   **Константы и макросы**: Используется `UPPER_CASE` с подчёркиванием (например, `MAX_WATER_TEMP`, `USE_MQTT`, `STEPPER_STEP_ML`).
*   **Структуры и классы**: Используется `PascalCase` (например, `QualityParams`, `LuaWrapper`).

## Форматирование кода

*   **Отступы**: Используются 4 пробела вместо табуляции.
*   **Длина строки**: Максимальная длина строки — 120 символов.
*   **Скобки**: Открывающая фигурная скобка `{` располагается на той же строке, что и оператор (например, `if (condition) {`).
*   **Пробелы**: Используются вокруг операторов (например, `a = b + c;`), после запятых в списках и перед открывающими скобками вызова функций.

## Структура файлов

*   **Заголовочные файлы (`.h`)**: Содержат объявления функций, структур, классов и макросов. Включают защиту от двойного включения с помощью `#pragma once`.
*   **Файлы реализации (`.cpp`)**: Содержат определения функций и методов. Включают соответствующий заголовочный файл в первую очередь.
*   **Конфигурационные файлы (`.h`)**: Содержат настройки, специфичные для аппаратной платы (`samovar_pin.h`) или программной логики (`samovar_i.h`).

## Работа с памятью и ресурсами

*   **SPIFFS/LittleFS**: Файлы с расширением `.gz` (например, `edit.htm.gz`) используются для сжатых ресурсов веб-интерфейса. При работе с файлами необходимо проверять их наличие и размер.
*   **NVS (Preferences)**: Используется для долговременного хранения настроек. При первом запуске выполняется миграция данных из EEPROM в NVS.
*   **Динамическая память**: Использование `malloc`/`free` или `new`/`delete` минимизируется. При необходимости выделения памяти, необходимо проверять возвращаемое значение на `nullptr`.

## Обработка ошибок и отладка

*   **Коды возврата**: Функции, которые могут завершиться с ошибкой, возвращают `bool` (`true` — успех, `false` — ошибка) или специальное значение (например, `0xFF`).
*   **Отладочный вывод**: Используется макрос `__SAMOVAR_DEBUG` для включения/отключения отладочных сообщений. В релизной версии отладочный вывод должен быть отключён.
*   **Обработчик сбоев**: При включении `USE_CRASH_HANDLER` система автоматически сохраняет стектрейс сбоя в файл `/crash.txt` на SPIFFS для последующего анализа.

## Работа с датчиками

*   **Адресация 1-Wire**: Адреса датчиков DS18B20 хранятся как массив из 8 байт. Для копирования адресов используется функция `CopyDSAddress`.
*   **Калибровка**: Все датчики, требующие калибровки (например, шаговый двигатель, датчик потока воды), имеют соответствующие параметры в структуре `SamSetup` (например, `StepperStepMl`, `WF_CALIBRATION`).

## Работа с интерфейсами

*   **I2C**: Для обеспечения потокобезопасности доступа к шине I2C используется семафор `xI2CSemaphore`.
*   **UART**: При работе с UART (например, для RMVK) используется отдельная задача FreeRTOS (`rmvkFn`) и семафор для синхронизации доступа.
*   **GPIO**: Использование пинов должно быть согласовано с конфигурацией в `samovar_pin.h`. Для пинов, используемых в нескольких задачах, необходимо использовать синхронизацию.
