# Документация проекта

```markdown
# Документация проекта

## Общее описание
Проект "Самовар" — это система автоматизации технологических процессов (дистилляция, ректификация, пивоварение, НБК) на базе ESP32. Архитектура построена на модульности, условной компиляции и поддержке скриптовой логики (Lua), что обеспечивает гибкость под разные аппаратные конфигурации и технологические сценарии.

## Структура проекта

### Основные модули
| Файл | Назначение |
|------|-----------|
| `Samovar.h` | Центральный конфигурационный файл. Инициализация датчиков, управление питанием, PID, интерфейсы (MQTT, Blynk, Telegram), настройки EEPROM. |
| `Samovar_Lua.h` | Интеграция Lua-скриптов. Выполнение пользовательской логики, доступ к датчикам и исполнительным устройствам. |
| `samovar_s_i.h` | Инициализация датчиков (DS18B20, BME680, XGZP6897D), настройка периферии (шаговый двигатель, насос), синхронизация через семафоры. |
| `samovar_pin.h` | Распиновка плат (ESP32S3, LILYGO T-RELAY, DEVKIT). Автоопределение платы, настройка пинов для энкодера, реле, LCD, UART. |
| `samovar_i.h` | Алгоритмические параметры: температурные пороги, режимы работы, включение модулей (PID, Lua, MQTT, Blynk). |

### Процессные модули
| Модуль | Функционал |
|-------|----------|
| Дистилляция (`distiller_proc`) | Контроль температуры, спиртуозности, управление отбором по программе, прогнозирование времени, аварийная защита. |
| Ректификация | Управление отбором по фракциям (H/B/T/C), детекция примесей по тренду температуры, смачивание насадки, коррекция мощности. |
| Пивоварение (`beer_proc`) | Выполнение программы (засыпь, паузы, кипячение), детекция кипения по стабильности температуры, дозирование хмеля шаговым двигателем. |
| НБК (`nbk_proc`) | Автоматическая оптимизация мощности и подачи, контроль захлёба по давлению, сбор статистики, работа в режиме непрерывного отбора. |
| Бражная колонна (`bk_proc`) | Контроль нагрева, охлаждения, открытие клапана при достижении температуры, защита от перегрева и отсутствия воды. |

### Системные компоненты
| Компонент | Описание |
|---------|--------|
| `CrashHandler.h` | Сохранение стектрейса при сбое, анализ причины перезагрузки, восстановление логов. Активируется через `USE_CRASH_HANDLER`. |
| `SPIFFSEditor.h` | Веб-редактор файлов в SPIFFS. Поддержка загрузки, редактирования, удаления. Скрытие файлов по маскам из `/.exclude.files`. |
| `rmvk_uart.h` | Управление РМВ-К через UART: установка напряжения, включение/выключение, чтение состояния. |
| `I2CStepper.h` | Управление шаговым двигателем и реле через I2C. Поддержка скорости, направления, целевой позиции. |

## Условная компиляция
Ключевые макросы для настройки функционала:
```cpp
// Интерфейсы
#define USE_MQTT
#define SAMOVAR_USE_BLYNK
#define USE_TELEGRAM
#define USE_LUA

// Датчики
#define USE_BME680
#define USE_PRESSURE_XGZ
#define USE_WATERSENSOR

// Управление
#define SAMOVAR_USE_POWER      // Регулирование мощности (KVIC/RMVK)
#define USE_WATER_PUMP         // PID-управление насосом охлаждения
#define USE_WATER_VALVE        // Управление клапаном подачи воды
```

## Работа с датчиками
- **Температура**: DS18B20 (OneWire), коррекция через `Delta*Temp`.
- **Давление**: BME680, XGZP6897D, MPX5010D. Пересчёт в мм рт.ст.
- **Поток воды**: импульсный датчик, калибровка `WF_CALIBRATION`.
- **Уровень**: цифровые датчики (фото/капилляр), задержка срабатывания `WHLS_ALARM_TIME`.

## Управление оборудованием
| Устройство | Метод управления |
|----------|----------------|
| Нагрев | Реле или ШИМ (KVIC/RMVK), PID-регулирование |
| Насос охлаждения | Реле, ШИМ (`set_pump_pwm`), PID (`set_pump_speed_pid`) |
| Отбор | Шаговый двигатель (`stepper`), сервопривод (`SERVO_PIN`) |
| Клапан | Реле или шаговый двигатель |

## Безопасность
- **Температурная защита**: отключение нагрева при превышении `MAX_*_TEMP`.
- **Контроль воды**: останов при отсутствии потока (`WFAlarmCount`).
- **Давление**: открытие клапана при `MAX_ACP_TEMP` или `OPEN_VALVE_TANK_TEMP`.
- **Аварийная кнопка**: останов системы при срабатывании.

## Интеграции
- **MQTT**: публикация статуса в топик `SMV/<blynkauth>/<chart>/<version>`, QoS=2.
- **Blynk/Telegram**: уведомления о событиях (начало, завершение, авария).
- **Веб-интерфейс**: AsyncWebServer, WebSocket, логирование в JSON.

## Сборка и отладка
- **PlatformIO**: `platformio.ini` с настройками ESP32, LittleFS, OTA.
- **Отладка**: GDB + OpenOCD, конфигурация `esp32-wrover-kit-3.3v.cfg`, останов в `setup()`.

## Версия ПО
Текущая версия: `6.27.1`. Обновления включают исправления ошибок, улучшения стабильности и незначительные функциональные доработки.
```
