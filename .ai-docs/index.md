# Документация проекта

## Общее описание
Проект "Самовар" — это универсальная система автоматизации технологических процессов (дистилляция, ректификация, пивоварение) на базе ESP32. Архитектура построена вокруг модульного ядра, обеспечивающего точное управление нагревом, отбором, охлаждением и безопасностью. Ключевая особенность — поддержка скриптовой логики (Lua), что позволяет реализовывать сложные адаптивные алгоритмы без перекомпиляции прошивки.

## Основные компоненты

### Ядро системы
- **`distiller_proc()`**: Инициирует цикл дистилляции: включает нагрев, создает сессию, запускает программу.
- **`run_dist_program()`**: Выполняет и контролирует переходы между этапами программы.
- **`distiller_finish()`**: Корректно завершает процесс: отключает нагрев, отправляет уведомления.
- **`check_alarm_distiller()`**: Мониторит аварийные состояния (перегрев, сухой ход, отказ насоса).

### Управление оборудованием
- **Нагрев**: Регулируется через `set_power()` и `set_power_mode()`. Поддерживается управление напряжением (`target_power_volt`) и интеграция с внешними регуляторами (RMVK, SEM_AVR).
- **Насос охлаждения**: Управление по ШИМ (`set_pump_pwm`) или ПИД-регулированию (`set_pump_speed_pid`).
- **Клапан**: Открывается/закрывается по температуре (`open_valve()`), с гистерезисом `DELTA_T_CLOSE_VALVE`.
- **Шаговый двигатель**: Точный контроль отбора (`set_stepper_target()`, `set_stepper_by_time()`).

### Датчики и мониторинг
- **Температура**: DS18B20 (OneWire), BME280/BMP280 (I2C). Коррекция кипения по давлению включается флагом `UsePreccureCorrect`.
- **Давление**: XGZP6897D (I2C), MPX5010D (аналоговый).
- **Расход воды**: Импульсный датчик (WF), калибровка `WF_CALIBRATION`.
- **Уровень флегмы**: Капацитивный датчик (`USE_HEAD_LEVEL_SENSOR`).

### Безопасность
- **Аварийные отключения** при:
  - Перегреве: `MAX_WATER_TEMP`, `MAX_ACP_TEMP`, `MAX_STEAM_TEMP`.
  - Отсутствии воды: `WFAlarmCount` превышено.
  - Захлёбе: `whls.isHolded()`.
- **Самодиагностика**: Проверка связи с регулятором мощности, датчиков.

## Программная логика

### Условия завершения дистилляции
Процесс останавливается при выполнении одного из условий:
1. Температура куба достигла `DistTemp`.
2. Спиртуозность пара упала ниже заданного порога.
3. Температура стабильна >90°C в течение `DistTimeF` минут.

### Детектор примесей
- **Алгоритм**: Анализирует тренд температуры пара (`calculate_temperature_trend()`).
- **Реакции**:
  - **Коррекция**: Снижение скорости насоса до 70%.
  - **Пауза**: Остановка отбора, звуковое оповещение.
- **Адаптация**: Порог срабатывания корректируется по дисперсии температуры и фазе процесса.

### Прогноз времени
- **`timePredictor`**: Динамически рассчитывает оставшееся и общее время.
- **Обновление**: Каждые 30 сек (`PREDICTOR_UPDATE_MS`).
- **Факторы**: Скорость изменения температуры (`MIN_TEMP_RATE`), спиртуозности (`MIN_ALC_RATE`).

## Интеграции и интерфейсы

### Веб-интерфейс
- **Сервер**: `AsyncWebServer` с поддержкой gzip и кэширования.
- **Функции**:
  - Мониторинг в реальном времени.
  - Управление: нагрев, насосы, программы.
  - Редактор SPIFFS (`/edit`).
  - Настройка Wi-Fi (`/wifi.htm`).
- **Данные**: Обновляются каждые 2 сек через `/ajax`.

### Удалённое управление
- **Blynk**: Управление по виртуальным пинам (V16 — мощность, V17 — скорость насоса).
- **MQTT**: Публикация данных в топик `SMV/<blynkauth>/#`.
- **Telegram**: Отправка уведомлений при старте/остановке.

### Lua-скрипты
- **Интерпретатор**: `LuaWrapper` в задаче FreeRTOS.
- **Доступные функции**:
  - Управление GPIO: `pinMode()`, `digitalWrite()`.
  - Оборудование: `set_power()`, `open_valve()`, `set_stepper_target()`.
  - Датчики: `get_temp_by_pressure()`, `get_alcohol()`.
  - Связь: `SendMsg()`, `http_request()`.
- **Загрузка**: `init.lua` из SPIFFS, режимные скрипты (`get_lua_mode_name()`).

## Хранение данных
- **Настройки**: Сохраняются в NVS (Preferences) с миграцией из EEPROM.
- **Логи**: Запись в `data.csv` (контроль памяти, резервное копирование).
- **Профили**: Бинарные файлы `.prf` в SPIFFS для разных режимов.

## Сборка и отладка
- **Среда**: PlatformIO, ESP32.
- **Конфигурация**: `platformio.ini` с кастомными разделами (`samovar.csv`).
- **Отладка**:
  - Обработчик сбоев (`USE_CRASH_HANDLER`) сохраняет стектрейс в `/crash.txt`.
  - Мониторинг стека задач (`get_task_stack_usage()`).
  - Отключение Bluetooth для экономии памяти.
