# beer

Модуль реализует логику управления самоваром для пивоварения, включая контроль температуры, управление нагревателем по ПИД-регулятору, обработку программ затирания, контроль кипения, взаимодействие с периферией (насос, клапаны, мешалка, шаговый двигатель) и обмен данными через MQTT. Поддерживает сохранение профилей, автотюнинг ПИД, обработку ошибок питания и отправку уведомлений. Основное состояние процесса управляется через программу затирания с переходами между этапами.

Ключевые структуры данных  
BoilingDetector — Структура для детектирования начала кипения на основе анализа истории температур

---
void read_config()  
Прочитать конфигурацию устройства из энергонезависимой памяти.  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет

---
String getValue(const String& data, char separator, int index)  
Получить подстроку по индексу из строки, разделённой заданным символом.  
Аргументы  
data — Входная строка  
separator — Разделительный символ  
index — Индекс требуемой части  
Возвращает  
Значение как строка; пустая строка, если индекс вне диапазона  
Исключения  
Нет

---
void startService(void)  
Запустить фоновые сервисные задачи, например, управление шаговым двигателем.  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет

---
void stopService(void)  
Остановить все запущенные сервисные задачи.  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет

---
void set_power_mode(String Mode)  
Установить режим питания устройства (например, "eco", "normal", "boost").  
Аргументы  
Mode — Строка, задающая режим питания  
Возвращает  
Нет  
Исключения  
Нет

---
void check_power_error()  
Проверить наличие ошибок в цепи питания и выполнить соответствующие действия (например, отключение).  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет

---
void set_current_power(float Volt)  
Установить текущее значение мощности нагрева в вольтах.  
Аргументы  
Volt — Напряжение (в Вольтах), соответствующее мощности нагрева  
Возвращает  
Нет  
Исключения  
Нет

---
void save_profile()  
Сохранить текущие настройки (профиль) в энергонезависимую память.  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет

---
void beer_finish()  
Завершить процесс варки: отключить нагрев, насос, клапаны, остановить все процессы.  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет

---
void set_heater_state(float setpoint, float temp)  
Управление состоянием нагревателя на основе ПИД-регулирования.  
Аргументы  
setpoint — Целевая температура (°C)  
temp — Текущая температура (°C)  
Возвращает  
Нет  
Исключения  
Нет

---
void set_heater(double dutyCycle)  
Установить уровень ШИМ для нагревателя.  
Аргументы  
dutyCycle — Скважность в диапазоне [0.0, 1.0]  
Возвращает  
Нет  
Исключения  
Нет

---
void setHeaterPosition(bool state)  
Включить или выключить физическое положение нагревателя (через реле или твердотельное реле).  
Аргументы  
state — true для включения, false для выключения  
Возвращает  
Нет  
Исключения  
Нет

---
void run_beer_program(uint8_t num)  
Перейти к указанному этапу программы затирания и инициализировать его.  
Аргументы  
num — Номер строки (этапа) программы затирания  
Возвращает  
Нет  
Исключения  
Нет

---
void StartAutoTune()  
Запустить процесс автотюнинга ПИД-регулятора для подбора оптимальных коэффициентов.  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет

---
void FinishAutoTune()  
Завершить процесс автотюнинга и применить полученные параметры ПИД.  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет

---
void set_power(bool On)  
Включить или выключить питание основных компонентов системы.  
Аргументы  
On — true для включения, false для выключения  
Возвращает  
Нет  
Исключения  
Нет

---
void create_data()  
Создать новый файл для записи данных сессии (температура, события и т.д.).  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет

---
void open_valve(bool Val, bool msg)  
Открыть или закрыть клапан подачи жидкости.  
Аргументы  
Val — true для открытия, false для закрытия  
msg — true, если нужно отправить уведомление через MQTT  
Возвращает  
Нет  
Исключения  
Нет

---
void SendMsg(const String& m, MESSAGE_TYPE msg_type)  
Отправить сообщение пользователю через доступные интерфейсы (MQTT, дисплей и т.п.).  
Аргументы  
m — Текст сообщения  
msg_type — Тип сообщения (например, уведомление, ошибка, статус)  
Возвращает  
Нет  
Исключения  
Нет

---
String get_beer_program()  
Получить строковое описание текущей программы затирания.  
Возвращает  
Форматированная строка с описанием всех этапов программы  
Исключения  
Нет

---
void check_mixer_state()  
Проверить текущее состояние мешалки и насоса, при необходимости изменить режим работы.  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет

---
void set_mixer_state(bool state, bool dir)  
Установить состояние и направление вращения мешалки.  
Аргументы  
state — true для включения, false для выключения  
dir — true для реверса, false для прямого вращения  
Возвращает  
Нет  
Исключения  
Нет

---
bool set_mixer_pump_target(uint8_t on)  
Установить целевое состояние насоса мешалки через интерфейс I2C.  
Аргументы  
on — 1 для включения, 0 для выключения  
Возвращает  
true в случае успеха, false при ошибке связи  
Исключения  
Нет

---
bool set_stepper_by_time(uint16_t spd, uint8_t direction, uint16_t time)  
Управление шаговым двигателем на заданное время с указанной скоростью и направлением.  
Аргументы  
spd — Скорость движения (условные единицы)  
direction — Направление (0 — вперёд, 1 — назад)  
time — Время работы в миллисекундах  
Возвращает  
true если операция выполнена успешно  
Исключения  
Нет

---
void HopStepperStep()  
Выполнить один шаг шагового двигателя для дозирования хмеля.  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет

---
void set_buzzer(bool fl)  
Включить или выключить звуковой сигнал (бuzzer).  
Аргументы  
fl — true для включения, false для выключения  
Возвращает  
Нет  
Исключения  
Нет

---
void set_pump_pwm(float duty)  
Установить ШИМ-сигнал для управления скоростью насоса.  
Аргументы  
duty — Значение скважности в диапазоне [0.0, 1.0]  
Возвращает  
Нет  
Исключения  
Нет

---
void reset_sensor_counter(void)  
Сбросить счётчики датчиков и внутренние счётчики состояния процесса.  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет

---
bool isBoilingStarted(float currentTemp)  
Определить, началось ли кипение на основе анализа стабильности температуры.  
Аргументы  
currentTemp — Текущее значение температуры (°C)  
Возвращает  
true, если кипение зафиксировано; false в противном случае  
Исключения  
Нет

---
bool detect_boiling(float currentTemp)  
Проверяет, началось ли кипячение на основе стабильности температуры и тренда в окне измерений.  
Аргументы  
currentTemp — Текущее значение температуры в градусах Цельсия.  
Возвращает  
true, если зафиксировано устойчивое кипячение; иначе false.  
Исключения  
Нет

---
void resetBoilingDetector()  
Сбрасывает состояние детектора кипячения: очищает историю, индексы и счётчики.  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет

---
void beer_proc()  
Основной цикл запуска процесса затирания. Инициализирует состояние при старте и запускает программу.  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет

---
void check_alarm_beer()  
Основная функция контроля состояния процесса: обрабатывает текущий этап, управляет нагревом, охлаждением и кипячением.  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет

---
class SamSetup  
Глобальные настройки устройства, включая напряжение, состояние реле и использование дополнительных функций.  
Поля  
BVolt — Целевое напряжение для нагревателя при использовании режима мощности  
rele1 — Состояние реле канала 1 (нагрев)  
rele4 — Состояние реле канала 4 (дополнительное управление)  
UseST — Флаг использования режима стабилизации температуры  
Методы  
Нет

---
class program  
Описывает шаг технологической программы.  
Поля  
WType — Тип операции ("M" — засыпь, "P" — пауза, "B" — кипячение, "C" — охлаждение, "F" — брага, "A" — автотюнинг, "W" — ожидание, "L" — Lua)  
Temp — Целевая температура для шага, °C  
Time — Время выдержки на шаге, минуты  
Методы  
Нет
