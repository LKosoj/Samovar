# logic

Модуль реализует логику управления самогонным аппаратом на базе ESP32, обеспечивая контроль температуры, давления, управление шаговым двигателем, насосом, питанием и сигнализацией. Поддерживает профили отбора, детектирование примесей, коррекцию температуры по давлению и интеграцию с Blynk. Обеспечивает аварийное отключение при критических ситуациях и взаимодействие с пользователем через меню и сообщения.

Ключевые структуры данных  
SamSetup — глобальная структура с настройками аппарата, включая параметры шагового двигателя, сенсоров и режимов работы  
SteamSensor — структура данных для хранения информации о температуре пара, начальном давлении и корректировке температуры  
program — массив программных шагов, определяющих режимы отбора (головы, тело, хвосты и т.д.)  
ActualVolumePerHour — текущая целевая скорость отбора в мл/час

float get_liquid_volume_by_step(float StepCount)  
Возвращает объем жидкости в мл по количеству шагов двигателя  
Аргументы  
StepCount — количество шагов двигателя  
Возвращает  
Объем жидкости в миллилитрах, рассчитанный по шагам и калибровке StepperStepMl

---
float get_liquid_rate_by_step(int StepperSpeed)  
Возвращает скорость отбора в мл/час на основе текущей скорости шаговика  
Аргументы  
StepperSpeed — текущая скорость шагового двигателя в шагах/сек  
Возвращает  
Скорость отбора в мл/час, округлённая до трёх знаков после запятой

---
float get_speed_from_rate(float volume_per_hour)  
Преобразует требуемый объёмный расход в скорость шаговика  
Аргументы  
volume_per_hour — желаемый расход в мл/час  
Возвращает  
Скорость шаговика в шагах/сек, минимум — 1 шаг/сек

---
uint8_t getDelimCount(const String& data, char separator)  
Подсчитывает количество вхождений разделителя в строке  
Аргументы  
data — входная строка  
separator — символ-разделитель  
Возвращает  
Количество найденных разделителей

---
String getValue(const String& data, char separator, int index)  
Извлекает подстроку по индексу, разделённую заданным символом  
Аргументы  
data — исходная строка  
separator — символ-разделитель  
index — индекс требуемой части (начиная с 0)  
Возвращает  
Подстрока, находящаяся по указанному индексу

---
int get_liquid_volume()  
Возвращает текущий объём отобранной жидкости в мл  
Возвращает  
Объём в мл, рассчитанный по текущему положению шагового двигателя

---
void set_alarm()  
Инициирует аварийное отключение: отключает питание, воду, насос, шаговик и включает сигнализацию  
Аргументы  
fl — флаг состояния сигнализации (true — включить, false — выключить)

---
void withdrawal(void)  
Основная функция управления процессом отбора: обрабатывает условия завершения этапа (по времени, температуре, объёму), управляет паузами и переключением программ  
Исключения  
Функция может инициировать переход в меню старта при достижении целевых условий (температура, объём, пауза)

---
void set_body_temp()  
Корректирует базовую температуру отбора тела на основе текущих данных с датчиков пара и давления  
Исключения  
Коррекция применяется только при определённых условиях программы (например, первая строка тела или предзахлеб)

---
void process_impurity_detector()  
Анализирует данные детектора примесей и при необходимости инициирует переход к следующему этапу отбора (например, от тела к хвостам)  
Исключения  
Вызывается внутри функции withdrawal(), требует инициализации детектора

---
void detector_on_program_start(const String& wtype)  
Инициализирует детектор примесей при старте новой программы отбора  
Аргументы  
wtype — тип текущего этапа отбора (например, "H", "B", "C")

---
void detector_on_auto_resume()  
Сигнализирует детектору о возобновлении отбора после автоматической паузы  
Исключения  
Требует предварительной активации детектора

---
void detector_on_manual_resume()  
Сигнализирует детектору о возобновлении отбора после ручной паузы  
Исключения  
Требует предварительной активации детектора

---
float get_temp_by_pressure(float start_pressure, float start_temp, float current_pressure)  
Корректирует температуру кипения с учётом изменения атмосферного давления  
Аргументы  
start_pressure — начальное давление (в гПа)  
start_temp — начальная температура кипения  
current_pressure — текущее давление  
Возвращает  
Скорректированная температура кипения при текущем давлении

---
void set_pump_speed(float pumpspeed, bool continue_process)  
Устанавливает скорость насоса в мл/час и управляет продолжением процесса  
Аргументы  
pumpspeed — целевая скорость в мл/час  
continue_process — флаг продолжения технологического процесса после установки

---
void set_pump_pwm(float duty)  
Устанавливает скважность ШИМ для управления насосом напрямую  
Аргументы  
duty — значение ШИМ в диапазоне 0–255

---
void set_power(bool On)  
Включает или выключает нагревательную мощность  
Аргументы  
On — true для включения, false для выключения

---
void set_power_mode(String Mode)  
Переключает режим управления мощностью (например, "PID", "PWM", "OFF")  
Аргументы  
Mode — строка, определяющая режим работы

---
void set_current_power(float Volt)  
Устанавливает текущее значение мощности в вольтах (для калибровки или ручного режима)  
Аргументы  
Volt — напряжение в вольтах

---
void open_valve(bool Val, bool msg)  
Открывает или закрывает клапан отбора  
Аргументы  
Val — true для открытия, false для закрытия  
msg — флаг необходимости отправки сообщения о действии

---
void pause_withdrawal(bool Pause)  
Ставит отбор на паузу или возобновляет его  
Аргументы  
Pause — true для паузы, false для возобновления

---
void SendMsg(const String &m, MESSAGE_TYPE msg_type)  
Отправляет сообщение в интерфейс пользователя (например, на дисплей или в Blynk)  
Аргументы  
m — текст сообщения  
msg_type — тип сообщения (например, ALARM_MSG, INFO_MSG)

---
void menu_samovar_start()  
Переходит в главное меню или завершает текущий режим отбора, останавливая все процессы  
Исключения  
Останавливает шаговик, насос, нагрев, сбрасывает флаги паузы и программы

---
void samovar_reset()  
Полностью сбрасывает состояние аппарата: останавливает все процессы, сбрасывает счётчики и флаги  
Исключения  
Выполняет полную инициализацию состояния системы

---
void start_self_test(void)  
Запускает самодиагностику подключённых датчиков, исполнительных механизмов и питания  
Исключения  
Может инициировать аварийное отключение при обнаружении неисправности

---
void stop_self_test(void)  
Останавливает выполнение самодиагностики  
Исключения  
Прерывает тестовые циклы и возвращает систему в исходное состояние

---
bool check_boiling()  
Проверяет, начался ли процесс кипения на основе данных с датчика температуры пара  
Возвращает  
true, если температура пара стабильно растёт и превысила порог кипения

---
void set_boiling()  
Фиксирует момент начала кипения: сохраняет начальные данные (температуру, давление, время)  
Исключения  
Вызывается однократно при первом обнаружении кипения

---
bool set_stepper_target(uint16_t spd, uint8_t direction, uint32_t target)  
Устанавливает целевую скорость, направление и количество шагов для шагового двигателя  
Аргументы  
spd — скорость в шагах/сек  
direction — направление (0 — закрыть, 1 — открыть)  
target — целевое количество шагов (0 — движение без остановки)  
Возвращает  
true, если команда успешно передана драйверу двигателя

---
float get_dist_remaining_time()  
Рассчитывает оставшееся время отбора в часах на основе текущей скорости и оставшегося объёма  
Возвращает  
Оставшееся время в часах

---
float get_dist_predicted_total_time()  
Рассчитывает общее предсказываемое время отбора на основе начального объёма и текущей скорости  
Возвращает  
Общее время отбора в часах

---
void reset_sensor_counter(void)  
Сбрасывает счётчики импульсов с датчиков (например, с расходомера или шаговика)  
Исключения  
Обнуляет внутренние счётчики, используемые для расчёта объёма

---
void startService(void)  
Возобновляет работу сервисных задач (например, опрос датчиков, обновление интерфейса)  
Исключения  
Может быть заблокирована при активной аварии

---
void stopService(void)  
Останавливает фоновые сервисные задачи  
Исключения  
Приостанавливает обновление дисплея, опрос датчиков и передачу данных

---
void create_data()  
Инициализирует или пересоздаёт данные сенсоров и состояния системы  
Исключения  
Вызывается при старте или сбросе системы

---
void read_config()  
Считывает настройки самовара из энергонезависимой памяти (EEPROM или SPIFFS)  
Исключения  
Перезаписывает глобальные переменные SamSetup значениями из сохранённой конфигурации

---
void save_profile()  
Сохраняет текущий профиль программы отбора во внешнее хранилище  
Исключения  
Использует SPIFFS или EEPROM для сохранения массива program

---
void set_menu_screen(uint8_t param)  
Переключает экран меню на указанный режим отображения  
Аргументы  
param — идентификатор экрана (например, 0 — основной, 1 — настройки)

---
void set_buzzer(bool fl)  
Включает или выключает звуковую сигнализацию  
Аргументы  
fl — true для включения, false для выключения

---
unsigned int hexToDec(String hexString)  
Преобразует строку в шестнадцатеричном формате в десятичное число  
Аргументы  
hexString — строка, содержащая шестнадцатеричное число  
Возвращает  
Целое десятичное число

---
String format_float(float v, int d)  
Форматирует число с плавающей точкой в строку с заданным количеством знаков после запятой  
Аргументы  
v — число для форматирования  
d — количество знаков после запятой  
Возвращает  
Строка с отформатированным числом

---
#ifdef SAMOVAR_USE_POWER  
void check_power_error()  
Проверяет наличие ошибок в цепи питания (перегрузка, обрыв, превышение напряжения)  
Исключения  
При обнаружении ошибки инициирует set_alarm()  
#endif

---
#ifdef COLUMN_WETTING  
bool column_wetting()  
Выполняет процедуру увлажнения колонны перед началом ректификации  
Возвращает  
true при успешном завершении увлажнения  
Исключения  
Требует наличия насоса и клапана подачи воды  
#endif
