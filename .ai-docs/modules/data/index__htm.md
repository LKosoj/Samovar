# data/index

Модуль реализует клиентскую логику управления устройством через веб-интерфейс. Он отвечает за отображение и обработку сообщений, валидацию и расчёт параметров программы, отправку команд на сервер, а также взаимодействие с элементами интерфейса, такими как вкладки, спойлеры и формы ввода. Основное внимание уделено обработке пользовательского ввода, расчёту времени выполнения программы и управлению аудиооповещениями при возникновении тревог.

Ключевые структуры данных  
Messages_Array — массив строк, содержащих HTML-представление сообщений для отображения в интерфейсе  
is_ALARM — флаг, указывающий на наличие сообщений с признаком тревоги (класс message_0)  
sound_is_on — флаг включения звукового оповещения

---
void showMessages()  
Обновляет отображение списка сообщений и управляет звуковым оповещением  
Аргументы  
Возвращает  
Исключения

---
void clearMessages()  
Очищает массив сообщений и обновляет отображение  
Аргументы  
Возвращает  
Исключения

---
int openTab(evt, tabName)  
Переключает активную вкладку в интерфейсе  
Аргументы  
evt — событие клика по вкладке  
tabName — имя вкладки для отображения  
Возвращает  
0 — признак успешного завершения  
Исключения

---
bool check_program(str)  
Проверяет корректность формата программы по разделителям  
Аргументы  
str — строка с текстом программы, разделённой строками и точкой с запятой  
Возвращает  
true — если программа имеет единый формат строк; false — при несоответствии структуры  
Исключения

---
void calc_program()  
Выполняет нормализацию значений полей программы и обновляет скрытое текстовое поле  
Аргументы  
Возвращает  
Исключения

---
void calc_time()  
Рассчитывает время выполнения каждой строки программы и общее время  
Аргументы  
Возвращает  
Исключения

---
int set_program()  
Отправляет программу на сервер для сохранения  
Аргументы  
Возвращает  
0 — признак завершения операции  
Исключения

---
void sleep(milliseconds)  
Выполняет синхронную задержку выполнения (блокирующая операция)  
Аргументы  
milliseconds — количество миллисекунд задержки  
Возвращает  
Исключения

---
int sendbutton(command)  
Отправляет GET-запрос с командой на сервер  
Аргументы  
command — строка с параметром команды (например, "voltage=5.0")  
Возвращает  
0 — признак завершения операции  
Исключения

---
int sendvoltage()  
Читает значение напряжения из поля ввода и отправляет на сервер  
Аргументы  
Возвращает  
0 — если ввод корректен; иначе прерывается с alert  
Исключения

---
int sendpumpspeed()  
Читает значение скорости насоса и отправляет команду на сервер  
Аргументы  
Возвращает  
0 — если ввод корректен; иначе прерывается с alert  
Исключения

---
void sendI2CPump()  
Формирует и отправляет команду управления I2C-насосом по скорости и объёму  
Аргументы  
Возвращает  
Исключения

---
void stopI2CPump()  
Останавливает работу I2C-насоса  
Аргументы  
Возвращает  
Исключения

---
void loadDoc()  
Выполняет периодический опрос сервера для получения текущего состояния системы  
Аргументы  
Возвращает  
Исключения

---
string get_time(tm)  
Преобразует время в часах в строку формата "MM:SS"  
Аргументы  
tm — время в часах (дробное число)  
Возвращает  
Отформатированная строка времени в формате "MM:SS"  
Исключения

---
void set_num()  
Нумерует строки программы с ведущим нулём  
Аргументы  
Возвращает  
Исключения

---
void removeLine(ln)  
Удаляет строку программы по её ID, если осталось более 3 строк  
Аргументы  
ln — ID строки программы (например, "prgln2")  
Возвращает  
Исключения

---
void addLine(obj, s)  
Добавляет новую строку программы в интерфейс  
Аргументы  
obj — ID строки, после которой вставляется новая; если false — в конец  
s — строка данных формата "Тип;Объём;Скорость;Тара;Температура;Мощность"  
Возвращает  
Исключения

---
void getProgram()  
Парсит и валидирует программу из текстового поля, перестраивает интерфейс  
Аргументы  
Возвращает  
Исключения

---
void set_bgcolor(indx)  
Устанавливает цвет фона строки программы в зависимости от типа операции  
Аргументы  
indx — индекс строки программы  
Возвращает  
Исключения

---
void setProgColor(l, t, indx)  
Устанавливает цвет фона строки программы в зависимости от типа и текущего шага  
Аргументы  
l — DOM-элемент строки программы  
t — тип шага ("D", "C", "P", "T")  
indx — индекс шага в программе  
Возвращает  
void  
Исключения

---
void run_lua(num)  
Отправляет команду на выполнение Lua-скрипта по номеру  
Аргументы  
num — номер Lua-скрипта  
Возвращает  
void  
Исключения

---
void run_strlua()  
Выполняет произвольный Lua-код, введённый пользователем  
Аргументы  
Возвращает  
void  
Исключения

---
void ajax_get()  
Отправляет GET-запрос на сервер для получения данных  
Аргументы  
Возвращает  
Исключения

---
void updateUI(data)  
Обновляет интерфейс на основе полученных данных  
Аргументы  
data — объект с полями: detector_status_text, detector_trend, Status, ActualVolumePerHour, VolumeAll, WthdrwlProgress, power_current, current_power_volt, power_unit_current, current_power_mode, power_target, target_power_volt, power_unit_target, current_power_p, bme_pressure, pressureLabel, pressureValue, heap, bme_temp, rssi, fr_bt, add_param, totalTime, Descr  
Возвращает  
Нет  
Исключения

---
class Detector  
Отображает статус детектора примесей и тренд  
Поля  
statusText — текущий статус детектора ("-", "Чисто", "Примесь" и т.п.)  
trend — направление изменения концентрации ("↑", "↓", "→")  
Методы  
updateStatus(status, trend) — обновляет отображаемый статус и тренд

---
class PowerRegulator  
Управляет параметрами питания нагревателя: напряжение, мощность, режим  
Поля  
currentVoltage — текущее напряжение  
targetVoltage — целевое напряжение  
currentPower — текущая мощность в ваттах  
mode — текущий режим работы ("Ручной", "Автомат")  
Методы  
setVoltage(voltage) — устанавливает целевое напряжение  
updateDisplay() — обновляет отображение текущих и целевых параметров

---
class WithdrawalProgress  
Контролирует отображение прогресса отбора и объёма  
Поля  
volumePerHour — текущая скорость отбора в л/ч  
totalVolume — общий отобранный объём в мл  
progressPercent — процент завершения отбора  
Методы  
update(volumePerHour, totalVolume, progressPercent) — обновляет данные отбора

---
class SystemMonitor  
Отображает системные параметры: память, температуру, RSSI  
Поля  
heap — объём свободной кучи  
bmeTemp — температура с датника BME  
rssi — уровень сигнала Wi-Fi  
freeSpace — свободное место (в байтах или условных единицах)  
Методы  
refresh(heap, bmeTemp, rssi, freeSpace) — обновляет отображение системных данных

---
class I2CPumpConfig  
Хранит параметры конфигурации I2C-насоса  
Поля  
speed — скорость насоса в шагах в секунду  
volume — объём для отбора в мл  
direction — направление потока (1 — вперёд, -1 — назад)  
Методы  
setSpeed(speed) — устанавливает скорость  
setVolume(volume) — устанавливает объём  
setDirection(direction) — устанавливает направление
