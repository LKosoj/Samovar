# data/distiller

Модуль отвечает за управление интерфейсом веб-страницы дистилляционной установки: отображение и редактирование сообщений, обработку пользовательских действий, отправку команд на сервер, работу с программами и настройками. Основные функции включают добавление и удаление сообщений с поддержкой тревожных уведомлений, отправку HTTP-запросов, управление вкладками и элементами интерфейса. Модуль также обеспечивает динамическое редактирование программ перегонки и взаимодействие с периферийными устройствами через I2C.

Ключевые структуры данных  
Messages_Array — массив строк, содержащих HTML-представления сообщений с признаками тревоги  
is_ALARM — флаг, указывающий на наличие хотя бы одного тревожного сообщения в очереди  
sound_play_count — счётчик воспроизведений звукового сигнала тревоги

addMessage(msg, lvl)  
Добавляет новое сообщение в очередь с возможной установкой обработчика удаления.  
Аргументы  
msg — текст сообщения в формате HTML  
lvl — уровень приоритета сообщения (0 — тревога, 1 — информационное, 2 — предупреждение)  
Возвращает  
Исключения

---
removeLastMessage()  
Удаляет последнее сообщение из очереди и обновляет предпоследнее, добавляя обработчик клика.  
Аргументы  
Возвращает  
Исключения

---
showMessages()  
Отображает все сообщения из Messages_Array в DOM, обновляет флаг тревоги и управляет звуком.  
Аргументы  
Возвращает  
Исключения

---
clearMessages()  
Очищает очередь сообщений и скрывает блок отображения.  
Аргументы  
Возвращает  
Исключения

---
openTab(evt, tabName)  
Активирует вкладку с указанным именем, скрывая остальные.  
Аргументы  
evt — событие клика по вкладке  
tabName — имя вкладки (идентификатор элемента)  
Возвращает  
0 — признак успешного выполнения  
Исключения

---
setDistCommand()  
Формирует и отправляет команду включения или выключения нагрева дистиллятора.  
Аргументы  
Возвращает  
0 — признак завершения операции  
Исключения

---
sendbutton(command)  
Синхронно отправляет GET-запрос на сервер с указанной командой.  
Аргументы  
command — строка команды, добавляемая к URL '/command?'  
Возвращает  
0 — после успешной отправки или обработки ошибки  
Исключения  
При статусе ответа, отличном от 200, выводится alert с кодом ошибки

---
sendvoltage()  
Отправляет команду установки напряжения, заменяя запятую на точку в значении.  
Аргументы  
Возвращает  
0 — после отправки команды и вывода уведомления  
Исключения

---
sendI2CPump()  
Асинхронно отправляет команду запуска I2C-насоса с заданной скоростью и объёмом.  
Аргументы  
Возвращает  
Исключения

---
stopI2CPump()  
Асинхронно отправляет команду остановки I2C-насоса.  
Аргументы  
Возвращает  
Исключения

---
set_program()  
Отправляет программу перегонки на сервер методом POST.  
Аргументы  
Возвращает  
0 — после завершения отправки  
Исключения  
При ошибке HTTP выводится alert с кодом и текстом ошибки

---
calc_program()  
Формирует текст программы из значений полей формы и обновляет поле WProgram.  
Аргументы  
Возвращает  
Исключения

---
set_num()  
Нумерует строки программы с ведущим нулём (01, 02 и т.д.).  
Аргументы  
Возвращает  
Исключения

---
removeLine(ln)  
Удаляет строку программы по её идентификатору, если остаётся не менее двух строк.  
Аргументы  
ln — идентификатор удаляемой строки (например, 'prgln3')  
Возвращает  
Исключения

---
addLine(obj, s)  
Добавляет новую строку программы в DOM на основе строки с разделителями-точками.  
Аргументы  
obj — ссылка на элемент, вызвавший функцию (не используется)  
s — строка формата "тип;температура;значение;время;доп.параметры", разделённая точками с запятой  
Возвращает  
Исключения

---
class XMLHttpRequest  
Объект для выполнения HTTP-запросов к серверу.  
Методы  
open(method, url, async) — инициализирует запрос с указанным методом, URL и асинхронностью  
send(data) — отправляет запрос с опциональными данными

---
ConnectError(Type)  
Обрабатывает состояние соединения с устройством, отображая индикатор связи и уведомления.  
Аргументы  
Type — булево значение: true — ошибка соединения, false — соединение восстановлено  
Возвращает  
Исключения

---
setPowerUnit()  
Настройка отображения элементов управления мощностью в зависимости от выбранной единицы измерения (Вт или В).  
Аргументы  
Возвращает  
Исключения

---
AddLuaButtons()  
Динамически создаёт и добавляет кнопки запуска Lua-скриптов в интерфейс на основе списка.  
Аргументы  
Возвращает  
Исключения

---
getHistory()  
Получает массив сохранённых сообщений из локального хранилища браузера.  
Аргументы  
Возвращает  
Массив строк с HTML-представлением сообщений  
Исключения

---
saveHistory(message)  
Сохраняет новое сообщение в историю, хранящуюся в локальном хранилище.  
Аргументы  
message — строка с HTML-представлением сообщения  
Возвращает  
Исключения

---
showHistory()  
Отображает или скрывает блок истории сообщений.  
Аргументы  
Возвращает  
Исключения

---
clearHistory()  
Очищает историю сообщений в локальном хранилище и обновляет отображение.  
Аргументы  
Возвращает  
Исключения

---
playSound(play)  
Воспроизводит звуковое оповещение при тревожных событиях с ограничением числа повторов.  
Аргументы  
play — флаг: true — начать воспроизведение, false — остановить  
Возвращает  
Исключения

---
class DistillationStep  
Описывает шаг программы дистилляции: тип, значение, номер емкости и дополнительные параметры.  
Поля  
type — Тип шага (T, P, A, S, R — температура, давление, отбор, ожидание, возврат)  
value — Уставка (например, температура в °C или давление в мм рт.ст.)  
step — Номер шага в программе  
aux — Дополнительный параметр (например, номер емкости или время ожидания)  
Методы  
execute() — Применяет шаг к системе управления  
validate() — Проверяет корректность параметров шага

---
class PumpConfig  
Хранит и управляет параметрами внешнего I2C-насоса.  
Поля  
speed_lph — Скорость отбора в литрах в час  
volume_ml — Объём для отбора в миллилитрах  
current_speed_pps — Текущая скорость в шагах в секунду  
remaining_ml — Оставшийся объём для отбора  
status — Статус насоса (работает, остановлен, ошибка)  
Методы  
updateStatus() — Обновляет текущий статус насоса из устройства  
reset() — Сбрасывает счётчики и параметры насоса

---
class powerControl  
Управляет отображением и обновлением параметров мощности и режима работы  
Поля  
target_power_volt — отображает целевое напряжение или мощность  
current_power_volt — отображает текущее напряжение или мощность  
current_power_mode — отображает текущий режим регулирования (например, "Вольты", "Ватты")  
current_power_p — отображает текущую мощность в ваттах  
Методы  
updatePowerDisplay(data) — обновляет отображение параметров мощности на основе полученных данных

---
class systemStatus  
Обновляет отображение системных параметров устройства  
Поля  
bme_temp — температура по данным датчика BME  
bme_pressure — давление по данным датчика BME  
rssi — уровень сигнала Wi-Fi  
heap — объём свободной кучи (heap) в памяти  
fr_bt — отображает объём свободной памяти или другого ресурса  
add_param — дополнительные параметры, отображаемые динамически  
Методы  
updateStatus(data) — обновляет все системные параметры на основе полученных данных

---
class programDisplay  
Управляет отображением и редактированием программы дистилляции  
Поля  
WProgram — текстовое поле для редактирования программы  
Descr — текстовое поле для описания программы  
prg — контейнер для отображения структурированной программы  
Методы  
loadProgram(data) — загружает и парсит программу для отображения в виде списка этапов  
saveProgram() — сохраняет текущее содержимое полей программы и описания на сервер  
validateProgram() — проверяет корректность синтаксиса программы перед сохранением
