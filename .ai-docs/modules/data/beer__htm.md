# data/beer

Модуль реализует клиентскую часть веб-интерфейса системы управления "Самовар", обеспечивая отображение состояния соединения, управление мощностью, обработку пользовательских сообщений, воспроизведение звуковых оповещений и работу с историей сообщений. Поддерживает динамическое формирование интерфейса на основе конфигурации, включая добавление пользовательских кнопок через LUA-скрипты. Обеспечивает уведомления о потерях связи и критических состояниях. Работает в реальном времени, взаимодействуя с сервером через AJAX (не показан в коде).

Ключевые структуры данных  
Messages_Array — массив текущих отображаемых сообщений с поддержкой динамического удаления последнего элемента  
sound — объект Audio для воспроизведения циклического звукового сигнала тревоги

ConnectError(Type)  
Устанавливает статус соединения и отображает индикатор связи в зависимости от состояния  
Аргументы  
Type — булево значение: true означает ошибку соединения, false — восстановление связи  
Возвращает  
void  
Исключения  
Нет

---
setPowerUnit()  
Настраивает отображение элементов управления мощностью в зависимости от единиц измерения (Вт или Вольт)  
Аргументы  
Нет  
Возвращает  
void  
Исключения  
Нет

---
AddLuaButtons()  
Добавляет на страницу пользовательские кнопки, определённые в строке %btn_list%, с привязкой к вызову LUA-скриптов  
Аргументы  
Нет  
Возвращает  
void  
Исключения  
Нет

---
playSound(play)  
Запускает или останавливает циклическое воспроизведение звукового сигнала тревоги  
Аргументы  
play — булево значение: true для запуска звука, false для остановки  
Возвращает  
void  
Исключения  
Нет

---
getHistory()  
Возвращает массив сохранённых сообщений из localStorage  
Аргументы  
Нет  
Возвращает  
Массив строк в формате HTML, представляющих историю сообщений  
Исключения  
Может выбрасывать исключение при повреждённых данных в localStorage, обрабатывается внутри функции

---
saveHistory(message)  
Сохраняет новое сообщение в историю в localStorage  
Аргументы  
message — строка в формате HTML, представляющая сообщение для сохранения  
Возвращает  
void  
Исключения  
Нет

---
showHistory()  
Переключает видимость блока с историей сообщений; при открытии обновляет содержимое из localStorage  
Аргументы  
Нет  
Возвращает  
void  
Исключения  
Нет

---
clearHistory()  
Очищает всю историю сообщений в localStorage и обновляет отображение  
Аргументы  
Нет  
Возвращает  
void  
Исключения  
Нет

---
addMessage(msg, lvl)  
Добавляет новое сообщение в очередь отображаемых сообщений, присваивает стиль по уровню важности, сохраняет в историю  
Аргументы  
msg — текст сообщения  
lvl — уровень важности: 0 — тревога (красный), 1 — предупреждение (жёлтый), 2 — информационное (зелёный)  
Возвращает  
void  
Исключения  
Нет

---
removeLastMessage()  
Удаляет последнее сообщение из очереди отображения и обновляет флаги состояния тревоги и паузы  
Аргументы  
Нет  
Возвращает  
void  
Исключения  
Нет

---
showMessages()  
Обновляет отображение текущих сообщений в интерфейсе на основе Messages_Array  
Аргументы  
Нет  
Возвращает  
void  
Исключения  
Нет

---
Модуль реализует клиентскую логику веб-интерфейса управления устройством, включая отображение сообщений, обработку программ, взаимодействие с сервером через HTTP-запросы, управление элементами интерфейса (вкладки, спойлеры), загрузку и сохранение файлов, а также отправку команд и данных. Основное внимание уделено обновлению состояния интерфейса в реальном времени, валидации ввода и аудиооповещению при тревогах. Модуль работает с глобальным массивом сообщений и взаимодействует с DOM-элементами по их ID.

Ключевые структуры данных  
Messages_Array — глобальный массив строк, содержащих HTML-представления сообщений, отображаемых в интерфейсе  
is_ALARM — флаг, указывающий на наличие в списке сообщений хотя бы одного с признаком тревоги (класс message_0)  
pwr_unit — строка, содержащая единицу измерения мощности, подставляемую из сервера  
request — глобальный объект XMLHttpRequest, используемый для синхронных и асинхронных запросов

---
showMessages()  
Обновляет отображение списка сообщений и управляет звуковым оповещением  
Аргументы  
Нет  
Возвращает  
void  
Исключения  
Нет

---
clearMessages()  
Очищает массив сообщений и обновляет их отображение  
Аргументы  
Нет  
Возвращает  
void  
Исключения  
Нет

---
pwr_unit  
Единица измерения мощности, подставляемая из сервера при генерации страницы

---
_lnIdx  
Счётчик строк, используется для внутренней нумерации (назначение не полностью очевидно из кода)

---
headers  
Коллекция DOM-элементов заголовков спойлеров, переключающих видимость содержимого

---
headerClick()  
Переключает видимость скрытого содержимого спойлера и меняет индикатор [+] / [-]  
Аргументы  
Нет  
Возвращает  
void  
Исключения  
Нет

---
loadFile(e)  
Загружает текстовый файл в поле программы  
Аргументы  
e — объект File, выбранный пользователем  
Возвращает  
void  
Исключения  
Нет

---
SaveProgramToFile()  
Сохраняет содержимое поля программы в локальный файл  
Аргументы  
Нет  
Возвращает  
void  
Исключения  
Нет

---
openTab(evt, tabName)  
Активирует вкладку с указанным именем и скрывает остальные  
Аргументы  
evt — событие, вызвавшее переключение (используется для выделения активной кнопки)  
tabName — строка с ID вкладки, которую нужно отобразить  
Возвращает  
0 — признак успешного завершения  
Исключения  
Нет

---
check_program(str)  
Проверяет корректность формата программы по разделителям  
Аргументы  
str — строка с текстом программы, разбитая на строки  
Возвращает  
true — если структура программы корректна; false — при несоответствии количества разделителей  
Исключения  
Нет

---
set_program()  
Отправляет программу на сервер для сохранения, предварительно проверяя её формат  
Аргументы  
Нет  
Возвращает  
0 — признак завершения (даже при ошибке)  
Исключения  
Нет

---
sleep(milliseconds)  
Выполняет синхронную задержку выполнения (блокирует интерфейс)  
Аргументы  
milliseconds — количество миллисекунд задержки  
Возвращает  
void  
Исключения  
Нет

---
sendbutton(command)  
Отправляет GET-запрос с командой на сервер  
Аргументы  
command — строка с параметрами команды (например, "voltage=12.5")  
Возвращает  
0 — признак завершения  
Исключения  
Нет

---
sendvoltage()  
Считывает значение напряжения из поля, валидирует и отправляет на сервер  
Аргументы  
Нет  
Возвращает  
0 — если ввод неверен; иначе — неявно undefined  
Исключения  
Нет

---
sendpumpspeed()  
Считывает значение скорости насоса, валидирует и отправляет команду  
Аргументы  
Нет  
Возвращает  
0 — если ввод неверен; иначе — неявно undefined  
Исключения  
Нет

---
sendI2CPump()  
Отправляет асинхронный запрос для запуска I2C-насоса с заданной скоростью и объёмом  
Аргументы  
Нет  
Возвращает  
void  
Исключения  
Нет

---
stopI2CPump()  
Отправляет асинхронный запрос на остановку I2C-насоса  
Аргументы  
Нет  
Возвращает  
void  
Исключения  
Нет

---
loadDoc()  
Выполняет периодический опрос сервера для получения текущих данных состояния  
Аргументы  
Нет  
Возвращает  
void  
Исключения  
Нет

---
Модуль реализует клиентскую логику управления и отображения состояния устройства для веб-интерфейса системы контроля технологических процессов (например, пивоварения). Основные функции включают обновление интерфейса по данным с сервера, обработку программ управления, валидацию и форматирование строк программы, а также динамическое управление элементами интерфейса. Взаимодействие с сервером осуществляется через асинхронные HTTP-запросы.

Ключевые структуры данных  
myObj — объект, содержащий данные состояния устройства, полученные от сервера (температуры, статусы, мощность, настройки и т.д.)

---
updateStatus()  
Обновляет отображаемые значения интерфейса на основе данных от сервера  
Аргументы  
Отсутствуют  
Возвращает  
Отсутствует  
Исключения  
Отсутствуют

---
calc_program()  
Валидирует и форматирует текст программы, введённой пользователем, в единый структурированный формат  
Аргументы  
Отсутствуют  
Возвращает  
Отсутствует  
Исключения  
Отсутствуют

---
set_num()  
Обновляет нумерацию строк программы в интерфейсе  
Аргументы  
Отсутствуют  
Возвращает  
Отсутствует  
Исключения  
Отсутствуют

---
removeLine(ln)  
Удаляет строку программы из интерфейса, если количество строк больше минимального  
Аргументы  
ln — идентификатор удаляемой строки программы  
Возвращает  
Отсутствует  
Исключения  
Отсутствуют

---
addLine(obj, s)  
Добавляет новую строку программы в интерфейс с заданными параметрами  
Аргументы  
obj — идентификатор строки, после которой будет вставлена новая (если null — добавляется в конец)  
s — строка с параметрами новой строки в формате "тип;температура;время;миксер;датчик"  
Возвращает  
Отсутствует  
Исключения  
Отсутствуют

---
Модуль предоставляет функциональность для управления и визуализации программы технологического процесса, связанного с контролем температуры, мешалки и других параметров. Основные функции включают загрузку и разбор программы, валидацию входных данных, отображение модальных окон для редактирования параметров и обновление интерфейса в реальном времени. Модуль также обеспечивает взаимодействие с серверной частью через отправку команд.

Ключевые структуры данных  
arr — временный массив данных, полученных из строки параметров, разделённой символом "^"

---
popup_modal(idx)  
Открывает модальное окно для редактирования параметров мешалки по заданному индексу  
Аргументы  
idx — индекс строки программы, определяющий, какие данные будут загружены в модальное окно  
Возвращает  
void  
Исключения  
Нет

---
validateMixerInput(inputElement)  
Валидирует и корректирует значение поля ввода, оставляя только числовые данные в допустимом диапазоне  
Аргументы  
inputElement — DOM-элемент поля ввода, значение которого подлежит валидации  
Возвращает  
void  
Исключения  
Нет

---
popup_ok()  
Сохраняет изменения из модального окна в соответствующее поле программы и закрывает окно  
Аргументы  
нет  
Возвращает  
void  
Исключения  
Нет

---
popup_cancel()  
Закрывает модальное окно без сохранения изменений  
Аргументы  
нет  
Возвращает  
void  
Исключения  
Нет

---
getProgram()  
Разбирает текст программы из элемента WProgram, создаёт HTML-представление строк программы и вставляет его в DOM  
Аргументы  
нет  
Возвращает  
void  
Исключения  
Нет

---
set_bgcolor(obj)  
Устанавливает цвет фона строки программы в зависимости от типа операции (значение поля ptype)  
Аргументы  
obj — индекс строки программы, для которой устанавливается цвет  
Возвращает  
void  
Исключения  
Нет

---
run_lua(num)  
Отправляет команду выполнения Lua-скрипта с указанным номером на сервер  
Аргументы  
num — номер Lua-скрипта для выполнения  
Возвращает  
void  
Исключения  
Нет

---
run_strlua()  
Отправляет строку Lua-команды на сервер, заменяя пробелы на символ "^"  
Аргументы  
нет  
Возвращает  
void  
Исключения  
Нет

---
sendwaterpwm()  
Отправляет команду установки значения ШИМ для управления насосом  
Аргументы  
нет  
Возвращает  
0 — всегда возвращает 0 после выполнения  
Исключения  
Нет

---
sliderChange()  
Синхронизирует текстовое поле PWMt со значением ползунка PWM и вызывает отправку команды ШИМ  
Аргументы  
нет  
Возвращает  
void  
Исключения  
Нет

---
changetxtpwm()  
Обновляет значение ползунка PWM на основе ввода в текстовое поле PWMt и вызывает изменение ШИМ  
Аргументы  
нет  
Возвращает  
0 — в случае ошибки ввода, иначе не возвращает явно  
Исключения  
Нет

---
char_count(str, ch)  
Подсчитывает количество вхождений символа ch в строке str  
Аргументы  
str — строка, в которой выполняется подсчёт  
ch — символ, количество вхождений которого нужно подсчитать  
Возвращает  
Число — количество вхождений символа в строке  
Исключения  
Нет

---
class window.onload  
Инициализирует интерфейс при загрузке страницы: устанавливает единицы мощности, добавляет кнопки Lua, загружает программу и запускает периодическое обновление  
Методы  
window.onload — функция, выполняемая при полной загрузке страницы

---
class document.addEventListener('DOMContentLoaded')  
Настраивает обработчики событий: клики по заголовкам-спойлерам и изменение текста программы  
Методы  
document.addEventListener — добавляет реакцию на изменение программы и клики по элементам с атрибутом data-name='spoiler-title'

---
Модуль представляет собой веб-интерфейс для управления процессом затирания в самогонном аппарате. Он отображает текущие температуры в различных точках системы, статус работы, прогресс процесса и позволяет управлять нагревом и программами. Интерфейс поддерживает переключение между вкладками, динамическое обновление данных и взаимодействие с микроконтроллером через HTTP-запросы. Основные параметры (цвета, видимость элементов) настраиваются через замену плейсхолдеров на сервере.

Ключевые структуры данных  
crnt_tm — скрытый элемент для хранения текущего времени (используется как триггер обновления)  
messagesBox — контейнер для отображения системных сообщений пользователя

---
document.getElementById('PipeTemp')  
Получает элемент отображения температуры в царге  
Возвращает  
Объект HTMLElement для обновления значения температуры

---
document.getElementById('SteamTemp')  
Получает элемент отображения температуры пара  
Возвращает  
Объект HTMLElement для обновления значения температуры

---
document.getElementById('WaterTemp')  
Получает элемент отображения температуры воды  
Возвращает  
Объект HTMLElement для обновления значения температуры

---
document.getElementById('TankTemp')  
Получает элемент отображения температуры в кубе  
Возвращает  
Объект HTMLElement для обновления значения температуры

---
document.getElementById('ACPTemp')  
Получает элемент отображения температуры в теплообменнике (ТСА)  
Возвращает  
Объект HTMLElement для обновления значения температуры

---
document.getElementById('Status')  
Получает элемент отображения текущего статуса процесса  
Возвращает  
Объект HTMLElement для обновления текста статуса

---
document.getElementById('WthdrwlProgress')  
Получает элемент отображения прогресса затирания  
Возвращает  
Объект HTMLElement для обновления процентного значения прогресса

---
document.getElementById('current_power_p')  
Получает элемент отображения текущей мощности в ваттах  
Возвращает  
Объект HTMLElement для обновления значения мощности

---
document.getElementById('version')  
Получает элемент отображения версии прошивки  
Возвращает  
Объект HTMLElement для обновления номера версии

---
document.getElementById('stm')  
Получает элемент отображения времени работы системы  
Возвращает  
Объект HTMLElement для обновления времени в формате HH:MM:SS

---
document.getElementById('heap')  
Получает элемент отображения объёма свободной памяти (Heap)  
Возвращает  
Объект HTMLElement для обновления значения памяти

---
document.getElementById('bme_temp')  
Получает элемент отображения температуры с датчика BME  
Возвращает  
Объект HTMLElement для обновления значения температуры

---
document.getElementById('rssi')  
Получает элемент отображения уровня сигнала Wi-Fi (RSSI)  
Возвращает  
Объект HTMLElement для обновления значения RSSI

---
document.getElementById('fr_bt')  
Получает элемент отображения объёма свободного места во Flash  
Возвращает  
Объект HTMLElement для обновления значения памяти

---
openTab(event, tabName)  
Переключает активную вкладку интерфейса (Затирание, Программа, Дополнительно, Внешний насос)  
Аргументы  
event — объект события клика по вкладке  
tabName — имя вкладки для отображения (строка)  
Возвращает  
void  
Исключения  
Нет

---
sendbutton(command)  
Отправляет команду управления на сервер через HTTP-запрос  
Аргументы  
command — строка с параметром команды (например, "power=1")  
Возвращает  
void  
Исключения  
Может выбросить ошибку сети при недоступности сервера

---
sendvoltage()  
Отправляет значение напряжения, введённое пользователем, на сервер  
Аргументы  
Нет (считывает значение из поля #Voltage)  
Возвращает  
void  
Исключения  
Может выбросить ошибку сети при недоступности сервера

---
clearMessages()  
Очищает содержимое блока сообщений на интерфейсе  
Аргументы  
Нет  
Возвращает  
void  
Исключения  
Нет

---
class messagesBox  
Контейнер для отображения и управления системными сообщениями  
Поля  
messages — элемент с массивом сообщений (id='messages')  
Методы  
clearMessages() — очищает список сообщений

---
Модуль предназначен для управления программой затирания в пивоваренной системе. Он позволяет задавать и редактировать последовательность технологических этапов, таких как нагрев, пауза, кипячение, охлаждение, ферментация и выполнение Lua-скриптов. Каждый этап характеризуется типом, температурой, временем и параметрами работы мешалки или насоса. Программа может сохраняться в текстовом виде, загружаться из файлов, а также устанавливаться в устройство для выполнения.

Ключевые структуры данных  
WProgram — строка, содержащая многострочную программу затирания, где каждая строка описывает один этап в формате: Тип;Температура;Время;Режим_мешалки  
Descr — текстовое описание программы, предназначенное для сохранения в облаке и последующей идентификации

---
SaveProgramToFile()  
Сохраняет текущую программу затирания и её описание в локальный файл  
Аргументы  
нет  
Возвращает  
нет  
Исключения  
нет

---
loadFile(File file)  
Загружает программу затирания из выбранного пользователем файла  
Аргументы  
file — объект файла, выбранный через интерфейс загрузки  
Возвращает  
нет  
Исключения  
нет

---
set_program()  
Передаёт текущую программу затирания в управляющее устройство (например, контроллер Самовар)  
Аргументы  
нет  
Возвращает  
нет  
Исключения  
нет

---
validateMixerInput(HTMLInputElement* input)  
Проверяет корректность введённых значений времени включения и выключения мешалки  
Аргументы  
input — ссылка на HTML-элемент ввода (поле "Вкл сек" или "Выкл сек")  
Возвращает  
нет  
Исключения  
нет

---
class popup  
Модальное окно для редактирования параметров работы мешалки и насоса  
Поля  
m_type — тип устройства: 0 — выключено, 1 — мешалка, 2 — насос, 3 — мешалка и насос  
m_direction — направление вращения: -1 — реверс после паузы, 0 — прямое, 1 — обратное  
m_time — время включения в секундах (до 14400)  
m_pause — время выключения (паузы) в секундах (до 14400)  
Методы  
открытие — отображает модальное окно при редактировании строки программы с мешалкой  
применение параметров — формирует строку режима мешалки вида "1^-1.00^2^3" и вставляет в программу

---
Модуль предоставляет интерфейс для управления оборудованием дистилляции, включая настройку параметров насосов, выполнение Lua-скриптов и взаимодействие с внешними I2C-устройствами. Основные функции включают регулировку скорости насоса через ШИМ, отправку команд на I2C-насос и выполнение пользовательских скриптов. Интерфейс реализован в виде вкладок с формами и элементами ввода, обрабатываемыми через JavaScript.

Ключевые структуры данных  
PWM — ШИМ-сигнал для управления скоростью насоса, диапазон значений от %PWM_LV% до 1023  
i2c_speed — целевая скорость отбора для I2C-насоса в литрах в час  
i2c_volume — объем жидкости для отбора через I2C-насос в миллилитрах

---
validateMixerInput(element)  
Проверяет и валидирует введённое значение в поле ввода миксера  
Аргументы  
element — DOM-элемент поля ввода, значение которого подлежит проверке  
Возвращает  
void  
Исключения  
Нет

---
popup_cancel()  
Закрывает всплывающее окно без сохранения изменений  
Аргументы  
Нет  
Возвращает  
void  
Исключения  
Нет

---
popup_ok()  
Подтверждает изменения в всплывающем окне и применяет их  
Аргументы  
Нет  
Возвращает  
void  
Исключения  
Нет

---
sliderChange()  
Обновляет текстовое поле PWMt при изменении положения ползунка ШИМ  
Аргументы  
Нет  
Возвращает  
void  
Исключения  
Нет

---
changetxtpwm()  
Синхронизирует значение текстового поля PWMt с ползунком PWM  
Аргументы  
Нет  
Возвращает  
void  
Исключения  
Нет

---
run_strlua()  
Выполняет Lua-скрипт, введённый пользователем в поле lua_str_i  
Аргументы  
Нет  
Возвращает  
void  
Исключения  
Нет

---
sendI2CPump()  
Отправляет команду на запуск I2C-насоса с заданными скоростью и объёмом  
Аргументы  
Нет  
Возвращает  
void  
Исключения  
Нет

---
stopI2CPump()  
Останавливает работу I2C-насоса, отправляя команду остановки  
Аргументы  
Нет  
Возвращает  
void  
Исключения  
Нет
