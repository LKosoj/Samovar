# FS

Модуль реализует веб-интерфейс и WebSocket-обработку для управления устройством Samovar через встроенный веб-сервер на базе ESPAsyncWebServer. Обеспечивает взаимодействие с файловой системой SPIFFS, хранение конфигураций, обработку WebSocket-событий и отладочную печать. Включает функции форматирования данных, инициализации файловой системы и отправки сообщений. Предназначен для использования в системах автоматического контроля приготовления напитков.

Ключевые структуры данных  
MESSAGE_TYPE — перечисление типов сообщений, используемое в функции SendMsg

---
void onWsEvent(AsyncWebSocket *server, AsyncWebSocketClient *client, AwsEventType type, void *arg, uint8_t *data, size_t len)  
Обрабатывает входящие события WebSocket-соединения  
Аргументы  
server — указатель на WebSocket-сервер  
client — указатель на клиентское соединение  
type — тип события WebSocket  
arg — дополнительные данные события  
data — указатель на буфер с данными  
len — длина данных в буфере

---
String formatBytes(size_t bytes)  
Форматирует размер в байтах в человекочитаемую строку с единицами измерения (B, KB, MB, GB)  
Аргументы  
bytes — размер в байтах  
Возвращает  
Человекочитаемая строка с размером и единицей измерения

---
void FS_init(void)  
Инициализирует файловую систему SPIFFS, настраивает обработчики веб-сервера для событий, редактора SPIFFS и обработки 404

---
int get_liquid_volume()  
Возвращает текущий объём жидкости в ёмкости  
Возвращает  
Объём жидкости в условных единицах

---
inline String format_float(float v, int d)  
Форматирует число с плавающей точкой до заданного количества знаков после запятой  
Аргументы  
v — форматируемое число  
d — количество знаков после запятой  
Возвращает  
Строка с отформатированным числом

---
String get_program(uint8_t s)  
Возвращает строковое описание программы приготовления по её идентификатору  
Аргументы  
s — идентификатор программы  
Возвращает  
Описание программы в виде строки

---
String get_beer_program()  
Возвращает конфигурацию программы приготовления пива  
Возвращает  
Строка с параметрами программы пива

---
String get_dist_program()  
Возвращает конфигурацию программы дистилляции  
Возвращает  
Строка с параметрами программы дистилляции

---
String get_nbk_program()  
Возвращает конфигурацию программы приготовления НБК  
Возвращает  
Строка с параметрами программы НБК

---
void SendMsg(const String& m, MESSAGE_TYPE msg_type)  
Отправляет сообщение указанного типа в систему логирования или интерфейс пользователя  
Аргументы  
m — текст сообщения  
msg_type — тип сообщения

---
void read_config()  
Считывает конфигурацию устройства из энергонезависимой памяти (EEPROM или NVS)

---
String get_prf_name()  
Возвращает имя текущего профиля пользователя  
Возвращает  
Имя профиля в виде строки

---
void save_profile_nvs()  
Сохраняет текущий профиль пользователя в энергонезависимую память (NVS)

---
bool exists(String path)  
Проверяет существование файла по указанному пути в SPIFFS  
Аргументы  
path — путь к файлу  
Возвращает  
true, если файл существует и не является директорией; иначе false

---
void create_data()  
Инициализирует новый файл лога данных, сохраняет текущую программу в зависимости от режима, архивирует предыдущий лог  
Исключения  
Может выбрасывать ошибки при работе с SPIFFS (не обрабатываются напрямую)

---
String append_data()  
Добавляет новую строку данных в лог-файл, если изменились значения сенсоров или номер программы  
Возвращает  
Строку с записанными данными, если запись произведена; пустую строку, если данные не изменились  
Исключения  
Может выбрасывать ошибки при работе с SPIFFS (не обрабатываются напрямую)

---
void save_profile()  
Сохраняет текущий профиль в файл, имя которого определяется функцией get_prf_name()  
Исключения  
Может выбрасывать ошибки при открытии или записи файла в SPIFFS

---
class SamovarProfileManager  
Класс управления профилями настроек самовара  
Поля  
SamSetup — Глобальная структура параметров самовара, содержащая все настройки, сохраняемые в профиль  
Методы  
void save_profile() — Сохраняет текущий профиль настроек в файл SPIFFS, соответствующий режиму работы  
void load_profile() — Загружает профиль настроек из файла SPIFFS, соответствующего текущему режиму, или создает его, если файл отсутствует  
String get_prf_name() — Возвращает имя файла профиля в зависимости от текущего режима работы Samovar_CR_Mode
