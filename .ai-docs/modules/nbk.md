# nbk

Модуль управления процессом НБК (непрерывная барботажная колонна) обеспечивает автоматизированное выполнение технологического цикла: контроль температуры, подачи и мощности нагрева, обработку аварийных ситуаций (включая захлёб и перегрев), сбор статистики и взаимодействие с пользователем. Управление реализовано в виде конечного автомата, проходящего этапы — разгон, ручной режим, оптимизация и рабочий режим.

Ключевые структуры данных  
stats — Структура для хранения статистики текущей сессии НБК

struct stats  
Структура для хранения статистики текущей сессии НБК  
Поля  
avgSpeed — Средняя скорость подачи (л/ч)  
totalVolume — Суммарный объём перегоняемой жидкости (л)  
startTime — Время начала сессии (мс)  
lastVolumeUpdate — Время последнего обновления объёма (мс)

---
void reset_sensor_counter(void)  
Сбросить счётчик импульсов датчиков потока  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет

---
void nbk_finish()  
Завершить работу НБК: остановить нагрев и подачу, отправить финальную статистику  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет

---
void check_power_error()  
Проверить наличие ошибок питания и выполнить соответствующие действия (остановка, предупреждение)  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет

---
void set_power_mode(String Mode)  
Установить режим управления питанием  
Аргументы  
Mode — Режим питания в виде строки ("manual", "auto" и т.п.)  
Возвращает  
Нет  
Исключения  
Нет

---
void set_power(bool On)  
Включить или выключить питание нагревателя  
Аргументы  
On — true для включения, false для выключения  
Возвращает  
Нет  
Исключения  
Нет

---
void set_current_power(float Volt)  
Установить текущую мощность нагрева в ваттах  
Аргументы  
Volt — Мощность в ваттах  
Возвращает  
Нет  
Исключения  
Нет

---
void create_data()  
Создать файл для записи данных текущей сессии (температура, подача, объём и т.д.)  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет

---
void open_valve(bool Val, bool msg)  
Открыть или закрыть клапан подачи  
Аргументы  
Val — true для открытия, false для закрытия  
msg — true, чтобы отправить сообщение о действии  
Возвращает  
Нет  
Исключения  
Нет

---
void set_pump_pwm(float duty)  
Установить значение ШИМ для управления насосом  
Аргументы  
duty — Значение ШИМ (0.0 – 100.0 %)  
Возвращает  
Нет  
Исключения  
Нет

---
void set_pump_speed_pid(float temp)  
Установить скорость насоса на основе ПИД-регулирования по целевой температуре  
Аргументы  
temp — Целевая температура воды (°C)  
Возвращает  
Нет  
Исключения  
Нет

---
void SendMsg(const String& m, MESSAGE_TYPE msg_type)  
Отправить сообщение пользователю через доступные интерфейсы (MQTT, Serial, экран)  
Аргументы  
m — Текст сообщения  
msg_type — Тип сообщения (информационное, ошибка, предупреждение и т.д.)  
Возвращает  
Нет  
Исключения  
Нет

---
bool check_boiling()  
Проверить, достигнут ли режим кипячения (по температуре пара и другим критериям)  
Аргументы  
Нет  
Возвращает  
true, если идёт кипячение, иначе false  
Исключения  
Нет

---
void set_buzzer(bool fl)  
Включить или выключить звуковой сигнал (бuzzer)  
Аргументы  
fl — true для включения, false для выключения  
Возвращает  
Нет  
Исключения  
Нет

---
void set_water_temp(float duty)  
Установить целевую температуру воды в контуре охлаждения  
Аргументы  
duty — Целевая температура (°C)  
Возвращает  
Нет  
Исключения  
Нет

---
String getValue(const String& data, char separator, int index)  
Извлечь подстроку по индексу из строки, разделённой заданным символом  
Аргументы  
data — Исходная строка  
separator — Разделитель (например, ',')  
index — Индекс требуемого значения (начиная с 0)  
Возвращает  
Значение как строка, или пустая строка, если индекс вне диапазона  
Исключения  
Нет

---
void run_nbk_program(uint8_t num)  
Запустить выполнение строки программы НБК с указанным номером  
Аргументы  
num — Номер строки программы (этапа)  
Возвращает  
Нет  
Исключения  
Нет

---
bool set_stepper_target(uint16_t spd, uint8_t direction, uint32_t target)  
Установить целевую позицию и параметры движения шагового двигателя  
Аргументы  
spd — Скорость движения (шаги/с)  
direction — Направление (0 — обратно, 1 — вперёд)  
target — Целевое количество шагов  
Возвращает  
true, если команда принята, иначе false  
Исключения  
Нет

---
float i2c_get_liquid_rate_by_step(int StepperSpeed)  
Рассчитать расход жидкости (л/ч) по текущей скорости шагового двигателя  
Аргументы  
StepperSpeed — Скорость шагового двигателя (шаги/с)  
Возвращает  
Расход жидкости в литрах в час  
Исключения  
Нет

---
float i2c_get_speed_from_rate(float volume_per_hour)  
Рассчитать требуемую скорость шагового двигателя по заданному расходу  
Аргументы  
volume_per_hour — Желаемый расход (л/ч)  
Возвращает  
Скорость шагового двигателя (шаги/с)  
Исключения  
Нет

---
float i2c_get_liquid_volume()  
Получить текущий суммарный объём перекачанной жидкости  
Аргументы  
Нет  
Возвращает  
Объём в литрах  
Исключения  
Нет

---
uint16_t get_stepper_speed(void)  
Получить текущую скорость шагового двигателя  
Аргументы  
Нет  
Возвращает  
Текущая скорость (шаги/с)  
Исключения  
Нет

---
void send_mqtt(const String& Str, const String& chart)  
Отправить данные в MQTT-брокер  
Аргументы  
Str — Передаваемая строка данных  
chart — Канал или тип данных (например, "temp", "power")  
Возвращает  
Нет  
Исключения  
Нет

---
void nbk_proc()  
Основной цикл обработки НБК: управление этапами и проверка критических аварий  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет

---
void handle_nbk_stage_heatup()  
Обработать этап разгона (H): нагрев до рабочих температур, контроль перехода к следующему этапу  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет

---
void handle_nbk_stage_manual()  
Обработать этап ручной настройки (S): контроль параметров, защита от захлёба, ожидание подтверждения  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет

---
void handle_nbk_stage_optimization()  
Обработать этап оптимизации (O): автоматическая подстройка параметров подачи и мощности  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет

---
void handle_nbk_stage_work()  
Обработать рабочий этап (W): стабилизация процесса, ПИД-регулирование, контроль захлёба  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет

---
bool check_nbk_critical_alarms()  
Проверить критические аварии: перегрев, недостаток охлаждения, высокое давление  
Аргументы  
Нет  
Возвращает  
true, если сработала авария и процесс был остановлен  
Исключения  
Нет

---
void handle_overflow(const String& msg, bool finish, uint32_t pause_ms)  
Централизованная обработка события захлёба  
Аргументы  
msg — Сообщение для пользователя  
finish — true для завершения процесса, false — для временной паузы  
pause_ms — Длительность паузы в миллисекундах (если используется)  
Возвращает  
Нет  
Исключения  
Нет

---
String get_nbk_program()  
Получить текущую программу НБК в виде строки (например, "H100,S50,O,W")  
Аргументы  
Нет  
Возвращает  
Текстовое представление программы  
Исключения  
Нет
