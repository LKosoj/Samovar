# Samovar

Модуль управления самоваром на базе ESP32 с поддержкой PID-регулирования, веб-интерфейса и различных датчиков. Обеспечивает управление нагревом, уровнем жидкости, давлением и другими параметрами в системе самовара. Поддерживается асинхронный веб-сервер, локальное управление через энкодер и LCD, а также удалённый мониторинг и настройка через WebSocket и mDNS. Используются семафоры для синхронизации задач.

Ключевые структуры данных  
SetupEEPROM — Структура хранения настроек устройства в энергонезависимой памяти, включая калибровки датчиков, уставки температур, параметры реле, цветовую индикацию, настройки PID и сетевые параметры

---
SamovarCommands sam_command_sync  
Глобальная переменная для синхронизации команд между задачами или прерываниями  
Аргументы  
sam_command_sync — Переменная, содержащая команду (например, запуск, остановка, калибровка), переданную из интерфейса или кнопок  
Возвращает  
Текущее значение команды (перечисление SamovarCommands)  
Исключения  
Нет

---
SAMOVAR_MODE Samovar_Mode  
Текущий режим работы самовара (ректификация, дистилляция, пиво и др.)  
Аргументы  
Samovar_Mode — Переменная, определяющая активный режим работы устройства  
Возвращает  
Текущий режим (значение из перечисления SAMOVAR_MODE)  
Исключения  
Нет

---
MESSAGE_TYPE msg_type  
Тип отображаемого сообщения (тревога, предупреждение, уведомление)  
Аргументы  
msg_type — Тип сообщения, выводимого на дисплей или в интерфейс  
Возвращает  
Текущий тип сообщения  
Исключения  
Нет

---
class SetupEEPROM  
Контейнер параметров настройки устройства, сохраняемый в EEPROM  
Поля  
flag — Флаг инициализации/записи в EEPROM  
DeltaSteamTemp — Коррекция температуры пара  
DeltaPipeTemp — Коррекция температуры трубопровода  
DeltaWaterTemp — Коррекция температуры воды  
DeltaTankTemp — Коррекция температуры ёмкости  
StepperStepMl — Количество шагов двигателя на миллилитр жидкости  
SetSteamTemp — Уставка температуры пара  
SetPipeTemp — Уставка температуры трубопровода  
SetWaterTemp — Уставка температуры воды  
SetTankTemp — Уставка температуры ёмкости  
UsePreccureCorrect — Флаг использования коррекции температуры по давлению  
SteamDelay — Задержка включения насоса при превышении температуры пара  
PipeDelay — Задержка включения насоса при превышении температуры трубопровода  
WaterDelay — Задержка включения насоса при превышении температуры воды  
TankDelay — Задержка включения насоса при превышении температуры ёмкости  
TimeZone — Часовой пояс устройства  
HeaterResistant — Сопротивление нагревателя для расчёта мощности  
LogPeriod — Период логирования данных в файл (в секундах)  
SteamColor — Цвет отображения температуры пара в интерфейсе  
PipeColor — Цвет отображения температуры трубопровода  
WaterColor — Цвет отображения температуры воды  
TankColor — Цвет отображения температуры ёмкости  
rele1 — Логический уровень управления реле 1  
rele2 — Логический уровень управления реле 2  
rele3 — Логический уровень управления реле 3  
rele4 — Логический уровень управления реле 4  
SteamAdress — Адрес датчика температуры пара  
PipeAdress — Адрес датчика температуры трубопровода  
WaterAdress — Адрес датчика температуры воды  
TankAdress — Адрес датчика температуры ёмкости  
useautospeed — Включение автоматической коррекции скорости отбора  
useDetectorOnHeads — Разрешение детектора голов  
autospeed — Процент изменения скорости при автокоррекции  
blynkauth — Авторизационный токен Blynk  
videourl — URL видеопотока с камеры  
DistTemp — Температура завершения дистилляции  
Mode — Режим работы самовара (устаревшее, дублирует Samovar_Mode)  
ACPAdress — Адрес датчика температуры дополнительной точки  
ACPColor — Цвет отображения дополнительной температуры  
DeltaACPTemp — Коррекция температуры дополнительной точки  
SetACPTemp — Уставка температуры дополнительной точки  
ACPDelay — Задержка включения насоса по дополнительной температуре  
Version — Версия структуры для контроля совместимости  
Kp — Коэффициент пропорционального усиления PID-регулятора  
Ki — Коэффициент интегрального усиления PID-регулятора  
Kd — Коэффициент дифференциального усиления PID-регулятора  
StbVoltage — Напряжение в режиме поддержания температуры  
ChangeProgramBuzzer — Флаг: включать пищалку при смене программы  
UseBuzzer — Флаг: использовать пищалку  
CheckPower — Флаг: контролировать выходное напряжение  
UseBBuzzer — Флаг: использовать пищалку в браузере  
UseWS — Флаг: использовать датчик протока воды  
BVolt — Напряжение/мощность в режиме кипения  
UseST — Флаг: использовать разгонный ТЭН в режиме кипения  
DistTimeF — Время контроля завершения дистилляции (в минутах)  
UseHLS — Флаг: использовать датчик флегмы  
MaxPressureValue — Максимальное давление для аварийного отключения  
tg_token — Токен Telegram-бота (до 50 символов)  
tg_chat_id — ID чата Telegram (до 14 символов)  
NbkIn — Параметр инерции  
NbkDelta — Температурный гистерезис  
NbkDM — Шаг изменения мощности  
NbkDP — Шаг изменения подачи  
NbkSteamT — Уставка температуры пара  
NbkOwPress — Давление захлёба  
ColDiam — Внутренний диаметр колонны (в дюймах)  
ColHeight — Высота насадки (в метрах)  
PackDens — Плотность упаковки насадки (%)  
StepperStepMlI2C — Количество шагов I2C шагового двигателя на 1 мл жидкости  
Методы  
Нет

---
class ImpurityDetector  
Анализ чистоты дистиллята по изменению температуры в конденсаторе  
Поля  
tempHistory — Кольцевой буфер температур (30 значений, 1 раз в 2 сек)  
historyIndex — Текущий индекс записи в буфере  
historySize — Количество заполненных элементов в буфере  
lastSampleTime — Время последнего измерения (мс)  
currentTrend — Текущий тренд изменения температуры (°C/мин)  
detectorStatus — Статус детектора: 0=Stable, 1=Correction, 2=Breakthrough  
correctionFactor — Коэффициент коррекции скорости отбора (0.7–1.0)  
lastCorrectionTime — Время последней корректировки скорости  
tempStdDev — Стандартное отклонение температуры за период  
consecutiveRises — Счётчик последовательных ростов температуры  
lastTemp — Последняя зарегистрированная температура  
Методы  
Нет

---
class DSSensor  
Инкапсуляция данных датчика температуры DS18B20  
Поля  
Sensor — Адрес датчика на шине One-Wire  
avgTemp — Средняя температура, измеренная датчиком  
SetTemp — Уставка температуры для реакции системы  
BodyTemp — Температура начала отбора тела  
Delay — Задержка включения насоса (в секундах) при превышении уставки  
PrevTemp — Предыдущее значение температуры  
Start_Pressure — Давление в начале отбора  
ErrCount — Счётчик ошибок чтения датчика  
LogPrevTemp — Предыдущая температура для логирования  
StartProgTemp — Температура в начале выполнения строки программы  
Методы  
Нет

---
class WProgram  
Описание строки программы отбора фракции  
Поля  
WType — Тип фракции: "Головы", "Тело" и т.п.  
Volume — Объём отбора в мл  
Speed — Скорость отбора в л/ч  
capacity_num — Номер ёмкости для отбора  
Temp — Температура отбора (0 — автоматически)  
Power — Мощность (напряжение) при отборе  
TempSensor — Номер датчика, используемого для контроля нагрева  
Time — Расчётное время отбора (в минутах)  
Методы  
Нет

---
bool load_wifi_credentials(char *ssid, size_t ssid_len, char *pass, size_t pass_len)  
Загружает Wi-Fi учётные данные из энергонезависимой памяти  
Аргументы  
ssid — Буфер для сохранения имени сети (SSID)  
ssid_len — Максимальный размер буфера SSID  
pass — Буфер для сохранения пароля  
pass_len — Максимальный размер буфера пароля  
Возвращает  
true — если учётные данные успешно загружены, иначе false  
Исключения  
Нет

---
String get_wifi_ssid()  
Возвращает текущее имя Wi-Fi сети  
Аргументы  
Нет  
Возвращает  
Имя Wi-Fi сети (SSID) в виде строки  
Исключения  
Нет

---
void save_wifi_credentials(const char *ssid, const char *pass)  
Сохраняет учётные данные Wi-Fi в энергонезависимую память  
Аргументы  
ssid — Имя сети (не должно быть null)  
pass — Пароль сети (может быть пустым)  
Возвращает  
Нет  
Исключения  
Нет

---
void clear_wifi_credentials()  
Очищает сохранённые учётные данные Wi-Fi  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет

---
void stop_process(String reason)  
Останавливает текущий технологический процесс  
Аргументы  
reason — Причина остановки, будет отображена в интерфейсе и логе  
Возвращает  
Нет  
Исключения  
Нет

---
#ifdef USE_MQTT  
void MqttSendMsg(const String &Str, const char *chart, int version)  
Отправляет сообщение через MQTT для отображения на внешних графиках  
Аргументы  
Str — Текст сообщения или значение для передачи  
chart — Название графика или топика в MQTT  
version — Версия формата сообщения (по умолчанию 3)  
Возвращает  
Нет  
Исключения  
Нет  
#endif
