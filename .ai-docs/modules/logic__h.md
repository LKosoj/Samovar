# logic

Модуль управления логикой работы самоварной установки с поддержкой дистанционного мониторинга, автоматического отбора фракций и защиты по температуре/давлению.  
Модуль реализует основную логику управления процессом дистилляции: автоматический отбор фракций, контроль температуры и давления, обработку программ отбора, взаимодействие с шаговым двигателем, насосом и датчиками. Поддерживает интеграцию с Blynk (опционально) и детектирование примесей. Обеспечивает аварийное отключение при критических отклонениях параметров.

Ключевые структуры данных  
SamSetup — Глобальная структура настроек самовара (шаги на мл, режимы работы и т.д.)  
SteamSensor — Структура данных датчика пара (температура, давление, стартовые значения)  
program — Массив программных шагов отбора с указанием типа фракции, температуры и объема  
stepper — Объект управления шаговым двигателем (позиция, скорость, цель)

---
void save_profile()  
Сохраняет текущий профиль настроек в энергонезависимую память.  
Аргументы  
Возвращает  
Исключения

---
void menu_samovar_start()  
Инициирует переход к следующему этапу программы отбора или останавливает процесс.  
Аргументы  
Возвращает  
Исключения

---
void set_menu_screen(uint8_t param)  
Устанавливает активный экран интерфейса в зависимости от переданного параметра.  
Аргументы  
param — Код экрана для отображения  
Возвращает  
Исключения

---
void samovar_reset()  
Выполняет полный сброс состояния самовара: останавливает все процессы, сбрасывает флаги, обнуляет счётчики.  
Аргументы  
Возвращает  
Исключения

---
void create_data()  
Формирует и обновляет данные для отображения и передачи (температура, объём, статус и т.п.).  
Аргументы  
Возвращает  
Исключения

---
void pause_withdrawal(bool Pause)  
Приостанавливает или возобновляет процесс отбора с сохранением состояния.  
Аргументы  
Pause — true для паузы, false для возобновления  
Возвращает  
Исключения

---
void read_config()  
Считывает конфигурацию самовара из энергонезависимой памяти и применяет настройки.  
Аргументы  
Возвращает  
Исключения

---
String format_float(float v, int d)  
Форматирует число с плавающей точкой до заданного количества знаков после запятой.  
Аргументы  
v — Значение для форматирования  
d — Количество знаков после запятой  
Возвращает  
Отформатированная строка с числом  
Исключения

---
float get_temp_by_pressure(float start_pressure, float start_temp, float current_pressure)  
Корректирует температуру кипения с учетом изменения атмосферного давления.  
Аргументы  
start_pressure — Начальное давление (в гПа)  
start_temp — Начальная температура кипения (в °C)  
current_pressure — Текущее давление (в гПа)  
Возвращает  
Скорректированная температура кипения при текущем давлении  
Исключения

---
unsigned int hexToDec(String hexString)  
Преобразует шестнадцатеричную строку в десятичное целое число.  
Аргументы  
hexString — Строка в шестнадцатеричном формате  
Возвращает  
Десятичное значение  
Исключения

---
void set_current_power(float Volt)  
Устанавливает текущее напряжение питания и регулирует мощность нагрева.  
Аргументы  
Volt — Напряжение в вольтах  
Возвращает  
Исключения

---
void set_power_mode(String Mode)  
Переключает режим управления мощностью (например, "PID", "PWM", "ручной").  
Аргументы  
Mode — Строка, определяющая режим работы  
Возвращает  
Исключения

---
void open_valve(bool Val, bool msg)  
Открывает или закрывает клапан отбора, при необходимости отправляя уведомление.  
Аргументы  
Val — true для открытия, false для закрытия  
msg — true для отправки сообщения о действии  
Возвращает  
Исключения

---
void stopService(void)  
Останавливает все активные сервисы: насос, клапан, шаговик, нагрев.  
Аргументы  
Возвращает  
Исключения

---
void startService(void)  
Возобновляет работу сервисов после остановки (например, после паузы).  
Аргументы  
Возвращает  
Исключения

---
void reset_sensor_counter(void)  
Сбрасывает счётчики импульсов датчиков (например, шагов шагового двигателя).  
Аргументы  
Возвращает  
Исключения

---
void set_pump_speed(float pumpspeed, bool continue_process)  
Устанавливает скорость насоса в мл/час и запускает процесс отбора.  
Аргументы  
pumpspeed — Скорость подачи в мл/час  
continue_process — Флаг продолжения технологического процесса  
Возвращает  
Исключения

---
void set_pump_pwm(float duty)  
Устанавливает скважность ШИМ для управления скоростью насоса напрямую.  
Аргументы  
duty — Значение скважности от 0 до 255  
Возвращает  
Исключения

---
void set_pump_speed_pid(float temp)  
Регулирует скорость насоса по алгоритму PID на основе текущей температуры.  
Аргументы  
temp — Текущая температура пара  
Возвращает  
Исключения

---
void set_power(bool On)  
Включает или выключает подачу мощности на нагревательный элемент.  
Аргументы  
On — true для включения, false для выключения  
Возвращает  
Исключения

---
void set_body_temp()  
Корректирует установленную температуру отбора тела на основе текущих данных с датчиков.  
Аргументы  
Возвращает  
Исключения

---
void set_buzzer(bool fl)  
Включает или выключает звуковой сигнал (пищалку).  
Аргументы  
fl — true для включения, false для выключения  
Возвращает  
Исключения

---
void start_self_test(void)  
Запускает процедуру самодиагностики всех подключенных узлов и датчиков.  
Аргументы  
Возвращает  
Исключения

---
void stop_self_test(void)  
Прерывает выполнение самодиагностики.  
Аргументы  
Возвращает  
Исключения

---
bool check_boiling()  
Проверяет, начался ли процесс кипения по скорости роста температуры.  
Аргументы  
Возвращает  
true, если кипение обнаружено, иначе false  
Исключения

---
float get_alcohol(float t)  
Оценивает крепость дистиллята по температуре пара (приближённая модель).  
Аргументы  
t — Температура пара в °C  
Возвращает  
Оценка крепости в % об.  
Исключения

---
void set_boiling()  
Фиксирует момент начала кипения и инициализирует связанные параметры (давление, температуру старта).  
Аргументы  
Возвращает  
Исключения

---
bool set_stepper_target(uint16_t spd, uint8_t direction, uint32_t target)  
Устанавливает целевую позицию и скорость для шагового двигателя.  
Аргументы  
spd — Скорость движения в шагах в секунду  
direction — Направление (0 — обратно, 1 — вперёд)  
target — Целевое количество шагов  
Возвращает  
true при успешной установке цели, иначе false  
Исключения

---
float get_dist_remaining_time()  
Рассчитывает оставшееся время отбора текущей фракции в минутах.  
Аргументы  
Возвращает  
Оставшееся время в минутах  
Исключения

---
float get_dist_predicted_total_time()  
Прогнозирует общее время завершения текущей программы отбора.  
Аргументы  
Возвращает  
Прогнозируемое время в минутах  
Исключения

---
void detector_on_program_start(const String& wtype)  
Инициализирует детектор примесей при старте программы отбора заданной фракции.  
Аргументы  
wtype — Тип фракции ("H", "B", "C", "P" и т.д.)  
Возвращает  
Исключения

---
void detector_on_auto_resume()  
Обрабатывает возобновление отбора после автоматической паузы (например, при перегреве).  
Аргументы  
Возвращает  
Исключения

---
void detector_on_manual_resume()  
Обрабатывает возобновление отбора вручную после паузы.  
Аргументы  
Возвращает  
Исключения

---
void check_power_error()  
Проверяет наличие ошибок в цепи питания (напряжение, ток, перегрузка).  
Аргументы  
Возвращает  
Исключения

---
bool column_wetting()  
Выполняет процедуру смачивания колонны перед началом ректификации.  
Аргументы  
Возвращает  
true при успешном завершении, иначе false  
Исключения

---
void SendMsg(const String &m, MESSAGE_TYPE msg_type)  
Отправляет сообщение указанного типа на дисплей и/или в удалённый интерфейс (Blynk).  
Аргументы  
m — Текст сообщения  
msg_type — Тип сообщения (ALARM_MSG, INFO_MSG и др.)  
Возвращает  
Исключения

---
uint8_t getDelimCount(const String& data, char separator)  
Подсчитывает количество вхождений указанного разделителя в строке.  
Аргументы  
data — Входная строка  
separator — Символ-разделитель  
Возвращает  
Количество найденных разделителей  
Исключения

---
String getValue(const String& data, char separator, int index)  
Извлекает подстроку по индексу, используя указанный разделитель.  
Аргументы  
data — Исходная строка  
separator — Символ-разделитель  
index — Индекс требуемой части  
Возвращает  
Извлеченная подстрока  
Исключения

---
float get_liquid_volume_by_step(float StepCount)  
Переводит количество шагов шагового двигателя в объём жидкости в мл.  
Аргументы  
StepCount — Количество шагов  
Возвращает  
Объём жидкости в мл  
Исключения

---
float get_liquid_rate_by_step(int StepperSpeed)  
Преобразует скорость шаговика в расход жидкости в мл/час.  
Аргументы  
StepperSpeed — Скорость шагового двигателя в шагах/сек  
Возвращает  
Расход в мл/час  
Исключения

---
float get_speed_from_rate(float volume_per_hour)  
Переводит требуемый расход (мл/час) в скорость шаговика (шаги/сек).  
Аргументы  
volume_per_hour — Требуемый расход в мл/час  
Возвращает  
Скорость шаговика в шагах/сек (не менее 1)  
Исключения

---
int get_liquid_volume()  
Возвращает текущий объём отобранной жидкости в мл.  
Аргументы  
Возвращает  
Объём в мл  
Исключения

---
void set_alarm()  
Активирует аварийное отключение: останавливает нагрев, насос, клапан, отправляет тревогу.  
Аргументы  
Возвращает  
Исключения

---
void withdrawal(void)  
Основная функция управления процессом отбора: контроль температуры, фракций, пауз, детектора.  
Аргументы  
Возвращает  
Исключения

---
void vTaskControl(void *pvParameters)  
Управляет автоматическими паузами отбора по температуре паров, царги и детектору примесей.  
Аргументы  
pvParameters — параметры задачи FreeRTOS (не используются)  
Возвращает  
Ничего не возвращает, работает как бесконечный цикл в фоновом потоке  
Исключения  
Нет

---
void pump_calibrate(int stpspeed)  
Выполняет калибровку шагового насоса по заданной скорости и измеренному объему.  
Аргументы  
stpspeed — скорость шагов двигателя, при которой проводится калибровка  
Возвращает  
Ничего не возвращает  
Исключения  
Нет

---
void start_process()  
Запускает процесс отбора или разогрева в зависимости от текущего режима и состояния системы.  
Аргументы  
Возвращает  
Исключения

---
float getBeerCurrentTemp()  
Возвращает текущую температуру с выбранного датчика в режиме пивоварения.  
Аргументы  
Возвращает  
Текущая температура с датчика, указанного в программе, или 0, если режим не активен  
Исключения

---
void stop_process(String reason)  
Останавливает текущий процесс, отключает питание и отправляет уведомление с указанием причины.  
Аргументы  
reason — текстовое описание причины остановки  
Возвращает  
Исключения

---
String get_Samovar_Status()  
Формирует строковое описание текущего статуса устройства для внешнего отображения.  
Аргументы  
Возвращает  
Строка с описанием текущего состояния Самовара  
Исключения

---
String get_samovar_status()  
Формирует строку статуса самовара с учётом текущего режима, температуры, прогресса и других параметров.  
Аргументы  
Возвращает  
Строка с описанием текущего состояния системы  
Исключения

---
void set_capacity(uint8_t cap)  
Устанавливает текущую ёмкость и, при наличии сервопривода, поворачивает его в соответствующее положение.  
Аргументы  
cap — номер ёмкости (0..CAPACITY_NUM-1)  
Возвращает  
Исключения

---
void next_capacity(void)  
Переключается на следующую по номеру ёмкость с учётом цикличности.  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения

---
void set_program(String WProgram)  
Разбирает строку с программой и заполняет массив этапов (program), вычисляя время выполнения каждого этапа.  
Аргументы  
WProgram — строка формата "Тип;Объём;Скорость;Ёмкость;Температура;Мощность", разделённая точкой с запятой  
Возвращает  
Исключения

---
String get_program(uint8_t s)  
Возвращает строковое представление одного или всех этапов программы в формате, пригодном для передачи.  
Аргументы  
s — начальный индекс этапа (0..CAPACITY_NUM*2); если равно CAPACITY_NUM*2 — возвращает все этапы  
Возвращает  
Строка с данными программы, разделёнными символами перевода строки и точкой с запятой  
Исключения

---
void run_program(uint8_t num)  
Запускает выполнение программы с заданным номером, с проверкой необходимости сброса детектора при смене типа этапа.  
Аргументы  
num — номер этапа программы (0..29)  
Возвращает  
Исключения  
Нет

---
class SteamSensor  
Хранит параметры датчика пара: температуру тела, начальное давление и рассчитывает температуру по давлению.  
Поля  
BodyTemp — температура тела датчика пара (°C)  
Start_Pressure — начальное давление (Па)  
Методы

---
class PipeSensor  
Хранит параметры датчика царги: температуру тела.  
Поля  
BodyTemp — температура тела датчика царги (°C)  
Методы

---
float get_temp_by_pressure(float start_pressure, float body_temp, float current_pressure)  
Рассчитывает температуру пара по текущему давлению с использованием эмпирической модели.  
Аргументы  
start_pressure — начальное давление при калибровке (Па)  
body_temp — температура датчика (°C)  
current_pressure — текущее измеренное давление (Па)  
Возвращает  
Рассчитанная температура пара (°C)  
Исключения

---
String format_float(float value, int decimals)  
Форматирует число с плавающей точкой в строку с заданным количеством знаков после запятой.  
Аргументы  
value — число для форматирования  
decimals — количество знаков после запятой  
Возвращает  
Строка с отформатированным числом  
Исключения

---
void start_program(uint8_t num)  
Запускает программу отбора по заданному индексу с проверкой необходимости сброса детектора и инициализацией параметров.  
Аргументы  
num — индекс программы в массиве program; если равен CAPACITY_NUM * 2, процесс завершается.  
Возвращает  
Ничего не возвращает.  
Исключения  
Нет

---
void reset_impurity_detector()  
Сбрасывает состояние детектора примесей, инициализируя его заново для корректной работы на новом этапе отбора.  
Аргументы  
Нет аргументов.  
Возвращает  
Ничего не возвращает.  
Исключения  
Нет

---
void detector_on_program_start(String wtype)  
Активирует детектор примесей в зависимости от типа текущей программы отбора (например, для "B" или "C").  
Аргументы  
wtype — строка, указывающая тип программы ("B", "C" и т.д.).  
Возвращает  
Ничего не возвращает.  
Исключения  
Нет

---
float get_boiling_temperature(float start_temp, float start_pressure, float i_temp)  
Возвращает скорректированную температуру кипения с учётом давления и поправок.  
Аргументы  
start_temp — начальная температура, °C  
start_pressure — начальное давление, гПа  
i_temp — текущая измеренная температура, °C  
Возвращает  
Скорректированная температура кипения, °C  
Исключения

---
void check_alarm()  
Основная функция мониторинга и реакции на аварийные ситуации: захлёб, перегрев, уровень воды, управление нагревом и клапанами.  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения

---
void set_pump_speed_pid(float target_temp)  
Устанавливает скорость насоса охлаждения по алгоритму PID в зависимости от целевой температуры.  
Аргументы  
target_temp — целевая температура воды для регулирования  
Возвращает  
Нет  
Исключения  
Нет

---
void process_buzzer()  
Обрабатывает циклическое включение и выключение пищалки по расписанию.  
Аргументы  
Нет  
Возвращает  
Ничего не возвращает  
Исключения  
Нет

---
float get_steam_alcohol(float t)  
Рассчитывает концентрацию алкоголя в паре на основе текущей температуры и давления.  
Аргументы  
t — текущая температура в градусах Цельсия  
Возвращает  
Концентрацию алкоголя в процентах (0–100) или 100, если кипение не начато  
Исключения  
Нет

---
float get_temp_by_pressure(int sensor_id, float t, float p)  
Возвращает температуру, скорректированную по давлению.  
Аргументы  
sensor_id — идентификатор датчика (не используется в текущей реализации)  
t — измеренная температура, °C  
p — текущее атмосферное давление, гПа  
Возвращает  
Скорректированная температура кипения с учётом давления, °C  
Исключения

---
void triggerPowerStatus(void *parameter)  
Фоновая задача FreeRTOS: опрашивает регулятор мощности через Serial2 и обновляет данные о напряжении и режиме.  
Аргументы  
parameter — указатель на параметры задачи (не используется)  
Возвращает  
Исключения

---
void get_current_power()  
Вычисляет текущую мощность нагревателя на основе измеренного напряжения и сопротивления, указанного в настройках.  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения

---
bool handle_wetting_process()  
Проверяет состояние датчика и управляет выполнением процесса смачивания.  
Аргументы  
Отсутствуют  
Возвращает  
true — если процесс смачивания завершён или невозможен; false — если процесс продолжается  
Исключения  
Отсутствуют

---
void reset_wetting_state()  
Сбрасывает текущее состояние процесса смачивания в начальное или безопасное значение.  
Аргументы  
Отсутствуют  
Возвращает  
Отсутствует  
Исключения  
Отсутствуют

---
void SendMsg(const char* message, uint8_t msg_type)  
Отправляет сообщение в систему логирования или интерфейс пользователя.  
Аргументы  
message — текст сообщения для вывода  
msg_type — тип сообщения (например, WARNING_MSG, INFO_MSG)  
Возвращает  
Отсутствует  
Исключения  
Отсутствуют
