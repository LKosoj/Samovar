# I2CStepper

Модуль управления шаговым двигателем по шине I2C.  
Предоставляет функции для управления шаговым двигателем через I2C-интерфейс, а также поддерживает локальное управление при отсутствии внешнего устройства. Реализована работа с объёмом жидкости, скоростью подачи и конвертация между шагами и объёмом. Управление синхронизировано через семафор для безопасного доступа к шине I2C в многозадачной среде.

Ключевые структуры данных  
SamSetup — глобальная структура настроек устройства, содержащая параметр StepperStepMlI2C (шагов на миллилитр для I2C-двигателя)  
xI2CSemaphore — Семафор FreeRTOS для синхронизации доступа к I2C-шине  
use_I2C_dev — Адрес I2C-устройства, управляемого через модуль

---
void stopService(void)  
Останавливает выполнение сервиса управления двигателем

---
void startService(void)  
Запускает сервис управления двигателем

---
bool set_stepper_target(uint16_t spd, uint8_t direction, uint32_t target)  
Устанавливает целевую скорость, направление и количество шагов для двигателя  
Аргументы  
spd — скорость в шагах в секунду  
direction — направление движения (0 — обратное, 1 — прямое)  
target — целевое количество шагов  
Возвращает  
true при успешной установке, false в случае ошибки (например, таймаут семафора)  
Исключения  
Нет

---
uint16_t get_stepper_speed(void)  
Возвращает текущую скорость двигателя в шагах в секунду  
Возвращает  
Текущая скорость в шагах в секунду; 0xFFFF при ошибке чтения  
Исключения  
Нет

---
float get_liquid_volume_by_step(float StepCount)  
Переводит количество шагов в объём жидкости в миллилитрах (локальная версия)  
Аргументы  
StepCount — количество шагов  
Возвращает  
Объём жидкости в мл  
Исключения  
Нет

---
float get_liquid_rate_by_step(int StepperSpeed)  
Переводит скорость двигателя в расход жидкости в мл/час (локальная версия)  
Аргументы  
StepperSpeed — скорость двигателя в шагах в секунду  
Возвращает  
Расход жидкости в мл/час  
Исключения  
Нет

---
float get_speed_from_rate(float volume_per_hour)  
Переводит требуемый расход жидкости в скорость двигателя в шагах в секунду (локальная версия)  
Аргументы  
volume_per_hour — расход жидкости в мл/час  
Возвращает  
Скорость двигателя в шагах в секунду (не менее 1)  
Исключения  
Нет

---
uint8_t check_I2C_device(uint8_t address)  
Проверяет наличие устройства на шине I2C по указанному адресу  
Аргументы  
address — I2C-адрес устройства  
Возвращает  
Адрес устройства при успехе, 0 при отсутствии ACK, 255 при таймауте семафора  
Исключения  
Нет

---
bool set_stepper_by_time(uint16_t spd, uint8_t direction, uint16_t time)  
Запускает двигатель на заданное время с указанной скоростью  
Аргументы  
spd — скорость в оборотах в минуту  
direction — направление движения  
time — время работы в секундах  
Возвращает  
true при успехе, false при ошибке или отключённом I2C  
Исключения  
Нет

---
float i2c_get_liquid_volume_by_step(int StepCount)  
Переводит количество шагов в объём жидкости с учётом настроек I2C-двигателя  
Аргументы  
StepCount — количество шагов  
Возвращает  
Объём жидкости в мл  
Исключения  
Нет

---
float i2c_get_liquid_rate_by_step(int StepperSpeed)  
Переводит скорость двигателя в расход жидкости в мл/час (I2C-версия)  
Аргументы  
StepperSpeed — скорость двигателя в шагах в секунду  
Возвращает  
Расход жидкости в мл/час  
Исключения  
Нет

---
float i2c_get_speed_from_rate(float volume_per_hour)  
Переводит расход жидкости в скорость двигателя в шагах в секунду (I2C-версия)  
Аргументы  
volume_per_hour — расход жидкости в мл/час  
Возвращает  
Скорость двигателя в шагах в секунду (не менее 1)  
Исключения  
Нет

---
float i2c_get_liquid_volume(void)  
Возвращает текущий объём жидкости, соответствующий текущей скорости двигателя  
Возвращает  
Объём жидкости в мл  
Исключения  
Нет

---
uint32_t get_stepper_status(void)  
Возвращает текущее значение оставшихся шагов до достижения цели  
Возвращает  
Оставшееся количество шагов; 0xFFFFFFFF при ошибке чтения  
Исключения  
Нет

---
uint8_t get_i2c_rele_state(uint8_t r)  
Возвращает состояние указанного реле (1 или 0)  
Аргументы  
r — Номер реле (1–8)  
Возвращает  
Состояние реле (0 или 1); 0xFF при ошибке или отсутствии устройства  
Исключения  
Нет

---
bool set_i2c_rele_state(uint8_t r, bool s)  
Устанавливает состояние указанного реле  
Аргументы  
r — Номер реле (1–8)  
s — Желаемое состояние (true — включено, false — выключено)  
Возвращает  
true при успешной установке, false при ошибке или отсутствии устройства  
Исключения  
Нет

---
bool set_mixer_pump_target(uint8_t on)  
Включает или выключает насос через реле  
Аргументы  
on — Состояние насоса (ненулевое значение — включить, 0 — выключить)  
Возвращает  
true при успешной установке, false при ошибке или отсутствии устройства  
Исключения  
Нет

---
uint8_t get_mixer_pump_status(void)  
Читает текущее состояние насоса (включён/выключен)  
Возвращает  
Состояние насоса (0 или 1); 0xFF при ошибке или отсутствии устройства  
Исключения  
Нет
