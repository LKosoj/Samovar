# I2CStepper

/**
 * @brief Модуль управления шаговым двигателем и реле по шине I2C.
 *
 * Данный модуль предоставляет функции для управления шаговым двигателем через I2C-интерфейс,
 * включая установку скорости, направления и целевого количества шагов. Поддерживается работа
 * как с внешним I2C-драйвером двигателя, так и с локальным (на базе Arduino). Также реализованы
 * функции перевода шагов в объём жидкости и скорости потока. Дополнительно модуль обеспечивает
 * управление реле и насосом смесителя через I2C-устройство с использованием семафора для
 * синхронизации в многозадачной среде.
 *
 * Ключевые структуры данных
 * xI2CSemaphore — Семафор FreeRTOS для синхронизации доступа к I2C-шине
 * use_I2C_dev — Адрес I2C-устройства, используемого для управления реле и насосом
 */

uint8_t check_I2C_device(uint8_t address)
Проверяет наличие I2C-устройства по указанному адресу.
Аргументы
address — Адрес устройства на шине I2C
Возвращает
Адрес устройства, если доступно; 0 при ошибке передачи; 255 при таймауте семафора
Исключения
Нет

---
bool set_stepper_target(uint16_t spd, uint8_t direction, uint32_t target)
Устанавливает целевую скорость, направление и количество шагов для двигателя.
Аргументы
spd — Скорость в шагах в секунду
direction — Направление движения: 0 — обратное, 1 — прямое
target — Целевое количество шагов
Возвращает
true при успешной установке, false в случае ошибки (например, таймаут семафора)
Исключения
Нет

---
bool set_stepper_by_time(uint16_t spd, uint8_t direction, uint16_t time)
Устанавливает работу двигателя на заданное время с указанной скоростью.
Аргументы
spd — Скорость в оборотах в минуту
direction — Направление движения: 0 — обратное, 1 — прямое
time — Время работы двигателя в секундах
Возвращает
true при успехе, false если устройство не используется или команда не выполнена
Исключения
Нет

---
uint16_t get_stepper_speed(void)
Возвращает текущую скорость двигателя в шагах в секунду.
Аргументы
Нет
Возвращает
Текущая скорость в шагах в секунду или 0xFFFF при ошибке чтения
Исключения
Нет

---
uint32_t get_stepper_status(void)
Возвращает текущее состояние двигателя — количество оставшихся шагов до цели.
Аргументы
Нет
Возвращает
Количество оставшихся шагов
Исключения
Нет

---
float get_liquid_volume_by_step(float StepCount)
Переводит количество шагов в объём жидкости в миллилитрах.
Аргументы
StepCount — Количество шагов
Возвращает
Объём жидкости в мл
Исключения
Нет

---
float get_liquid_rate_by_step(int StepperSpeed)
Переводит текущую скорость двигателя в расход жидкости в мл/час.
Аргументы
StepperSpeed — Скорость двигателя в шагах в секунду
Возвращает
Расход жидкости в мл/час
Исключения
Нет

---
float get_speed_from_rate(float volume_per_hour)
Преобразует требуемый расход жидкости в скорость двигателя в шагах в секунду.
Аргументы
volume_per_hour — Объёмный расход в мл/час
Возвращает
Скорость двигателя в шагах в секунду (не менее 1)
Исключения
Нет

---
float i2c_get_liquid_volume_by_step(int StepCount)
Возвращает объём жидкости, соответствующий заданному количеству шагов, с учётом использования I2C-двигателя.
Аргументы
StepCount — Количество шагов
Возвращает
Объём в мл
Исключения
Нет

---
float i2c_get_liquid_rate_by_step(int StepperSpeed)
Возвращает текущий расход жидкости на основе скорости двигателя, с учётом типа двигателя.
Аргументы
StepperSpeed — Скорость двигателя в шагах в секунду
Возвращает
Расход в мл/час, округлённый до трёх знаков после запятой
Исключения
Нет

---
float i2c_get_speed_from_rate(float volume_per_hour)
Преобразует расход жидкости в скорость двигателя, с учётом использования I2C-двигателя.
Аргументы
volume_per_hour — Объёмный расход в мл/час
Возвращает
Скорость двигателя в шагах в секунду (не менее 1)
Исключения
Нет

---
float i2c_get_liquid_volume()
Возвращает текущий объём отбора на основе скорости двигателя.
Аргументы
Нет
Возвращает
Объём в мл
Исключения
Нет

---
void stopService(void)
Останавливает сервис управления двигателем.
Аргументы
Нет
Возвращает
Нет
Исключения
Нет

---
void startService(void)
Запускает сервис управления двигателем.
Аргументы
Нет
Возвращает
Нет
Исключения
Нет

---
uint32_t get_i2c_revision(void)
Возвращает версию прошивки I2C-устройства.
Аргументы
Нет
Возвращает
Версию прошивки в виде 32-битного числа или 0xFFFFFFFF при ошибке
Исключения
Нет

---
bool set_mixer_pump_target(uint8_t on)
Устанавливает состояние насоса смесителя (вкл/выкл).
Аргументы
on — Новое состояние насоса (0 — выкл, иное — вкл)
Возвращает
true при успешной записи, false при ошибке или отсутствии I2C-устройства
Исключения
Нет

---
uint8_t get_mixer_pump_status(void)
Читает текущее состояние насоса смесителя.
Аргументы
Нет
Возвращает
Состояние насоса (0 — выключен, 1 — включен) или 0xFF при ошибке
Исключения
Нет

---
uint8_t get_i2c_rele_state(uint8_t r)
Читает состояние указанного реле.
Аргументы
r — Номер реле (1–8, соответствует битам в байте)
Возвращает
Состояние реле (0 или 1) или 0xFF при ошибке
Исключения
Нет

---
bool set_i2c_rele_state(uint8_t r, bool s)
Устанавливает состояние указанного реле.
Аргументы
r — Номер реле (1–8)
s — Желаемое состояние (true — вкл, false — выкл)
Возвращает
true при успешной записи, false при ошибке или отсутствии I2C-устройства
Исключения
Нет
