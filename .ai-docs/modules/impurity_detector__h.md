# impurity_detector

Модуль `impurity_detector` предназначен для автоматического обнаружения примесей в процессе дистилляции на основе анализа температуры колонны. Он отслеживает динамику температуры, вычисляет тренды, дисперсию и последовательные повышения, чтобы определить моменты перехода между фракциями. Модуль поддерживает грейс-периоды после старта и ручного вмешательства, а также блокировку детекции при нестабильном паре.

Ключевые структуры данных  
impurityDetector — глобальная структура, хранящая историю температур, текущее состояние детектора и параметры коррекции  
detector_manual_override_until — временная метка, до которой детектор принудительно отключён (ручное управление)  
detector_grace_until — временная метка окончания grace-периода, в течение которого детектор не реагирует на изменения  
CurrentHeatLoss — текущее значение теплопотерь в ваттах, рассчитанное после цикла нагрева  
heatLossCalculated — флаг успешного завершения расчёта теплопотерь  
BoilerVolume — объём бойлера в литрах, используется как масса воды в кг  
heatStartTemp — температура в начале нагрева, фиксируется перед стартом  

---
float get_speed_from_rate(float volume_per_hour)  
Преобразует объёмную скорость в значение скорости насоса  
Аргументы  
volume_per_hour — объём в литрах в час  
Возвращает  
Значение скорости насоса в диапазоне 0–255  
Исключения  

---
void set_pump_speed(float pumpspeed, bool continue_process)  
Устанавливает скорость насоса и, при необходимости, продолжает процесс отбора  
Аргументы  
pumpspeed — значение скорости (0–255)  
continue_process — флаг продолжения процесса отбора  
Возвращает  

---
void set_body_temp()  
Устанавливает температуру тела самовара на основе текущего режима и целевой температуры  
Аргументы  
Возвращает  

---
void set_buzzer(bool fl)  
Включает или выключает зуммер  
Аргументы  
fl — true для включения, false для выключения  
Возвращает  

---
void SendMsg(const String& m, MESSAGE_TYPE msg_type)  
Отправляет сообщение указанного типа в интерфейс пользователя  
Аргументы  
m — текст сообщения  
msg_type — тип сообщения (например, уведомление, ошибка)  
Возвращает  

---
void pause_withdrawal(bool Pause)  
Приостанавливает или возобновляет отбор дистиллята  
Аргументы  
Pause — true для паузы, false для возобновления  
Возвращает  

---
void init_impurity_detector()  
Инициализирует детектор примесей, сбрасывая все внутренние состояния и историю температур  
Аргументы  
Возвращает  

---
void reset_impurity_detector()  
Полностью сбрасывает состояние детектора, включая историю, тренды и параметры коррекции  
Аргументы  
Возвращает  

---
void detector_on_program_start(const String& wtype)  
Обрабатывает начало новой программы отбора в зависимости от типа фракции  
Аргументы  
wtype — тип фракции ("H" для голов, иначе — тело/спирт)  
Возвращает  

---
void detector_on_manual_resume()  
Сбрасывает детектор и устанавливает блокировку на 60 секунд после ручного возобновления отбора  
Аргументы  
Возвращает  

---
void detector_on_auto_resume()  
Сбрасывает детектор и устанавливает короткий грейс-период после автоматического возобновления  
Аргументы  
Возвращает  

---
bool is_steam_stable(float steamTemp)  
Проверяет, стабилизировалась ли температура пара в пределах заданного порога в течение 10 минут  
Аргументы  
steamTemp — текущая температура пара  
Возвращает  
true, если температура стабильна, иначе false  
Исключения  

---
float calculate_temperature_variance()  
Вычисляет дисперсию температуры по накопленной истории для оценки нестабильности  
Возвращает  
Значение дисперсии температуры (среднее квадратичное отклонение в квадрате)  
Исключения  

---
uint8_t check_consecutive_rises(float currentTemp)  
Определяет количество последовательных повышений температуры более чем на 0.02°C  
Аргументы  
currentTemp — текущая температура колонны  
Возвращает  
Число последовательных повышений  
Исключения  

---
void update_detector_history(float columnTemp)  
Добавляет текущую температуру колонны в историю и обновляет состояние детектора  
Аргументы  
columnTemp — температура колонны для добавления в историю  
Возвращает  

---
float calculate_temperature_trend()  
Расчет температурного тренда в °C/мин методом линейной регрессии по данным из кольцевого буфера  
Возвращает  
Температурный тренд в °C/мин; возвращает 0.0f при недостатке данных (менее 5 точек)  
Исключения  

---
float get_adaptive_threshold(float baseThreshold, float variance, float volumePerHour, String processPhase)  
Вычисление адаптивного порога с учётом дисперсии, скорости отбора и фазы процесса  
Аргументы  
baseThreshold — базовый порог срабатывания детектора  
variance — текущая дисперсия температуры (в °C²)  
volumePerHour — скорость отбора в литрах в час  
processPhase — фаза процесса ("H" — головы, "B" — тело, "T" — хвосты, "C" — предзахлеб)  
Возвращает  
Адаптированное значение порога с учётом всех корректировок  
Исключения  

---
bool is_first_body_program_after_heads()  
Проверка, является ли текущая программа первой программой отбора тела (B или C) после отбора голов (H)  
Возвращает  
true, если текущая программа — первая B/C после H; иначе false  
Исключения  

---
void process_impurity()  
Основная логика детектора примесей: обновление истории, фильтрация, расчёт тренда и принятие решения  
Возвращает  

---
void _detector()  
Анализирует текущее состояние процесса и при необходимости активирует детектор примесей для коррекции скорости отбора  
Возвращает  

---
void update_detector_history(float temperature)  
Обновляет историю измерений температуры для анализа тренда  
Аргументы  
temperature — текущее усреднённое значение температуры с датчика (пар или царга)  
Возвращает  

---
float calculate_temperature_trend()  
Вычисляет текущий температурный тренд на основе истории измерений  
Возвращает  
Текущее значение тренда (разница между последним и средним значением за период, нормализованная)  
Исключения  

---
bool is_steam_stable(float steamTemp)  
Оценивает стабильность температуры пара для безопасного запуска детектора  
Аргументы  
steamTemp — текущая температура пара  
Возвращает  
true, если температура пара стабильна в пределах допуска; иначе false  
Исключения  

---
float get_adaptive_threshold(float baseThreshold, float stdDev, float speed, String phase)  
Рассчитывает адаптивный порог срабатывания детектора с учётом дисперсии, скорости отбора и фазы процесса  
Аргументы  
baseThreshold — базовый порог, зависящий от плотности насадки  
stdDev — стандартное отклонение температуры (мера нестабильности)  
speed — текущая скорость отбора (л/ч)  
phase — фаза процесса ("H", "B", "T" и т.д.)  
Возвращает  
Адаптированное значение порога срабатывания  
Исключения  

---
void handle_impurity_detection()  
Обработка текущего состояния детектора примесей и применение управляющих действий  
Аргументы  
нет  
Возвращает  
нет  
Исключения  
нет  

---
void update_heat_loss_calculation()  
Выполняет автоматический расчёт теплопотерь котла при нагреве от 40°C до 70°C  
Аргументы  
нет  
Возвращает  
нет  
Исключения  
нет  

---
class ImpurityDetector  
Класс анализа тренда температуры для обнаружения примесей в дистилляте  
Поля  
currentTrend — Текущее значение тренда температуры (°C/с × 1000)  
tempStdDev — Стандартное отклонение температуры за окно анализа (°C)  
detectorStatus — Статус детектора: 0=Stable, 1=Correction, 2=Breakthrough  
correctionFactor — Множитель скорости отбора (от 0.7 до 1.0), регулируется при коррекции  
lastCorrectionTime — Временная метка последнего изменения correctionFactor (мс)  
Методы  
void update(float temp, unsigned long now) — Обновляет внутренние данные на основе текущей температуры и времени  
float calculate_trend() — Вычисляет текущий тренд температуры на основе скользящего окна  
void reset() — Сбрасывает все внутренние состояния детектора  

---
void calculateHeatLoss(float heatStartTemp, float timeSec)  
Выполняет расчёт теплопотерь на основе начальной температуры и длительности нагрева  
Аргументы  
heatStartTemp — температура в начале нагрева, °C  
timeSec — длительность нагрева в секундах  
Возвращает  
Ничего не возвращает  
Исключения  
Нет исключений  

---
void SendMsg(String message, uint8_t level)  
Отправляет сообщение в систему логирования или уведомлений  
Аргументы  
message — текст сообщения  
level — уровень сообщения (например, NOTIFY_MSG, WARNING_MSG)  
Возвращает  
Ничего не возвращает  
Исключения  
Нет исключений
