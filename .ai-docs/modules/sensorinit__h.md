# sensorinit

Модуль `Samovar_S_I` предоставляет функциональность для управления самоваром, включая загрузку программ в зависимости от режима работы, обработку данных с датчиков температуры, давления и окружающей среды. Модуль поддерживает взаимодействие с датчиками DS18B20, BME680, BMP180, BMP280, BME280, XGZP6897D, MPX5010D через шины OneWire и I2C, реализует коррекцию температуры по атмосферному давлению и поддерживает режимы пивоварения, сувид, дистилляции и НБК. Также обеспечивается интеграция с Lua-скриптами и управление насосом через ШИМ.

Ключевые структуры данных  
DeviceAddress — массив из 8 байт, используемый для хранения уникального адреса датчика DS18B20  
Samovar_Mode — глобальная переменная, определяющая текущий режим работы устройства (пиво, сувид, дистилляция и др.)

---
void load_default_program_for_mode()
Загружает программу по умолчанию в зависимости от текущего режима работы самовара
Аргументы
Возвращает
Исключения

---
String get_Samovar_Status()
Возвращает строку с текущим статусом самовара в формате JSON
Аргументы
Возвращает
Строка JSON с информацией о состоянии системы
Исключения

---
void set_power(bool On)
Включает или выключает подачу питания на нагреватель
Аргументы
On — true для включения, false для выключения
Возвращает
Исключения

---
void clok()
Обновляет внутренние таймеры и состояние системы (используется в основном цикле)
Аргументы
Возвращает
Исключения

---
void clok1()
Выполняет фоновые задачи с низким приоритетом (например, логирование)
Аргументы
Возвращает
Исключения

---
void getjson(void)
Обрабатывает входящие JSON-команды от интерфейса управления
Аргументы
Возвращает
Исключения

---
String append_data()
Формирует строку с текущими показаниями датчиков для логирования
Аргументы
Возвращает
Строка с данными датчиков в формате, пригодном для записи в лог
Исключения

---
void stopService(void)
Останавливает все активные процессы и сервисы самовара
Аргументы
Возвращает
Исключения

---
void startService(void)
Запускает основные сервисы самовара (нагрев, контроль датчиков и т.д.)
Аргументы
Возвращает
Исключения

---
void CopyDSAddress(const uint8_t* DevSAddress, uint8_t* DevTAddress)
Копирует адрес датчика DS18B20 из источника в назначение
Аргументы
DevSAddress — указатель на исходный адрес датчика  
DevTAddress — указатель на целевой буфер для копирования
Возвращает
Исключения

---
void set_beer_program(String WProgram)
Устанавливает программу для режима пивоварения или сувид
Аргументы
WProgram — строка с описанием программы в специальном формате
Возвращает
Исключения

---
void set_program(String WProgram)
Устанавливает общую программу управления самоваром
Аргументы
WProgram — строка с программой в формате команд
Возвращает
Исключения

---
void set_dist_program(String WProgram)
Устанавливает программу для режима дистилляции
Аргументы
WProgram — строка с параметрами дистилляции
Возвращает
Исключения

---
void set_nbk_program(String WProgram)
Устанавливает программу для режима НБК
Аргументы
WProgram — строка с программой НБК
Возвращает
Исключения

---
String getDSAddress(DeviceAddress deviceAddress)
Преобразует адрес датчика DS18B20 в строку шестнадцатеричного представления
Аргументы
deviceAddress — адрес датчика DS18B20
Возвращает
Строка с HEX-представлением адреса
Исключения

---
void setupOpenLog(void)
Инициализирует систему логирования в файл на SD-карте
Аргументы
Возвращает
Исключения

---
void createFile(char* fileName)
Создаёт новый файл для логирования с указанным именем
Аргументы
fileName — имя создаваемого файла
Возвращает
Исключения

---
void set_capacity(uint8_t cap)
Устанавливает объём ёмкости самовара (в литрах)
Аргументы
cap — объём в литрах
Возвращает
Исключения

---
void init_pump_pwm(uint8_t pin, int freq)
Инициализирует ШИМ-управление насосом на указанном пине с заданной частотой
Аргументы
pin — номер пина для ШИМ  
freq — частота ШИМ в Гц
Возвращает
Исключения

---
void set_pump_pwm(float duty)
Устанавливает скважность ШИМ для управления скоростью насоса
Аргументы
duty — значение от 0.0 до 1.0 (0–100%)
Возвращает
Исключения

---
void printAddress(DeviceAddress deviceAddress)
Выводит адрес датчика DS18B20 в последовательный порт в читаемом виде
Аргументы
deviceAddress — адрес датчика
Возвращает
Исключения

---
void reset_sensor_counter(void)
Сбрасывает счётчики обнаруженных датчиков DS18B20
Аргументы
Возвращает
Исключения

---
void BME_getvalue(bool fl)
Считывает данные с датчика атмосферного давления и температуры (BME680/BMP180/BMP280/BME280)
Аргументы
fl — флаг, не используемый в текущей реализации
Возвращает
Исключения

---
void pressure_sensor_get()
Считывает значение давления с датчика XGZP6897D или MPX5010D с фильтрацией
Аргументы
Возвращает
Исключения

---
void DS_getvalue(void)
Считывает температуру с датчиков DS18B20 с коррекцией по атмосферному давлению
Аргументы
Возвращает
Исключения

---
float sensors_get_temperature()
Возвращает температуру с датчика 1 (SteamSensor).
Аргументы
Отсутствуют
Возвращает
Температура в градусах Цельсия с датчика SteamSensor с учётом коррекции DeltaSteamTemp. При ошибке чтения возвращает значение ниже -10.
Исключения

---
void scan_ds_adress()
Инициализирует шину 1-Wire и сканирует подключённые датчики DS18B20, определяя их адреса и устанавливая разрешение измерений.
Аргументы
Отсутствуют
Возвращает
Отсутствует
Исключения

---
void sensor_init()
Инициализирует датчик давления/влажности (BME680, BMP280 или BMP180) по I2C с проверкой наличия и настройкой параметров измерений.
Аргументы
Отсутствуют
Возвращает
Отсутствует
Исключения

---
class SteamSensor
Хранит и обновляет данные температурного датчика пара.
Поля
avgTemp — средняя температура, обновляется при успешном чтении  
PrevTemp — предыдущее корректное значение температуры  
ErrCount — счётчик ошибок чтения датчика
Методы

---
class PipeSensor
Хранит и обновляет данные температурного датчика трубопровода.
Поля
avgTemp — средняя температура, обновляется при успешном чтении  
PrevTemp — предыдущее корректное значение температуры  
ErrCount — счётчик ошибок чтения датчика
Методы

---
class WaterSensor
Хранит и обновляет данные температурного датчика воды.
Поля
avgTemp — средняя температура, обновляется при успешном чтении  
PrevTemp — предыдущее корректное значение температуры  
ErrCount — счётчик ошибок чтения датчика
Методы

---
class TankSensor
Хранит и обновляет данные температурного датчика бака.
Поля
avgTemp — средняя температура, обновляется при успешном чтении  
PrevTemp — предыдущее корректное значение температуры  
ErrCount — счётчик ошибок чтения датчика
Методы

---
class ACPSensor
Хранит и обновляет данные температурного датчика АЦП.
Поля
avgTemp — средняя температура, обновляется при успешном чтении  
PrevTemp — предыдущее корректное значение температуры  
ErrCount — счётчик ошибок чтения датчика
Методы

---
void setup_hardware(void)
Инициализирует все аппаратные компоненты системы в соответствии с определёнными макросами конфигурации.
Аргументы
Нет
Возвращает
Нет
Исключения

---
inline String format_float(float v, int d)
Форматирует число с плавающей точкой в строку с заданным количеством знаков после запятой.
Аргументы
v — значение типа float для форматирования  
d — количество знаков после запятой
Возвращает
Отформатированная строка
Исключения

---
String get_DSAddressList(String Address)
Генерирует HTML-строку с выпадающим списком адресов датчиков DS18B20, выделяя выбранный.
Аргументы
Address — строка с адресом, который должен быть отмечен как выбранный
Возвращает
HTML-код элемента <select> с опциями адресов
Исключения

---
String generateDSOptions()
Генерирует HTML-строку с опциями выпадающего списка адресов устройств, выделяя текущий выбранный адрес.
Аргументы
Возвращает
HTML-строка с тегами <option> для каждого адреса устройств, с атрибутом selected для текущего адреса.
Исключения

---
void get_task_stack_usage()
Выводит в последовательный порт статистику использования стека задачами FreeRTOS (высоту водного уровня).
Аргументы
Возвращает
Исключения
