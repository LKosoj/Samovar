# WebServer

Модуль реализует веб-интерфейс и сетевые функции для управления устройством "Самовар" — системой дистилляции, приготовления пива и других процессов. Обеспечивает обработку HTTP-запросов, динамическую генерацию веб-страниц, переключение режимов работы и взаимодействие с файловой системой. Поддерживается сжатие контента (gzip), кэширование и обработка шаблонов для динамического отображения данных.

Ключевые структуры данных  
get_web_type — перечисление типов веб-файлов, используемое при получении файлов через `get_web_file`  
MESSAGE_TYPE — тип сообщения для отправки уведомлений через `SendMsg`  
Samovar_Mode — глобальная переменная, определяющая текущий режим работы устройства (пиво, дистилляция, НБК и др.)

---
void change_samovar_mode()  
Переключает веб-интерфейс в зависимости от текущего режима работы Самовара.  
Аргументы  
Возвращает  
Исключения

---
void handleFileWithGzip(AsyncWebServerRequest *request, const String &path, const String &contentType, const String &cacheControl)  
Обрабатывает запрос файла с поддержкой GZIP-сжатия: отправляет .gz-версию, если клиент поддерживает сжатие и файл существует.  
Аргументы  
request — указатель на HTTP-запрос от клиента  
path — путь к файлу в SPIFFS  
contentType — MIME-тип содержимого (например, "text/html")  
cacheControl — строка политики кэширования (по умолчанию "max-age=5000")  
Возвращает  
Исключения

---
void handleWifiHtmFromMemory(AsyncWebServerRequest *request)  
Отправляет встроенный HTML-файл wifi.htm из оперативной памяти в сжатом виде (gzip), используемый при настройке Wi-Fi.  
Аргументы  
request — указатель на HTTP-запрос  
Возвращает  
Исключения

---
void WebServerInit(void)  
Инициализирует веб-сервер: настраивает маршруты, обработчики файлов и перенаправления в зависимости от состояния Wi-Fi.  
Аргументы  
Возвращает  
Исключения

---
String indexKeyProcessor(const String &var)  
Обрабатывает шаблонные переменные в index.htm и других основных страницах интерфейса, подставляя актуальные данные с датчиков и состояния системы.  
Аргументы  
var — имя переменной в шаблоне (например, "%TEMP%")  
Возвращает  
Значение, подставляемое вместо переменной, или пустая строка, если переменная не найдена  
Исключения

---
String setupKeyProcessor(const String &var)  
Обрабатывает переменные в странице настройки Wi-Fi (wifi.htm), возвращая соответствующие параметры сети.  
Аргументы  
var — имя шаблонной переменной (например, "%SSID%")  
Возвращает  
Текущее значение параметра сети или системной конфигурации  
Исключения

---
String wifiKeyProcessor(const String &var)  
Устаревший или дублирующий обработчик для страницы Wi-Fi; функционально аналогичен setupKeyProcessor.  
Аргументы  
var — имя переменной в шаблоне  
Возвращает  
Соответствующее значение параметра  
Исключения

---
String get_DSAddressList(String Address)  
Формирует список адресов датчиков температуры (DS18B20) в виде строки для отображения в веб-интерфейсе.  
Аргументы  
Address — строка с перечислением адресов (игнорируется, используется глобальное состояние)  
Возвращает  
Строка с разделёнными запятыми адресами 1-Wire датчиков  
Исключения

---
String get_web_file(String fn, get_web_type type)  
Возвращает содержимое веб-файла из SPIFFS или памяти в зависимости от типа и имени файла.  
Аргументы  
fn — имя файла  
type — тип запрашиваемого файла (например, HTML, CSS, JS)  
Возвращает  
Содержимое файла в виде строки  
Исключения

---
void get_web_interface()  
Инициализирует или перезагружает веб-интерфейс, применяя текущие настройки и режимы.  
Аргументы  
Возвращает  
Исключения

---
String http_sync_request_get(String url)  
Выполняет синхронный HTTP GET-запрос по указанному URL.  
Аргументы  
url — адрес для запроса  
Возвращает  
Тело ответа в виде строки, или пустая строка при ошибке  
Исключения

---
void web_command(AsyncWebServerRequest *request)  
Обрабатывает входящие команды от веб-интерфейса (GET/POST), такие как управление режимами, мощностью, насосом.  
Аргументы  
request — указатель на HTTP-запрос с параметрами команды  
Возвращает  
Исключения

---
void handleSave(AsyncWebServerRequest *request)  
Обрабатывает запрос на сохранение текущих настроек в конфигурационный файл.  
Аргументы  
request — указатель на HTTP-запрос с данными для сохранения  
Возвращает  
Исключения

---
void get_data_log(AsyncWebServerRequest *request, String fn)  
Отправляет клиенту лог данных (например, CSV-файл с историей измерений).  
Аргументы  
request — указатель на HTTP-запрос  
fn — имя запрашиваемого лог-файла  
Возвращает  
Исключения

---
String calibrateKeyProcessor(const String &var)  
Обрабатывает переменные на странице калибровки, возвращая текущие значения калибровочных коэффициентов.  
Аргументы  
var — имя переменной в шаблоне калибровки  
Возвращает  
Значение параметра калибровки  
Исключения

---
void set_pump_speed(float pumpspeed, bool continue_process)  
Устанавливает скорость насоса в виде доли от максимальной (0.0–1.0) с возможностью продолжения фонового процесса.  
Аргументы  
pumpspeed — скорость насоса (0.0 — выключен, 1.0 — максимум)  
continue_process — если true, процесс продолжается после установки  
Возвращает  
Исключения

---
void set_pump_speed_pid(float temp)  
Управляет скоростью насоса на основе ПИД-регулирования по температуре.  
Аргументы  
temp — текущее значение температуры для ПИД-регулятора  
Возвращает  
Исключения

---
void set_pump_pwm(float duty)  
Устанавливает скважность ШИМ для управления насосом напрямую.  
Аргументы  
duty — значение duty cycle в диапазоне 0.0–1.0  
Возвращает  
Исключения

---
void set_power(bool On)  
Включает или выключает нагревательный элемент.  
Аргументы  
On — true для включения, false для выключения  
Возвращает  
Исключения

---
void set_current_power(float Volt)  
Устанавливает текущее напряжение питания для расчёта мощности.  
Аргументы  
Volt — напряжение в вольтах  
Возвращает  
Исключения

---
void set_power_mode(String Mode)  
Переключает режим работы нагревателя (например, "PID", "Manual", "Off").  
Аргументы  
Mode — строка с режимом работы  
Возвращает  
Исключения

---
void set_water_temp(float temp)  
Устанавливает целевую температуру воды для режимов с термостатированием.  
Аргументы  
temp — целевая температура в градусах Цельсия  
Возвращает  
Исключения

---
void set_body_temp()  
Обновляет температуру корпуса на основе данных с датчика (вызывается периодически).  
Аргументы  
Возвращает  
Исключения

---
void set_capacity(uint8_t cap)  
Устанавливает объём ёмкости (в литрах), влияющий на алгоритмы расчёта.  
Аргументы  
cap — объём в литрах (обычно 1–100)  
Возвращает  
Исключения

---
void set_mixer(bool On)  
Включает или выключает мешалку.  
Аргументы  
On — true для включения, false для выключения  
Возвращает  
Исключения

---
void start_self_test(void)  
Запускает самодиагностику устройства: проверка датчиков, насоса, нагревателя.  
Аргументы  
Возвращает  
Исключения

---
void stop_self_test(void)  
Останавливает выполняемый процесс самодиагностики.  
Аргументы  
Возвращает  
Исключения

---
void save_profile()  
Сохраняет текущий профиль настроек в файловую систему.  
Аргументы  
Возвращает  
Исключения

---
void read_config()  
Считывает конфигурацию устройства из файла настроек при запуске.  
Аргументы  
Возвращает  
Исключения

---
void load_profile()  
Загружает сохранённый профиль настроек из SPIFFS.  
Аргументы  
Возвращает  
Исключения

---
void samovar_reset()  
Выполняет программный сброс состояния Самовара (остановка всех процессов, сброс режимов).  
Аргументы  
Возвращает  
Исключения

---
void set_program(String WProgram)  
Устанавливает текущую программу работы Самовара (универсальная функция).  
Аргументы  
WProgram — строка с именем или параметрами программы  
Возвращает  
Исключения

---
void set_beer_program(String WProgram)  
Устанавливает программу для режима приготовления пива.  
Аргументы  
WProgram — строка с параметрами пивоваренной программы  
Возвращает  
Исключения

---
void set_dist_program(String WProgram)  
Устанавливает программу для режима дистилляции.  
Аргументы  
WProgram — строка с параметрами дистилляционной программы  
Возвращает  
Исключения

---
void set_nbk_program(String WProgram)  
Устанавливает программу для режима НБК (непрерывная бродильная камера).  
Аргументы  
WProgram — строка с параметрами НБК-программы  
Возвращает  
Исключения

---
String get_program(uint8_t s)  
Возвращает строку с описанием программы по её индексу.  
Аргументы  
s — индекс программы  
Возвращает  
Описание программы в виде строки  
Исключения

---
String get_beer_program()  
Возвращает текущую пивоваренную программу.  
Аргументы  
Возвращает  
Строка с параметрами программы пивоварения  
Исключения

---
String get_dist_program()  
Возвращает текущую программу дистилляции.  
Аргументы  
Возвращает  
Строка с параметрами дистилляционной программы  
Исключения

---
String get_nbk_program()  
Возвращает текущую программу НБК.  
Аргументы  
Возвращает  
Строка с параметрами НБК-программы  
Исключения

---
float get_speed_from_rate(float rate)  
Переводит объёмную скорость (л/ч) в скорость работы устройства (например, шагов двигателя в секунду).  
Аргументы  
rate — скорость в литрах в час  
Возвращает  
Скорость в условных единицах  
Исключения

---
float i2c_get_speed_from_rate(float volume_per_hour)  
Вычисляет скорость для I2C-устройства (например, насоса) на основе объёма в час.  
Аргументы  
volume_per_hour — объём в литрах в час  
Возвращает  
Скорость в единицах, пригодных для передачи по I2C  
Исключения

---
float get_alcohol(float t)  
Рассчитывает содержание алкоголя в парах по температуре дистиллята.  
Аргументы  
t — температура в градусах Цельсия  
Возвращает  
Оценка крепости (в % об.)  
Исключения

---
float fromPower(float value)  
Преобразует значение мощности (в ваттах) в управляющий сигнал (например, ШИМ).  
Аргументы  
value — мощность в ваттах  
Возвращает  
Нормализованное значение (0.0–1.0) или управляющий параметр  
Исключения

---
void SendMsg(const String& m, MESSAGE_TYPE msg_type)  
Отправляет сообщение указанного типа (например, уведомление, ошибка) через доступные интерфейсы (веб, UART, MQTT).  
Аргументы  
m — текст сообщения  
msg_type — тип сообщения (например, INFO, ERROR)  
Возвращает  
Исключения

---
void distiller_finish()  
Вызывается при завершении процесса дистилляции: останавливает оборудование, отправляет уведомление.  
Аргументы  
Возвращает  
Исключения

---
void beer_finish()  
Вызывается при завершении пивоваренного цикла: останавливает процессы, фиксирует результат.  
Аргументы  
Возвращает  
Исключения

---
void bk_finish()  
Вызывается при завершении цикла БК (бродильной камеры).  
Аргументы  
Возвращает  
Исключения

---
void nbk_finish()  
Вызывается при завершении цикла НБК.  
Аргументы  
Возвращает  
Исключения

---
void menu_reset_wifi()  
Сбрасывает настройки Wi-Fi и переводит устройство в режим точки доступа для перенастройки.  
Аргументы  
Возвращает  
Исключения

---
uint16_t get_stepper_speed(void)  
Возвращает текущую скорость шагового двигателя (например, для насоса).  
Аргументы  
Возвращает  
Скорость в шагах в секунду  
Исключения

---
uint32_t get_stepper_status(void)  
Возвращает текущее состояние шагового двигателя (позиция, флаги ошибок и т.п.).  
Аргументы  
Возвращает  
Статус двигателя в виде 32-битного значения  
Исключения

---
bool set_stepper_target(uint16_t spd, uint8_t direction, uint32_t target)  
Устанавливает целевую скорость, направление и позицию для шагового двигателя.  
Аргументы  
spd — скорость в шагах в секунду  
direction — направление (0 — обратное, 1 — прямое)  
target — целевая позиция в шагах  
Возвращает  
true при успешной установке, false при ошибке  
Исключения

---
#ifdef USE_LUA  
class LuaScript  
Интерфейс для выполнения пользовательских скриптов на языке Lua для автоматизации задач.  
Поля  
Исключения  
Методы  
void start_lua_script() — запускает загруженный Lua-скрипт  
void load_lua_script() — загружает скрипт из файла  
String get_lua_script_list() — возвращает список доступных Lua-скриптов  
void run_lua_script(String fn) — запускает скрипт по имени файла  
String run_lua_string(String lstr) — выполняет строку кода Lua и возвращает результат  
#endif
