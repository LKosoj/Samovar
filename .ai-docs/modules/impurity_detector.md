# impurity_detector

Модуль `impurity_detector` предназначен для автоматического обнаружения примесей в процессе дистилляции на основе анализа температурного тренда в колонне. Он отслеживает изменения температуры, вычисляет тренд методом линейной регрессии и дисперсию для фильтрации шума, а также управляет логикой пауз отбора при обнаружении критических изменений. Модуль интегрируется с системой управления самогонным аппаратом и реагирует на события старта программы, ручного и автоматического продолжения отбора.

Ключевые структуры данных  
impurityDetector — глобальная структура, хранящая историю температур, текущее состояние детектора и параметры коррекции  
program — массив программ отбора, содержащий типы программ (H, B, C, P и др.)  
SamSetup — настройки системы, включая флаг использования авто-коррекции  
SamovarStatusInt — текущий статус аппарата (режим отбора, пауза и т.д.)  
PauseOn — флаг ручной паузы, управляемой пользователем  
ProgramNum — текущий индекс активной программы

float get_speed_from_rate(float volume_per_hour)  
Преобразует объёмную скорость в единицах объёма в час в значение скорости насоса  
Аргументы  
volume_per_hour — объём жидкости, перекачиваемой за час (мл/ч)  
Возвращает  
Значение скорости насоса в диапазоне 0–255  
Исключения  
Нет

---
void set_pump_speed(float pumpspeed, bool continue_process)  
Устанавливает скорость насоса и, при необходимости, продолжает процесс отбора  
Аргументы  
pumpspeed — значение скорости насоса (обычно 0–255)  
continue_process — флаг, указывающий, следует ли возобновить отбор  
Возвращает  
Нет  
Исключения  
Нет

---
void set_body_temp()  
Обновляет целевую температуру тела самогонного аппарата на основе текущего режима  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет

---
void set_buzzer(bool fl)  
Включает или выключает звуковой сигнал (бuzzer)  
Аргументы  
fl — true для включения, false для выключения  
Возвращает  
Нет  
Исключения  
Нет

---
void SendMsg(const String& m, MESSAGE_TYPE msg_type)  
Отправляет сообщение в систему логирования или пользовательский интерфейс  
Аргументы  
m — текст сообщения  
msg_type — тип сообщения (например, информационное, предупреждение, ошибка)  
Возвращает  
Нет  
Исключения  
Нет

---
void pause_withdrawal(bool Pause)  
Приостанавливает или возобновляет отбор продукта  
Аргументы  
Pause — true для паузы, false для возобновления отбора  
Возвращает  
Нет  
Исключения  
Нет

---
void init_impurity_detector()  
Инициализирует детектор примесей, сбрасывая все внутренние состояния и историю температур  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет

---
void reset_impurity_detector()  
Полностью сбрасывает состояние детектора, включая историю, тренды и флаги, при смене режима или ручной корректировке  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет

---
void detector_on_program_start(const String& wtype)  
Вызывается при старте новой программы отбора, устанавливает грейс-период в зависимости от типа отбора  
Аргументы  
wtype — тип отбора ("H" для голов, иной — для общего режима)  
Возвращает  
Нет  
Исключения  
Нет

---
void detector_on_manual_resume()  
Сбрасывает детектор и устанавливает защитный интервал после ручного возобновления отбора  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет

---
void detector_on_auto_resume()  
Сбрасывает детектор и устанавливает короткий грейс-период после автоматического возобновления отбора после паузы  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет

---
float calculate_temperature_variance()  
Вычисляет дисперсию температуры по накопленной истории для оценки стабильности процесса  
Аргументы  
Нет  
Возвращает  
Значение дисперсии температуры (в °C²), используется вместо стандартного отклонения  
Исключения  
Нет

---
uint8_t check_consecutive_rises(float currentTemp)  
Проверяет, сколько раз подряд температура повышалась более чем на 0.02 °C  
Аргументы  
currentTemp — текущее значение температуры колонны  
Возвращает  
Количество последовательных повышений температуры  
Исключения  
Нет

---
void update_detector_history(float columnTemp)  
Добавляет новое значение температуры в кольцевой буфер и обновляет статистику  
Аргументы  
columnTemp — текущая температура в колонне (°C)  
Возвращает  
Нет  
Исключения  
Нет

---
float calculate_temperature_trend()  
Вычисляет текущий температурный тренд методом линейной регрессии по истории значений  
Аргументы  
Нет  
Возвращает  
Темп роста температуры в °C/мин, положительное значение — рост, отрицательное — падение  
Исключения  
Нет

---
float calculate_temperature_slope(uint8_t n)  
Расчёт скорости изменения температуры за последние n точек (в °C/мин)  
Аргументы  
n — количество последних точек для анализа (максимум 30)  
Возвращает  
Скорость изменения температуры в °C/мин. Возвращает 0.0f при делении на ноль.  
Исключения  
Нет

---
float get_adaptive_threshold(float baseThreshold, float variance, float volumePerHour, String processPhase)  
Вычисление адаптивного порога с учётом дисперсии, скорости отбора и фазы процесса  
Аргументы  
baseThreshold — базовый порог срабатывания детектора  
variance — дисперсия температуры за период (в °C²)  
volumePerHour — текущая скорость отбора в литрах в час  
processPhase — фаза процесса ("H", "B", "C", "T")  
Возвращает  
Адаптированное значение порога срабатывания  
Исключения  
Нет

---
bool is_first_body_program_after_heads()  
Проверка, является ли текущая программа первой программой тела (B или C) после отбора голов (H)  
Аргументы  
Нет  
Возвращает  
true, если текущая программа — первая B/C после H; иначе false  
Исключения  
Нет

---
void process_impurity_detector()  
Основная логика работы детектора примесей: анализ температуры, принятие решений по коррекции скорости отбора  
Аргументы  
Нет  
Возвращает  
Нет  
Исключения  
Нет
