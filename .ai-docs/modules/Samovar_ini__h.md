# Samovar_ini

/**
 * @file samovar_i.h
 * @brief Конфигурационный заголовочный файл для системы управления дистилляционной установкой "Самовар".
 *
 * Модуль содержит определения констант, параметров и настроек, используемых в системе управления
 * дистилляцией и ректификацией. Включает пороги температур, настройки автоматики, параметры ШИМ,
 * конфигурации подключаемых устройств (регуляторы мощности, датчики, насосы) и флаги активации подсистем.
 * Предназначен для централизованной настройки поведения устройства под различные аппаратные конфигурации.
 *
 * Ключевые структуры данных
 * servoDelta — массив коррекции угла поворота сервопривода для 11 позиций, компенсирующий механические погрешности
 * Config — Глобальная структура хранения настроек устройства, инициализируемая на основе макросов
 * SensorData — Структура для хранения текущих показаний датчиков температуры, давления, уровня и влажности
 */

---
#define SAMOVAR_HOST "samovar"
// Имя хоста устройства в сети. Используется для идентификации в Wi-Fi и сетевых сервисах.

---
#define ALARM_WATER_TEMP 70
// Температура воды, при достижении которой формируется предупреждение оператору.

---
#define MAX_WATER_TEMP 75
// Максимальная температура воды, при превышении которой отключается питание нагрева.

---
#define MAX_STEAM_TEMP 98.8
// Максимальная температура пара, при превышении которой отключается питание нагрева.

---
#define MAX_ACP_TEMP 75
// Максимальная температура в термостойкой части аппарата (ТСА), при превышении которой отключается питание.

---
#define CHANGE_POWER_MODE_STEAM_TEMP 39
// Температура пара, при достижении которой колонна переходит из режима разгона в рабочий режим.

---
#define OPEN_VALVE_TANK_TEMP 77
// Температура в кубе, при достижении которой открывается клапан и включается насос подачи воды.

---
#define DELTA_T_CLOSE_VALVE 20
// Разница между целевой и текущей температурой охлаждающей воды, при которой насос продолжает работать после завершения перегонки.

---
#define PWM_LOW_VALUE 10
// Минимальное значение ШИМ (в процентах) для поддержания потока воды насосом.

---
#define PWM_START_VALUE 40
// Начальное значение ШИМ (в процентах), обеспечивающее надежный запуск насоса.

---
#define HEAT_DELTA 1
// Порог разницы между целевой и текущей температурой, при котором нагрев ведется на полную мощность (режим разгона для пиво/су-вид).

---
#define ACCELERATION_HEATER_DELTA 4
// Порог разницы температур, при превышении которого включается разгонный ТЭН через реле4 при использовании UART-регулятора.

---
#define BOILING_TEMP 98.9
// Температура кипения в режиме "пиво", используемая как эталон для контроля процесса.

---
#define SAMOVAR_USE_BLYNK
// Макрос включения поддержки Blynk — платформы визуализации и удалённого управления.

---
#define BLYNK_SAMOVAR_TOOL "samovar-tool.ru"
// Адрес локального сервера Blynk, используемого вместо облачного сервиса.

---
#define SAMOVAR_USE_POWER
// Включение поддержки регулятора напряжения (например, KVIC, РМВК, SEM_AVR) для управления мощностью нагрева.

---
#define KVIC_USE_9600
// Использование скорости UART 9600 для регулятора KVIC (новые версии); иначе — 38400.

---
#define SAMOVAR_USE_RMVK
// Активация поддержки регулятора РМВК с управлением по UART.

---
#define SAMOVAR_USE_SEM_AVR
// Активация поддержки регулятора мощности SEM_AVR с управлением по UART.

---
#define NBK_MULT_PAUSE_OVERFLOW 2
// Множитель инерции, определяющий длительность паузы после захлёба в системе НБК.

---
#define NBK_PUMP_LIMIT 30
// Максимальная производительность насоса браги (в л/ч) для оптимизации работы НБК.

---
#define NBK_DEFAULT_PROGRAM "H;1;0\nS;10;2000\nO;0;0\nW;0;0\n"
// Программа по умолчанию для НБК. Значения зависят от типа регулятора (вольты или ватты).

---
#define SAMOVAR_USE_POWER_START_TIME 2000
// Задержка (в мс) перед отправкой команды разгона регулятору, чтобы обеспечить его полную инициализацию.

---
#define USE_WATERSENSOR
// Включение контроля потока охлаждающей воды. При отсутствии потока в течение заданного времени нагрев отключается.

---
#define WF_CALIBRATION 98
// Коэффициент калибровки датчика потока: F = 98 * Q (л/мин). Используется для перевода импульсов в расход.

---
#define USE_HEAD_LEVEL_SENSOR
// Включение датчика уровня флегмы в головке колонны (типа P-N-P) для контроля захлёбывания.

---
#define IGNORE_HEAD_LEVEL_SENSOR_SETTING
// Отключает проверку датчика уровня флегмы при старте системы.

---
#define WHLS_HIGH_PULL
// Включает подтягивающий резистор для датчика уровня флегмы.

---
#define USE_WATER_PUMP
// Активирует управление насосом охлаждения через ШИМ.

---
#define USE_WATER_VALVE LOW
// Определяет логический уровень для открытия электромагнитного клапана подачи воды.

---
#define USE_ALARM_BTN
// Включает обработку сигнала с аварийной кнопки.

---
#define USE_BODY_TEMP_AUTOSET
// Активирует автоматическую подстройку температуры тела при отборе фракций.

---
#define USE_BME680
// Подключает датчик BME680 для измерения давления, температуры и влажности.

---
#define USE_BTN
// Включает поддержку кнопки управления на передней панели.

---
#define USE_UPDATE_OTA
// Активирует возможность обновления прошивки по Wi-Fi (OTA).

---
#define USE_TELEGRAM
// Включает отправку уведомлений через Telegram-бота.

---
#define NOT_USE_INTERFACE_UPDATE
// Отключает обновление интерфейса в режиме реального времени (для экономии ресурсов).

---
#define KVIC_DEBUG
// Включает режим отладки для регулятора KVIC (вывод UART-логов).

---
#define USE_PRESSURE_XGZ 32
// Активирует датчик давления XGZP6897D с адресом 0x32 по I2C.

---
#define USE_PRESSURE_1WIRE {0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x55}
// Указывает ROM-адрес 1-Wire датчика давления.

---
#define USE_PRESSURE_MPX
// Подключает аналоговый датчик давления MPX5010D.

---
#define USE_STEPPER_ACCELERATION
// Включает плавное ускорение и торможение шагового двигателя.

---
#define STEPPER_REVERSE
// Инвертирует направление вращения шагового двигателя.

---
#define I2CStepperStepMl 16000
// Количество шагов I2C-степпера на миллилитр дистиллята.

---
#define COLUMN_WETTING
// Активирует режим предварительного смачивания насадки колонны.

---
#define WETTING_POWER 220
// Мощность нагрева (в ваттах) при смачивании насадки.

---
void reduceVoltageOnSensorTrigger()
// Снижает выходное напряжение на 3 вольта при срабатывании датчика уровня флегмы
Аргументы
Отсутствуют
Возвращает
void
Исключения
Отсутствуют

---
class PressureSensor
// Абстракция датчика давления с поддержкой нескольких типов (BME680, XGZP6897D, 1-Wire, MPX5010D)
Поля
sensorType — Тип подключенного датчика давления, определяемый через макрос
address — Адрес датчика на шине (для I2C или 1-Wire)
Методы
readPressure() — Возвращает текущее значение давления в кПа
init() — Инициализирует датчик в соответствии с выбранным типом

---
class WaterPumpController
// Управляет работой водяного насоса через ШИМ-сигнал и клапаном при необходимости
Поля
pwmPin — Пин управления ШИМ насоса
valvePin — Пин управления электромагнитным клапаном (если используется)
dutyCycle — Уровень ШИМ (0–255), регулирующий напор
Методы
startPump(uint8_t power) — Запускает насос с заданной мощностью
stopPump() — Останавливает насос
openValve() — Открывает клапан подачи воды
closeValve() — Закрывает клапан

---
class AlarmButton
// Обрабатывает сигнал с аварийной кнопки или датчиков протечки
Поля
pin — Номер пина, к которому подключена кнопка/датчик
isActive — Флаг активного состояния (LOW или HIGH)
Методы
check() — Проверяет состояние кнопки и при срабатывании останавливает систему
trigger() — Принудительно активирует аварийное отключение

---
class TemperatureController
// Реализует автоматическую коррекцию температуры тела при отборе фракций
Поля
currentTemp — Текущая температура в кубе
targetTemp — Целевая температура для текущего этапа
autoSetEnabled — Флаг включения автоматической подстройки
Методы
adjustBodyTemp() — Корректирует мощность нагрева на основе анализа температурного графика
setTarget(float temp) — Устанавливает целевую температуру

---
class OTAUpdater
// Обеспечивает возможность обновления прошивки по Wi-Fi
Методы
init(const char* ssid, const char* password) — Инициализирует OTA-сервер
handle() — Обрабатывает входящие соединения для обновления
Возвращает
true при успешном обновлении, иначе false

---
class TelegramNotifier
// Отправляет уведомления пользователю через Telegram-бота
Поля
botToken — Токен Telegram-бота
chatId — Идентификатор получателя
Методы
sendMessage(String message) — Отправляет текстовое сообщение в Telegram
notifyAlert(String alert) — Отправляет аварийное уведомление

---
class StepperMotor
// Управляет шаговым двигателем с поддержкой ускорения и реверса
Поля
stepsPerMl — Количество шагов на миллилитр дистиллята
reverseDirection — Флаг реверса направления вращения
accelerationEnabled — Включено ли плавное ускорение
Методы
moveToVolume(float ml) — Перемещает двигатель к указанному объему
enableAcceleration() — Включает плавный старт и торможение
reverse() — Изменяет направление вращения

---
class ColumnWetting
// Обеспечивает смачивание насадки колонны перед началом ректификации
Поля
wettingPower — Мощность нагрева при смачивании (по умолчанию 220)
targetLevel — Целевой уровень флегмы для завершения смачивания
Методы
startWetting() — Запускает процесс смачивания насадки
isComplete() — Возвращает true, если колонна достаточно увлажнена
