# Blynk

Модуль обеспечивает интеграцию устройства «Самовар» с платформой Blynk для удалённого мониторинга и управления через веб-интерфейс. Реализованы функции чтения температур, давления, объёмов, статусов и режимов работы, а также управления мощностью, насосом и программами. Поддерживается Lua-терминал для выполнения пользовательских скриптов при включённой опции USE_LUA.

Ключевые структуры данных  
Samovar_Mode — текущий режим работы устройства (пиво, дистилляция, НБК и др.)  
PowerOn — флаг включения нагрева  
PauseOn — флаг паузы отбора  
SAMOVAR_VERSION — строка версии прошивки  
sam_command_sync — Переменная, хранящая текущую команду синхронизации для управления состоянием самовара

BLYNK_READ(V0)  
Отправляет в интерфейс Blynk температуру паров, статус нагрева, запуска и паузы  
Аргументы  
V0 — виртуальный пин Blynk для температуры пара и статусов  
Возвращает  
Ничего не возвращает, отправляет данные через Blynk.virtualWrite  
Исключения  
Нет

---
BLYNK_READ(V1)  
Отправляет в интерфейс Blynk температуру в трубе отбора  
Аргументы  
V1 — виртуальный пин Blynk  
Возвращает  
Ничего не возвращает, отправляет данные через Blynk.virtualWrite  
Исключения  
Нет

---
BLYNK_READ(V25)  
Отправляет в интерфейс Blynк температуру в точке АЦП (доп. датчик)  
Аргументы  
V25 — виртуальный пин Blynk  
Возвращает  
Ничего не возвращает, отправляет данные через Blynk.virtualWrite  
Исключения  
Нет

---
BLYNK_READ(V2)  
Отправляет прогресс отбора (в процентах)  
Аргументы  
V2 — виртуальный пин Blynk  
Возвращает  
Ничего не возвращает, отправляет данные через Blynk.virtualWrite  
Исключения  
Нет

---
BLYNK_READ(V5)  
Отправляет атмосферное давление с датчика BME  
Аргументы  
V5 — виртуальный пин Blynk  
Возвращает  
Ничего не возвращает, отправляет данные через Blynk.virtualWrite  
Исключения  
Нет

---
BLYNK_READ(V6)  
Отправляет температуру воды в кубе  
Аргументы  
V6 — виртуальный пин Blynk  
Возвращает  
Ничего не возвращает, отправляет данные через Blynk.virtualWrite  
Исключения  
Нет

---
BLYNK_READ(V7)  
Отправляет температуру в ёмкости (охладитель/приёмник)  
Аргументы  
V7 — виртуальный пин Blynk  
Возвращает  
Ничего не возвращает, отправляет данные через Blynk.virtualWrite  
Исключения  
Нет

---
BLYNK_READ(V8)  
Отправляет текущий объём жидкости в приёмнике  
Аргументы  
V8 — виртуальный пин Blynk  
Возвращает  
Ничего не возвращает, отправляет данные через Blynk.virtualWrite  
Исключения  
Нет

---
BLYNK_READ(V9)  
Отправляет текущую скорость отбора (мл/час)  
Аргументы  
V9 — виртуальный пин Blynk  
Возвращает  
Ничего не возвращает, отправляет данные через Blynk.virtualWrite  
Исключения  
Нет

---
BLYNK_READ(V10)  
Отправляет время текущего и общего отбора в формате "часы; общие часы"  
Аргументы  
V10 — виртуальный пин Blynk  
Возвращает  
Ничего не возвращает, отправляет данные через Blynk.virtualWrite  
Исключения  
Нет

---
BLYNK_READ(V11)  
Отправляет строку текущего состояния (например, "Греется", "Отбор")  
Аргументы  
V11 — виртуальный пин Blynк  
Возвращает  
Ничего не возвращает, отправляет данные через Blynk.virtualWrite  
Исключения  
Нет

---
BLYNK_READ(V14)  
Отправляет текстовое описание текущего статуса устройства  
Аргументы  
V14 — виртуальный пин Blynk  
Возвращает  
Ничего не возвращает, отправляет данные через Blynk.virtualWrite  
Исключения  
Нет

---
BLYNK_READ(V15)  
Отправляет IP-адрес устройства в локальной сети  
Аргументы  
V15 — виртуальный пин Blynk  
Возвращает  
Ничего не возвращает, отправляет данные через Blynk.virtualWrite  
Исключения  
Нет

---
BLYNK_READ(V19)  
Отправляет версию прошивки Самовара  
Аргументы  
V19 — виртуальный пин Blynk  
Возвращает  
Ничего не возвращает, отправляет данные через Blynk.virtualWrite  
Исключения  
Нет

---
BLYNK_READ(V20)  
Отправляет текущий режим работы устройства  
Аргументы  
V20 — виртуальный пин Blynk  
Возвращает  
Ничего не возвращает, отправляет данные через Blynk.virtualWrite  
Исключения  
Нет

---
BLYNK_READ(V24)  
Отправляет текущую программу в зависимости от режима (пиво, дистилляция и др.)  
Аргументы  
V24 — виртуальный пин Blynk  
Возвращает  
Ничего не возвращает, отправляет данные через Blynk.virtualWrite  
Исключения  
Нет

---
BLYNK_READ(V23)  
Отправляет значение давления с одного из поддерживаемых датчиков (XGZ, MPX, 1-Wire)  
Аргументы  
V23 — виртуальный пин Blynк  
Возвращает  
Ничего не возвращает, отправляет данные через Blynk.virtualWrite  
Исключения  
Нет

---
BLYNK_READ(V21)  
Отправляет текущее и целевое напряжение питания (при использовании регулировки мощности)  
Аргументы  
V21 — виртуальный пин Blynк  
Возвращает  
Ничего не возвращает, отправляет данные через Blynk.virtualWrite  
Исключения  
Нет

---
BLYNK_READ(V16)  
Отправляет целевое напряжение питания (мощность)  
Аргументы  
V16 — виртуальный пин Blynк  
Возвращает  
Ничего не возвращает, отправляет данные через Blynk.virtualWrite  
Исключения  
Нет

---
BLYNK_WRITE(V16)  
Устанавливает целевую мощность нагрева по значению с виртуального пина  
Аргументы  
V16 — виртуальный пин Blynk, значение в вольтах  
param — входное значение (float)  
Возвращает  
Ничего не возвращает, вызывает set_current_power  
Исключения  
Нет

---
BLYNK_WRITE(V17)  
Устанавливает скорость насоса на основе заданной скорости отбора (мл/час)  
Аргументы  
V17 — виртуальный пин Blynk, значение в мл/час  
param — входное значение (float)  
Возвращает  
Ничего не возвращает, вызывает set_pump_speed  
Исключения  
Нет

---
BLYNK_WRITE(V18)  
Инициирует установку температуры тела (для калибровки)  
Аргументы  
V18 — виртуальный пин Blynk  
param — не используется  
Возвращает  
Ничего не возвращает, вызывает set_body_temp  
Исключения  
Нет

---
BLYNK_WRITE(V12)  
Обрабатывает команду перехода к следующему этапу в зависимости от режима  
Аргументы  
V12 — виртуальный пин Blynk  
param — состояние (1 — выполнить переход)  
Возвращает  
Ничего не возвращает, устанавливает sam_command_sync  
Исключения  
Нет

---
BLYNK_WRITE(V13)  
Переключает паузу отбора и сбрасывает таймер ожидания  
Аргументы  
param — Входной параметр от Blynk (не используется напрямую, значение берётся как !PauseOn)  
Возвращает  
Ничего не возвращает  
Исключения  
Нет исключений

---
BLYNK_WRITE(V3)  
Запускает самовар при включённом питании и значении 1, иначе сбрасывает состояние  
Аргументы  
param — Входное значение с виртуального пина V3  
Возвращает  
Ничего не возвращает  
Исключения  
Нет исключений

---
BLYNK_WRITE(V4)  
Устанавливает режим работы самовара в зависимости от текущего режима и состояния питания  
Аргументы  
param — Входной параметр от Blynk (не используется напрямую)  
Возвращает  
Ничего не возвращает  
Исключения  
Нет исключений

---
#ifdef USE_LUA  
BLYNK_WRITE(V22)  
Выполняет Lua-скрипт, переданный через терминал Blynk  
Аргументы  
V22 — виртуальный пин терминала  
param — строка с Lua-кодом  
Возвращает  
Ничего не возвращает, выводит результат в терминал  
Исключения  
Нет  
#endif

---
#ifdef USE_LUA  
run_lua_string(String lstr)  
Выполняет строку Lua-кода и возвращает сообщение об ошибке при неудаче  
Аргументы  
lstr — строка с Lua-скриптом  
Возвращает  
Пустая строка при успехе, описание ошибки при сбое  
Исключения  
Нет  
#endif
