# SamovarMqtt

/**
 * @brief Модуль управления MQTT-клиентом для устройства Samovar.
 *
 * Обеспечивает подключение к MQTT-брокеру, публикацию сообщений и обработку событий подключения/отключения.
 * Используется для удалённой передачи данных и уведомлений через MQTT-топики с префиксом, зависящим от идентификатора устройства.
 * Поддерживает автоматическое восстановление соединения и версионирование отправляемых сообщений.
 *
 * Ключевые структуры данных
 * mqttClient — Асинхронный MQTT-клиент для взаимодействия с брокером.
 * mqttstr — Буфер для формирования базового MQTT-топика (начинается с "SMV/").
 * mqttstr1 — Временный буфер для построения полного пути топика при отправке сообщений.
 * mqttUser — Имя пользователя для аутентификации на MQTT-брокере.
 * mqttPassword — Пароль для аутентификации на MQTT-брокере.
 * send_mqtt — Флаг, разрешающий или запрещающий отправку MQTT-сообщений (определяется по длине Blynk-токена).
 * chipId — Уникальный идентификатор чипа (предполагается, что объявлен где-то в Samovar.h).
 * SamSetup — Глобальная структура настроек устройства, содержащая, в том числе, Blynk-аутентификатор.
 * WriteConsoleLog — Функция логирования строк в консоль (предполагается внешним объявлением).
 * SendMsg — Функция отправки сообщений указанного типа (используется для уведомлений и тревог).
 * MESSAGE_TYPE — Тип сообщения для функции SendMsg (предполагается определённым в Samovar.h).
 */

#define PAYLOADSIZE 256
@brief Максимальный размер полезной нагрузки MQTT-сообщения (в байтах).

---
void initMqtt()
@brief Инициализирует MQTT-клиент и начинает подключение к брокеру.
@details Настраивает параметры подключения: идентификатор клиента, учётные данные, сервер, обработчики событий. Формирует базовый топик на основе Blynk-аутентификатора. Если аутентификатор слишком короткий — отключает отправку.
Аргументы
Возвращает
Исключения

---
void connectToMqtt()
@brief Инициирует асинхронное подключение к MQTT-брокеру.
@details Не блокирует выполнение; подключение происходит в фоне через AsyncMqttClient.
Аргументы
Возвращает
Исключения

---
void onMqttConnect(bool sessionPresent)
@brief Обработчик успешного подключения к MQTT-брокеру.
Аргументы
sessionPresent — указывает, существует ли активная сессия (восстановление соединения).
@details При включённой отладке отправляет уведомление и записывает лог.
Возвращает
Исключения

---
void onMqttDisconnect(AsyncMqttClientDisconnectReason reason)
@brief Обработчик отключения от MQTT-брокера.
Аргументы
reason — причина отключения (код из AsyncMqttClientDisconnectReason).
@details При включённой отладке формирует сообщение с кодом причины и отправляет тревогу.
Возвращает
Исключения

---
void onMqttPublish(uint16_t packetId)
@brief Обработчик подтверждения публикации сообщения.
Аргументы
packetId — идентификатор пакета, для которого получено подтверждение.
Возвращает
Исключения

---
void MqttSendMsg(const String &Str, const char *chart, int version)
@brief Отправляет строку в виде MQTT-сообщения в заданный подтопик с указанием версии.
@details Формирует полный топик как "SMV/{blynkauth}/{chart}/{version}", публикует сообщение с QoS=2 и retain=true. Если публикация не удалась, пытается переподключиться и повторить отправку.
Аргументы
Str — строка с данными для отправки.
chart — подтопик (например, название параметра или канала).
version — версия формата сообщения (число, добавляется в топик).
@pre send_mqtt должен быть true, иначе функция немедленно завершается.
@note Использует глобальные буферы mqttstr1 и payload; не является потокобезопасной.
Возвращает
Исключения

---
void SendMsg(const String& m, MESSAGE_TYPE msg_type)
@brief Отправляет сообщение через системный механизм уведомлений.
Аргументы
m — текст сообщения.
msg_type — тип сообщения (например, уведомление или тревога).
@details Предполагается, что реализация находится вне данного модуля.
Возвращает
Исключения

---
void onMqttSubscribe(AsyncMqttClientMessageProperties properties, char* topic, char* payload, AsyncMqttClientPayloadLength payloadLength, size_t index, size_t total)
@brief Обработчик входящих MQTT-сообщений (заглушка, не используется в текущей реализации).
@details Функция объявлена, но не подключена к клиенту. Предназначена для приёма команд.
Аргументы
properties — свойства входящего сообщения (QoS, retain и др.).
topic — указатель на строку топика.
payload — указатель на данные сообщения.
payloadLength — длина полезной нагрузки.
index — текущий индекс фрагмента (для фрагментированных сообщений).
total — общая длина сообщения (в байтах).
Возвращает
Исключения

---
void onMqttUnsubscribe(uint16_t packetId)
@brief Обработчик отмены подписки на топик (заглушка, не используется).
@details Не реализован, вызов не подключён.
Аргументы
packetId — идентификатор пакета отмены подписки.
Возвращает
Исключения

---
class AsyncMqttClient
@brief Асинхронный MQTT-клиент для ESP32/ESP8266.
@details Управляет подключением к MQTT-брокеру, подпиской на топики, публикацией сообщений. Работает без блокировок, использует callback-интерфейс.
Поля
Методы
void onConnect(OnConnectCallback callback) — устанавливает обработчик подключения.
void onDisconnect(OnDisconnectCallback callback) — устанавливает обработчик отключения.
void onPublish(OnPublishCallback callback) — устанавливает обработчик подтверждения публикации.
void setCredentials(const char* username, const char* password) — задаёт учётные данные.
void setServer(const char* hostname, uint16_t port) — задаёт адрес и порт брокера.
void setClientId(const char* clientId) — задаёт идентификатор клиента.
void setMaxTopicLength(size_t length) — устанавливает максимальную длину топика.
bool connected() — возвращает true, если клиент подключён.
void connect() — инициирует подключение.
uint16_t publish(const char* topic, uint8_t qos, bool retain, const char* payload) — публикует сообщение.
