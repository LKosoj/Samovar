# lua

Модуль обеспечивает выполнение скриптов Lua для управления устройством Самовар, включая управление GPIO, расширителями I2C, насосами, шаговыми двигателями и другими периферийными компонентами. Скрипты Lua используются для реализации пользовательской логики работы устройства в различных режимах. Модуль интегрируется с основной системой через задачу FreeRTOS и предоставляет безопасные обёртки для вызова аппаратных функций из Lua-скриптов.

Ключевые структуры данных  
luaObj — карта для хранения пользовательских переменных Lua в формате ключ-значение  
SAMOVAR_MODE — перечисление, определяющее текущий режим работы самовара (дистилляция, ректификация, пиво и т.д.)  
SamovarStatusInt — целочисленное представление текущего состояния самовара, доступное из Lua  
program — массив структур, содержащих параметры программ (объём, скорость, температура и т.д.)  
SamSetup — структура настроек устройства, включая часовой пояс  
lua_timer — массив временных меток для отслеживания таймеров (9 доступных слотов)  
asyncHTTPrequest — Класс для выполнения асинхронных HTTP-запросов с таймаутами и обработкой ответов  
lua_State — контекст выполнения Lua-машины, используемый для обмена данными между C и Lua

---
lua_wrapper_pinMode(lua_State *lua_state)  
Обёртка для функции pinMode(), доступная в Lua-скриптах.  
Аргументы  
lua_state — указатель на состояние Lua; ожидает два аргумента: номер пина и режим (INPUT/OUTPUT)  
Возвращает  
0 — всегда возвращает 0 (ничего не возвращает в Lua)

---
lua_wrapper_digitalWrite(lua_State *lua_state)  
Обёртка для функции digitalWrite(), доступная в Lua-скриптах.  
Аргументы  
lua_state — указатель на состояние Lua; ожидает два аргумента: номер пина и значение (HIGH/LOW)  
Возвращает  
0 — всегда возвращает 0 (ничего не возвращает в Lua)

---
lua_wrapper_digitalRead(lua_State *lua_state)  
Обёртка для функции digitalRead(), доступная в Lua-скриптах.  
Аргументы  
lua_state — указатель на состояние Lua; ожидает один аргумент: номер пина  
Возвращает  
1 — возвращает значение пина (0 или 1) в стек Lua

---
lua_wrapper_analogRead(lua_State *lua_state)  
Обёртка для функции analogRead(), доступная в Lua-скриптах.  
Аргументы  
lua_state — указатель на состояние Lua; ожидает один аргумент: номер пина  
Возвращает  
1 — возвращает аналоговое значение пина в стек Lua

---
lua_wrapper_exp_pinMode(lua_State *lua_state)  
Обёртка для pinMode() на I2C-расширителе, доступная в Lua-скриптах.  
Аргументы  
lua_state — указатель на состояние Lua; ожидает два аргумента: номер пина расширителя и режим  
Возвращает  
0 — всегда возвращает 0 (ничего не возвращает в Lua)  
Исключения  
Функция ничего не возвращает при таймауте семафора I2C

---
lua_wrapper_exp_digitalWrite(lua_State *lua_state)  
Обёртка для digitalWrite() на I2C-расширителе, доступная в Lua-скриптах.  
Аргументы  
lua_state — указатель на состояние Lua; ожидает два аргумента: номер пина и значение  
Возвращает  
0 — всегда возвращает 0 (ничего не возвращает в Lua)  
Исключения  
Функция ничего не делает при таймауте семафора I2C

---
lua_wrapper_exp_digitalRead(lua_State *lua_state)  
Обёртка для digitalRead() на I2C-расширителе, доступная в Lua-скриптах.  
Аргументы  
lua_state — указатель на состояние Lua; ожидает один аргумент: номер пина  
Возвращает  
1 — возвращает значение пина (0 или 1) в стек Lua  
Исключения  
Функция возвращает 0 при таймауте семафора I2C

---
lua_wrapper_exp_analogWrite(lua_State *lua_state)  
Обёртка для analogWrite() на аналоговом I2C-расширителе, доступная в Lua-скриптах.  
Аргументы  
lua_state — указатель на состояние Lua; ожидает один аргумент: значение ШИМ  
Возвращает  
0 — всегда возвращает 0 (ничего не возвращает в Lua)  
Исключения  
Функция ничего не делает при таймауте семафора I2C

---
lua_wrapper_exp_analogRead(lua_State *lua_state)  
Обёртка для analogRead() на аналоговом I2C-расширителе, доступная в Lua-скриптах.  
Аргументы  
lua_state — указатель на состояние Lua; ожидает один аргумент: номер канала  
Возвращает  
1 — возвращает аналоговое значение канала в стек Lua  
Исключения  
Функция возвращает 0 при таймауте семафора I2C

---
lua_wrapper_delay(lua_State *lua_state)  
Обёртка для vTaskDelay(), обеспечивает задержку в миллисекундах из Lua-скрипта.  
Аргументы  
lua_state — указатель на состояние Lua; ожидает один аргумент: время задержки в мс  
Возвращает  
0 — всегда возвращает 0 (ничего не возвращает в Lua)

---
lua_wrapper_millis(lua_State *lua_state)  
Обёртка для функции millis(), возвращает время с момента запуска системы.  
Аргументы  
lua_state — указатель на состояние Lua  
Возвращает  
1 — возвращает текущее время в миллисекундах в стек Lua

---
lua_wrapper_set_pause_withdrawal(lua_State *lua_state)  
Обёртка для приостановки отбора дистиллята из Lua-скрипта.  
Аргументы  
lua_state — указатель на состояние Lua; ожидает один аргумент: 1 — приостановить, 0 — возобновить  
Возвращает  
0 — всегда возвращает 0 (ничего не возвращает в Lua)

---
lua_wrapper_set_power(lua_State *lua_state)  
Обёртка для включения/выключения нагрева с синхронизацией команд.  
Аргументы  
lua_state — указатель на состояние Lua; ожидает один аргумент: 1 — включить, 0 — выключить  
Возвращает  
0 — всегда возвращает 0 (ничего не возвращает в Lua)

---
int lua_wrapper_set_samovar_mode(lua_State *lua_state)  
Устанавливает режим работы самовара на основе переданного значения из Lua.  
Аргументы  
lua_state — указатель на состояние Lua, содержит аргументы вызова  
Возвращает  
0 — всегда возвращает 0, соответствует количеству возвращаемых значений в Lua

---
int lua_wrapper_set_mixer(lua_State *lua_state)  
Управляет положением смесителя, устанавливая его в заданное положение.  
Аргументы  
lua_state — указатель на состояние Lua, первый аргумент — целое число (позиция смесителя)  
Возвращает  
0 — всегда возвращает 0

---
int lua_wrapper_open_valve(lua_State *lua_state)  
Открывает или закрывает клапан в зависимости от переданного значения.  
Аргументы  
lua_state — указатель на состояние Lua, первый аргумент — булево значение (true — открыть, false — закрыть)  
Возвращает  
0 — всегда возвращает 0

---
int lua_wrapper_set_current_power(lua_State *lua_state)  
Устанавливает текущую мощность нагрева (доступно только при определённой конфигурации).  
Аргументы  
lua_state — указатель на состояние Lua, первый аргумент — число с плавающей точкой (мощность в долях от максимума)  
Возвращает  
0 — всегда возвращает 0

---
int lua_wrapper_set_alarm(lua_State *lua_state)  
Активирует сигнал тревоги или предупреждения.  
Аргументы  
lua_state — указатель на состояние Lua  
Возвращает  
0 — всегда возвращает 0

---
int lua_wrapper_set_body_temp(lua_State *lua_state)  
Инициирует установку температуры корпуса (используется в алгоритмах контроля).  
Аргументы  
lua_state — указатель на состояние Lua  
Возвращает  
0 — всегда возвращает 0

---
int lua_wrapper_set_next_program(lua_State *lua_state)  
Переходит к следующему этапу программы в зависимости от текущего режима самовара.  
Аргументы  
lua_state — указатель на состояние Lua  
Возвращает  
0 — всегда возвращает 0

---
int lua_wrapper_get_state(lua_State *lua_state)  
Возвращает текущее состояние самовара в виде целого числа.  
Аргументы  
lua_state — указатель на состояние Lua  
Возвращает  
1 — количество возвращаемых значений (текущее состояние SamovarStatusInt)

---
int lua_wrapper_send_msg(lua_State *lua_state)  
Отправляет сообщение в лог или внешнюю систему оповещения.  
Аргументы  
lua_state — указатель на состояние Lua, первый аргумент — сообщение (любой тип), второй — тип сообщения (MESSAGE_TYPE)  
Возвращает  
0 — всегда возвращает 0

---
int lua_wrapper_set_num_variable(lua_State *lua_state)  
Устанавливает значение числовой переменной по её имени из Lua-скрипта.  
Аргументы  
lua_state — указатель на состояние Lua, первый аргумент — имя переменной, второй — значение (число)  
Возвращает  
0 — всегда возвращает 0

---
int lua_wrapper_get_num_variable(lua_State *lua_state)  
Получает значение числовой переменной по её имени и возвращает в Lua.  
Аргументы  
lua_state — указатель на состояние Lua, первый аргумент — имя переменной  
Возвращает  
1 — количество возвращаемых значений (числовое значение переменной)

---
int lua_wrapper_get_numeric_variable(lua_State *lua_state)  
Возвращает числовое значение системной переменной по её имени из Lua  
Аргументы  
lua_state — указатель на состояние Lua-машины, содержащее имя переменной в стеке  
Возвращает  
Количество возвращаемых значений в стеке Lua (всегда 1 — числовое значение)  
Исключения  
Логирует предупреждение при обращении к неизвестной переменной

---
int lua_wrapper_set_str_variable(lua_State *lua_state)  
Устанавливает значение строковой системной переменной из Lua  
Аргументы  
lua_state — указатель на состояние Lua-машины с именем и значением переменной в стеке  
Исключения  
Логирует предупреждение при попытке установить неизвестную или только для чтения переменную

---
int lua_wrapper_set_object(lua_State *lua_state)  
Сохраняет строковое значение в пользовательский объект хранения luaObj  
Аргументы  
lua_state — указатель на состояние Lua-машины, содержит имя и значение в стеке  
Возвращает  
0 — количество возвращаемых значений в стеке Lua

---
int lua_wrapper_get_object(lua_State *lua_state)  
Возвращает строковое значение из пользовательского объекта luaObj по ключу  
Аргументы  
lua_state — указатель на состояние Lua-машины, содержит ключ и опциональный тип  
Возвращает  
1 — количество возвращаемых значений (строка из объекта или "0" для NUMERIC при пустом значении)

---
int lua_wrapper_set_lua_status(lua_State *lua_state)  
Устанавливает глобальный статус Lua-скрипта  
Аргументы  
lua_state — указатель на состояние Lua-машины, содержит новое значение статуса  
Возвращает  
0 — количество возвращаемых значений в стеке Lua

---
int lua_wrapper_set_capacity(lua_State *lua_state)  
Устанавливает текущую ёмкость системы  
Аргументы  
lua_state — указатель на состояние Lua-машины, содержит числовое значение ёмкости  
Возвращает  
0 — количество возвращаемых значений в стеке Lua

---
int lua_wrapper_set_pump_pwm(lua_State *lua_state)  
Устанавливает ШИМ-сигнал для водяного насоса (доступно при определении USE_WATER_PUMP)  
Аргументы  
lua_state — указатель на состояние Lua-машины, содержит значение ШИМ (0–255)  
Возвращает  
0 — количество возвращаемых значений в стеке Lua

---
int lua_wrapper_set_timer(lua_State *lua_state)  
Запускает таймер с задержкой в секундах  
Аргументы  
lua_state — указатель на состояние Lua-машины, содержит номер таймера (1–9) и время в секундах  
Возвращает  
0 — количество возвращаемых значений в стеке Lua (если номер таймера неверен — без действия)

---
int lua_wrapper_get_timer(lua_State *lua_state)  
Возвращает оставшееся время указанного таймера в миллисекундах  
Аргументы  
lua_state — указатель на состояние Lua-машины, содержит номер таймера (1–9)  
Возвращает  
1 — количество возвращаемых значений (оставшееся время в мс или 0, если таймер неактивен)

---
int lua_wrapper_get_free_heap(lua_State *lua_state)  
Возвращает объём свободной кучи в килобайтах.  
Возвращает  
Объём свободной памяти в килобайтах (lua_Number)

---
int lua_wrapper_get_str_variable(lua_State *lua_state)  
Получает значение строковой переменной по её имени из глобального контекста.  
Аргументы  
1 — Имя переменной (строка), поддерживает: "Msg", "SamovarStatus", "test_str_val", "program_type"  
Возвращает  
Значение переменной как строка; при неизвестной переменной — логирование и возврат пустого результата

---
int lua_wrapper_http_request(lua_State *lua_state)  
Выполняет HTTP-запрос (GET или произвольный метод) с таймаутами и возвращает ответ.  
Аргументы  
1 — URL (строка)  
2 — Тип запроса (опционально, строка, например "POST")  
3 — Заголовок Content-Type (опционально)  
4 — Тело запроса (опционально, строка)  
Возвращает  
Текст ответа или "error" при таймауте, ошибке соединения или некорректном количестве аргументов

---
int lua_wrapper_set_stepper_by_time(lua_State *lua_state)  
Устанавливает работу шагового двигателя на заданное время.  
Аргументы  
1 — Скорость (шаги в секунду, uint16_t)  
2 — Направление (0 или 1, uint8_t)  
3 — Время работы в миллисекундах (uint16_t)  
Возвращает  
Результат вызова set_stepper_by_time (lua_Number, 1 при успехе, 0 при ошибке)

---
int lua_wrapper_set_stepper_target(lua_State *lua_state)  
Устанавливает целевое положение шагового двигателя.  
Аргументы  
1 — Скорость (шаги в секунду, uint16_t)  
2 — Направление (0 или 1, uint8_t)  
3 — Целевое количество шагов (uint32_t)  
Возвращает  
Результат вызова set_stepper_target (lua_Number)

---
int lua_wrapper_get_stepper_status(lua_State *lua_state)  
Получает текущий статус шагового двигателя.  
Возвращает  
Текущий статус двигателя (0 — остановлен, 1 — движение, lua_Number)

---
int lua_wrapper_i2cpump_start(lua_State *lua_state)  
Запускает I2C-насос на заданную скорость и объём.  
Аргументы  
1 — Скорость подачи (float, относительная величина 0.0–1.0)  
2 — Объём в мл (float, должен быть больше 0)  
Возвращает  
Результат вызова set_stepper_target (lua_Number, 1 при успехе, 0 при ошибке или отсутствии I2C-устройства)

---
int lua_wrapper_i2cpump_stop(lua_State *lua_state)  
Останавливает I2C-насос и сбрасывает целевые параметры.  
Возвращает  
0, если устройство не является I2C-насосом; иначе — результат остановки (неявно через set_stepper_target)

---
int lua_wrapper_i2cpump_get_speed(lua_State *lua_state)  
Возвращает текущую скорость I2C-насоса в шагах в секунду  
Аргументы  
lua_state — указатель на состояние Lua  
Возвращает  
Текущая скорость насоса (число); 0, если I2C-устройство не активно  
Исключения  
— функция не генерирует исключения

---
int lua_wrapper_i2cpump_get_target_ml(lua_State *lua_state)  
Возвращает целевой объём дозирования в миллилитрах  
Аргументы  
lua_state — указатель на состояние Lua  
Возвращает  
Целевой объём в мл (число); 0, если I2C-устройство не активно  
Исключения  
— функция не генерирует исключения

---
int lua_wrapper_i2cpump_get_remaining_ml(lua_State *lua_state)  
Возвращает оставшийся объём жидкости для дозирования в миллилитрах  
Аргументы  
lua_state — указатель на состояние Lua  
Возвращает  
Оставшийся объём в мл (число); 0, если I2C-устройство не активно  
Исключения  
— функция не генерирует исключения

---
int lua_wrapper_i2cpump_get_running(lua_State *lua_state)  
Проверяет, работает ли насос в данный момент  
Аргументы  
lua_state — указатель на состояние Lua  
Возвращает  
1, если насос работает (скорость > 0 и остаток шагов > 0); иначе 0  
Исключения  
— функция не генерирует исключения

---
int lua_wrapper_set_mixer_pump_target(lua_State *lua_state)  
Устанавливает целевое положение миксерного насоса  
Аргументы  
lua_state — указатель на состояние Lua, содержит целевое значение (целое число)  
Возвращает  
Установленное значение (число)  
Исключения  
— функция не генерирует исключения

---
int lua_wrapper_get_mixer_pump_status(lua_State *lua_state)  
Возвращает текущее состояние миксерного насоса  
Аргументы  
lua_state — указатель на состояние Lua  
Возвращает  
Текущее состояние насоса (число)  
Исключения  
— функция не генерирует исключения

---
int lua_wrapper_check_I2C_device(lua_State *lua_state)  
Проверяет наличие I2C-устройства по заданному адресу  
Аргументы  
lua_state — указатель на состояние Lua, содержит адрес устройства (целое число)  
Возвращает  
1, если устройство отвечает; 0 в противном случае  
Исключения  
— функция не генерирует исключения

---
int lua_wrapper_set_i2c_rele_state(lua_State *lua_state)  
Устанавливает состояние реле на I2C-расширителе  
Аргументы  
lua_state — указатель на состояние Lua  
a — номер реле (целое число)  
b — желаемое состояние (0 — выключено, 1 — включено)  
Возвращает  
Результат операции (число)  
Исключения  
— функция не генерирует исключения

---
int lua_wrapper_get_i2c_rele_state(lua_State *lua_state)  
Возвращает текущее состояние указанного реле на I2C-расширителе  
Аргументы  
lua_state — указатель на состояние Lua, содержит номер реле  
Возвращает  
Текущее состояние реле (0 или 1); 0, если операция не удалась  
Исключения  
— функция не генерирует исключения

---
String get_lua_script_list()  
Возвращает список доступных скриптов для кнопок, отфильтрованных по текущему режиму  
Возвращает  
Строка в формате "имя_файла|отображаемое_имя,..." для всех файлов, начинающихся с "btn_" и соответствующих текущему режиму

---
String get_lua_script(String fn)  
Загружает содержимое Lua-скрипта из файла в SPIFFS  
Аргументы  
fn — Имя файла (с или без ведущего '/')  
Возвращает  
Содержимое файла как строку; пустая строка, если файл не найден

---
void run_lua_script(String fn)  
Подготавливает скрипт для выполнения, добавляя глобальные переменные  
Аргументы  
fn — Имя файла скрипта, который нужно запустить  
Побочный эффект  
Сохраняет подготовленный скрипт в глобальную переменную btn_script

---
String run_lua_string(String lstr)  
Выполняет переданный Lua-код как строку  
Аргументы  
lstr — Lua-код в виде строки  
Возвращает  
Сообщение об ошибке, если выполнение завершилось неудачно; иначе пустая строка  
Исключения  
Записывает ошибку в лог через WriteConsoleLog при возникновении

---
void load_lua_script()  
Загружает основные скрипты script.lua и скрипт, соответствующий текущему режиму  
Побочный эффект  
Сохраняет содержимое в глобальные переменные script1 и script2

---
void do_lua_script(void *parameter)  
Фоновая задача FreeRTOS для выполнения Lua-скриптов  
Аргументы  
parameter — Не используется (должен быть NULL)  
Побочный эффект  
Выполняет script1 и script2, если lua_finished == false; вызывает сборку мусора Lua

---
void start_lua_script()  
Инициирует выполнение основных скриптов, снимая флаг завершения  
Побочный эффект  
Устанавливает lua_finished = false, что активирует do_lua_script

---
String get_global_variables()  
Формирует строку с определениями глобальных переменных для передачи в Lua-скрипты  
Возвращает  
Строка с Lua-кодом, определяющим переменные (например, bme_pressure = 1013.25)  
Побочный эффект  
В текущей реализации возвращает пустую строку (часть кода закомментирована)

---
String getVariablesString()  
Формирует строку с текущими значениями переменных состояния устройства  
Возвращает  
Строка в формате "имя=значение\r\n", содержащая ключевые переменные состояния: флаги, времена, объёмы, температуры, статусы и настройки программ  
Исключения  
Функция не выбрасывает исключения

---
String get_lua_mode_name(bool filename)  
Возвращает имя режима или имя файла Lua-скрипта в зависимости от текущего режима работы  
Аргументы  
filename — Если true, возвращает полное имя файла с расширением .lua; иначе — краткое имя режима  
Возвращает  
Строка с именем режима ("beer", "dist", "bk", "nbk", "rect") или соответствующим именем файла (например, "/dist1.lua")  
Исключения  
Функция не выбрасывает исключения
