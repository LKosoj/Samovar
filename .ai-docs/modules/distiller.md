# distiller

Модуль реализует логику управления процессом дистилляции в устройстве "Самовар", включая контроль нагрева, насоса, клапанов, сбор данных и прогнозирование времени завершения. Поддерживает режимы питания, ПИД-регулирование скорости насоса, обработку аварийных ситуаций и интеграцию с MQTT. Работает с датчиками температуры, давления и расхода для оценки спиртуозности и объема дистиллята.

Ключевые структуры данных  
TimePredictor — Структура для прогнозирования оставшегося и общего времени дистилляции на основе изменения температуры и спиртуозности

---
void distiller_finish()
Завершить процесс дистилляции, выключить нагрев и сбросить счетчики
Возвращает
Исключения

---
void set_power_mode(String Mode)
Установить режим питания устройства
Аргументы
Mode — Режим питания в виде строки (например, "speed", "power")
Возвращает
Исключения

---
void set_power(bool On)
Включить или выключить питание нагревателя
Аргументы
On — true для включения, false для выключения
Возвращает
Исключения

---
void create_data()
Создать файл для записи данных текущей сессии дистилляции
Возвращает
Исключения

---
void open_valve(bool Val, bool msg)
Открыть или закрыть клапан подачи пара
Аргументы
Val — true для открытия, false для закрытия
msg — true для отправки уведомления о состоянии клапана
Возвращает
Исключения

---
void set_pump_pwm(float duty)
Установить значение ШИМ для управления насосом
Аргументы
duty — Значение ШИМ в диапазоне 0–100 (%)
Возвращает
Исключения

---
void set_pump_speed_pid(float temp)
Установить скорость насоса на основе ПИД-регулирования по целевой температуре
Аргументы
temp — Целевая температура для регулирования
Возвращает
Исключения

---
void set_dist_program(String WProgram)
Установить программу дистилляции из строки с параметрами
Аргументы
WProgram — Строка, описывающая этапы программы дистилляции
Возвращает
Исключения

---
void run_dist_program(uint8_t num)
Перейти к выполнению указанного этапа программы дистилляции
Аргументы
num — Номер строки программы (этапа)
Возвращает
Исключения

---
String get_dist_program()
Получить текущую программу дистилляции в виде строки
Возвращает
Строка, содержащая описание программы дистилляции
Исключения

---
void resetTimePredictor()
Сбросить данные прогнозирования времени дистилляции
Возвращает
Исключения

---
void updateTimePredictor()
Обновить внутренние данные прогнозирования времени на основе текущих показаний
Возвращает
Исключения

---
float get_dist_remaining_time()
Получить расчетное оставшееся время дистилляции
Возвращает
Оставшееся время в минутах
Исключения

---
float get_dist_predicted_total_time()
Получить расчетное общее время дистилляции
Возвращает
Общее прогнозируемое время в минутах
Исключения

---
void check_alarm_distiller()
Проверить наличие аварийных ситуаций (перегрев, давление, ошибки датчиков)
Возвращает
Исключения

---
void set_buzzer(bool On)
Включить или выключить звуковой сигнал (бuzzer)
Аргументы
On — true для включения, false для выключения
Возвращает
Исключения

---
void set_current_power(float power)
Установить текущее значение мощности нагрева
Аргументы
power — Мощность в ваттах
Возвращает
Исключения

---
void set_pump_speed(float speed, bool msg)
Установить скорость насоса вручную
Аргументы
speed — Скорость насоса (условные единицы)
msg — true для отправки уведомления о смене скорости
Возвращает
Исключения

---
void set_body_temp()
Обновить значение температуры тела колонны на основе данных датчика
Возвращает
Исключения

---
int get_liquid_volume()
Получить текущий объем накопленного дистиллята
Возвращает
Объем жидкости в миллилитрах
Исключения

---
String get_Samovar_Status()
Получить текстовое описание текущего статуса устройства
Возвращает
Строка с описанием статуса (например, "работает", "остановлен")
Исключения

---
float get_speed_from_rate(float rate)
Рассчитать скорость насоса на основе текущего расхода
Аргументы
rate — Текущий расход жидкости
Возвращает
Скорость насоса (условные единицы)
Исключения

---
float get_alcohol(float t)
Рассчитать спиртуозность жидкости по температуре кипения
Аргументы
t — Температура в градусах Цельсия
Возвращает
Спиртуозность в процентах
Исключения

---
float get_steam_alcohol(float t)
Рассчитать спиртуозность пара по температуре
Аргументы
t — Температура пара в градусах Цельсия
Возвращает
Спиртуозность пара в процентах
Исключения

---
void set_capacity(uint8_t cap)
Установить активную емкость для сбора дистиллята
Аргументы
cap — Номер емкости (1, 2 и т.д.)
Возвращает
Исключения

---
void reset_sensor_counter()
Сбросить счетчики импульсов с датчиков (расход, уровень и др.)
Возвращает
Исключения

---
void check_power_error()
Проверить наличие ошибок в цепи питания и выполнить действия при обнаружении
Возвращает
Исключения

---
void SendMsg(const String& m, MESSAGE_TYPE msg_type)
Отправить сообщение пользователю через доступные интерфейсы (экран, MQTT)
Аргументы
m — Текст сообщения
msg_type — Тип сообщения (уведомление, ошибка и т.п.)
Возвращает
Исключения

---
bool check_boiling()
Проверить, началось ли кипячение по динамике температуры
Возвращает
true, если кипячение идет, иначе false
Исключения

---
class TimePredictor
Структура для прогнозирования времени процесса дистилляции
Поля
startTime — Время начала процесса (мс)
initialAlcohol — Начальное содержание спирта (%)
initialTemp — Начальная температура (°C)
lastTemp — Последняя измеренная температура (°C)
tempChangeRate — Скорость изменения температуры (°C/мин)
lastUpdateTime — Время последнего обновления прогноза (мс)
predictedTotalTime — Прогнозируемое общее время процесса (мин)
remainingTime — Оставшееся время до завершения (мин)
Методы
