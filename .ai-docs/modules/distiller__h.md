# distiller

Модуль реализует логику управления процессом дистилляции в устройстве "Самовар", включая контроль нагрева, насоса, клапанов, сбор данных и прогнозирование времени. Поддерживает работу с датчиками, ПИД-регулирование скорости насоса, обработку аварийных ситуаций и взаимодействие с пользователем через сообщения. Интегрирован с внешними системами (MQTT) и обеспечивает сохранение данных сессии.

Ключевые структуры данных  
TimePredictor — Структура для прогнозирования оставшегося и общего времени дистилляции на основе изменения температуры и спиртуозности  
QualityParams — структура, содержащая оценку качества процесса дистилляции, включая общий балл и рекомендации  
program — массив структур, определяющих этапы дистилляции (тип, скорость, ёмкость, мощность)  
timePredictor — структура для хранения данных прогнозирования времени завершения этапа

---
void distiller_finish()
Завершает процесс дистилляции: отключает нагрев, формирует сообщение о времени работы и останавливает процесс
Аргументы
Возвращает
Исключения

---
void set_power_mode(String Mode)
Устанавливает режим питания устройства
Аргументы
Mode — Режим питания в виде строки (например, "speed", "power")
Возвращает
Исключения

---
void set_power(bool On)
Включает или отключает подачу мощности на нагреватель
Аргументы
On — true для включения, false для выключения
Возвращает
Исключения

---
void create_data()
Создаёт файл для записи данных текущей сессии дистилляции
Аргументы
Возвращает
Исключения

---
void open_valve(bool Val, bool msg)
Открывает или закрывает клапан подачи пара
Аргументы
Val — true для открытия, false для закрытия  
msg — true для отправки уведомления о состоянии клапана
Возвращает
Исключения

---
void open_valve(bool open, bool force)
Открывает или закрывает клапан подачи охлаждающей воды
Аргументы
open — true для открытия, false для закрытия  
force — если true, игнорирует блокировки и принудительно изменяет состояние
Возвращает
Исключения

---
void set_pump_pwm(float duty)
Устанавливает значение ШИМ для управления насосом
Аргументы
duty — Значение ШИМ в диапазоне 0.0–1.0
Возвращает
Исключения

---
void set_pump_pwm(int pwmValue)
Устанавливает ШИМ-сигнал для управления скоростью водяного насоса
Аргументы
pwmValue — значение ШИМ от 0 до 255
Возвращает
Исключения

---
void set_pump_speed_pid(float temp)
Устанавливает скорость насоса на основе ПИД-регулирования по целевой температуре
Аргументы
temp — Целевая температура, по которой рассчитывается скорость
Возвращает
Исключения

---
void set_pump_speed_pid(float targetTemp)
Управляет скоростью насоса охлаждения через PID-регулятор для поддержания заданной температуры воды
Аргументы
targetTemp — целевая температура охлаждающей воды
Возвращает
Исключения

---
void set_dist_program(String WProgram)
Устанавливает программу дистилляции из строки в формате, определённом протоколом
Аргументы
WProgram — Строка, описывающая программу дистилляции
Возвращает
Исключения

---
void run_dist_program(uint8_t num)
Переходит к выполнению указанной строки программы дистилляции
Аргументы
num — Номер строки программы (начиная с 0)
Возвращает
Исключения

---
void run_dist_program(int programStep)
Переходит к выполнению указанного шага программы дистилляции, обновляя параметры отбора
Аргументы
programStep — номер шага программы, который необходимо запустить
Возвращает
Исключения

---
String get_dist_program()
Возвращает текущую программу дистилляции в виде строки
Аргументы
Возвращает
Текущая программа дистилляции в виде строки
Исключения

---
void resetTimePredictor()
Сбрасывает данные прогнозирования времени дистилляции
Аргументы
Возвращает
Исключения

---
void resetTimePredictor()
Сбрасывает и инициализирует таймер прогнозирования времени начала и завершения дистилляции
Аргументы
Возвращает
Исключения

---
void updateTimePredictor()
Обновляет внутренние данные прогнозирования времени на основе текущих показаний
Аргументы
Возвращает
Исключения

---
void updateTimePredictor()
Обновляет внутренний прогноз времени завершения процесса дистилляции на основе текущих температур
Аргументы
Возвращает
Исключения

---
void update_distillation_time_prediction(float dS, float alcoholChangeRate, float currentTime)
Обновляет предиктор времени дистилляции на основе текущих данных
Аргументы
dS — Изменение объёма спирта с предыдущего шага  
alcoholChangeRate — Текущая скорость изменения объёма спирта (единиц в минуту)  
currentTime — Текущее время в миллисекундах
Возвращает
Исключения

---
float get_dist_remaining_time()
Возвращает расчётное оставшееся время дистилляции
Аргументы
Возвращает
Оставшееся время в минутах
Исключения

---
float get_dist_predicted_total_time()
Возвращает расчётное общее время дистилляции
Аргументы
Возвращает
Общее прогнозируемое время в минутах
Исключения

---
void check_alarm_distiller()
Проверяет наличие аварийных ситуаций (перегрев, ошибки датчиков и т.п.)
Аргументы
Возвращает
Исключения

---
void check_alarm_distiller()
Выполняет проверку аварийных условий: перегрев, отсутствие воды, состояние клапанов и насосов
Аргументы
Возвращает
Исключения

---
void set_buzzer(bool On)
Включает или выключает звуковой сигнал (бuzzer)
Аргументы
On — true для включения, false для выключения
Возвращает
Исключения

---
void set_buzzer(bool on)
Включает или выключает звуковую индикацию (пищалку)
Аргументы
on — true для включения, false для выключения
Возвращает
Исключения

---
void set_current_power(float power)
Устанавливает текущее значение мощности нагрева
Аргументы
power — Мощность в ваттах
Возвращает
Исключения

---
void set_current_power(float voltage)
Устанавливает целевое напряжение на нагреватель для регулирования мощности
Аргументы
voltage — целевое напряжение в вольтах
Возвращает
Исключения

---
void set_pump_speed(float speed, bool msg)
Устанавливает скорость насоса вручную
Аргументы
speed — Скорость насоса (условные единицы)  
msg — true для отправки уведомления о смене скорости
Возвращает
Исключения

---
void set_body_temp()
Устанавливает текущую температуру тела колонны на основе данных с датчика
Аргументы
Возвращает
Исключения

---
int get_liquid_volume()
Возвращает текущий объём жидкости в приёмнике
Аргументы
Возвращает
Объём жидкости в миллилитрах
Исключения

---
String get_Samovar_Status()
Возвращает текстовое описание текущего статуса устройства
Аргументы
Возвращает
Строка с описанием статуса (например, "работает", "остановлен")
Исключения

---
float get_speed_from_rate(float rate)
Рассчитывает скорость насоса на основе текущего расхода
Аргументы
rate — Текущий расход жидкости
Возвращает
Скорость насоса, соответствующая расходу
Исключения

---
float get_alcohol(float t)
Рассчитывает спиртуозность дистиллята по температуре пара
Аргументы
t — Температура пара (°C)
Возвращает
Спиртуозность в процентах
Исключения

---
float get_alcohol(float temp)
Рассчитывает текущую спиртуозность в кубе по температуре пара
Аргументы
temp — температура пара в градусах Цельсия
Возвращает
Оценка спиртуозности в процентах
Исключения

---
float get_steam_alcohol(float t)
Рассчитывает спиртуозность пара по температуре
Аргументы
t — Температура пара (°C)
Возвращает
Спиртуозность пара в процентах
Исключения

---
float get_steam_alcohol(float temp)
Рассчитывает спиртуозность в парах на выходе из куба с учётом давления и температуры
Аргументы
temp — температура пара в градусах Цельсия
Возвращает
Спиртуозность в парах в процентах
Исключения

---
void set_capacity(uint8_t cap)
Устанавливает активную ёмкость для сбора дистиллята
Аргументы
cap — Номер ёмкости (0, 1, ...)
Возвращает
Исключения

---
void reset_sensor_counter()
Сбрасывает счётчики импульсов с датчиков расхода
Аргументы
Возвращает
Исключения

---
void check_power_error()
Проверяет наличие ошибок в цепи питания и при необходимости отключает нагрев
Аргументы
Возвращает
Исключения

---
void check_water_temp()
Проверяет температуру воды и при превышении порога инициирует аварийные действия
Аргументы
Возвращает
Исключения

---
void SendMsg(const String& m, MESSAGE_TYPE msg_type)
Отправляет сообщение пользователю через доступные интерфейсы (например, MQTT, дисплей)
Аргументы
m — Текст сообщения  
msg_type — Тип сообщения (NOTIFY_MSG, ERROR_MSG и др.)
Возвращает
Исключения

---
void SendMsg(String message, int msgType)
Отправляет сообщение в интерфейс пользователя с указанием типа уведомления
Аргументы
message — текст сообщения  
msgType — тип сообщения (например, ALARM_MSG, WARNING_MSG, NOTIFY_MSG)
Возвращает
Исключения

---
void stop_process(String message)
Останавливает текущий технологический процесс и отправляет завершающее сообщение
Аргументы
message — текст сообщения о завершении
Возвращает
Исключения

---
#ifdef USE_WATER_PUMP
bool check_boiling()
Проверяет, началось ли кипячение по изменению давления или температуры
Аргументы
Возвращает
true, если кипячение обнаружено, иначе false
Исключения
#endif

---
#ifdef USE_WATER_PUMP
void check_boiling()
Определяет начало кипения по изменению температуры охлаждающей воды
Аргументы
Возвращает
Исключения
#endif

---
QualityParams getQualityAssessment()
Выполняет оценку текущего качества процесса дистилляции по нескольким параметрам
Возвращает
Структура QualityParams с оценками стабильности, эффективности и рекомендациями
Исключения

---
void _program(0)
Кратко инициализирует состояние дистилляции и сбрасывает прогноз времени
Аргументы
0 — фиктивный параметр, указывает на начало выполнения программы дистилляции
Возвращает
Исключения

---
class TimePredictor
Хранит и обновляет данные для прогнозирования времени дистилляции
Поля
startTime — Время начала процесса (мс)  
initialAlcohol — Начальная спиртуозность (%)  
initialTemp — Начальная температура (°C)  
lastTemp — Последняя зафиксированная температура (°C)  
tempChangeRate — Скорость изменения температуры (°C/мин)  
lastUpdateTime — Время последнего обновления прогноза (мс)  
predictedTotalTime — Прогнозируемое общее время процесса (мин)  
remainingTime — Оставшееся время до завершения (мин)
Методы
resetTimePredictor — Сбрасывает все значения прогноза  
updateTimePredictor — Обновляет прогноз на основе текущих данных
