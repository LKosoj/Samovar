# beer

Модуль реализует логику управления самоваром для пивоварения, включая контроль температуры, управление нагревателем по ПИД-регулятору, детектирование кипения, работу с насосом, клапанами, мешалкой и шаговым двигателем. Поддерживает MQTT-интеграцию, сохранение профилей, автотюнинг ПИД и обработку ошибок питания. Обеспечивает взаимодействие с пользователем через сообщения и управление режимами работы.

Ключевые структуры данных  
BoilingDetector — Структура для детектирования начала кипения по истории температур и статистическим показателям

---
void read_config()  
Прочитать конфигурацию устройства из энергонезависимой памяти.  
Возвращает  
Исключения

---
String getValue(const String& data, char separator, int index)  
Извлечь подстроку по индексу из строки, разделённой заданным символом.  
Аргументы  
data — Исходная строка  
separator — Разделитель  
index — Индекс требуемой части  
Возвращает  
Значение как строка  
Исключения

---
void startService(void)  
Запустить фоновые сервисные задачи, например, управление шаговым двигателем.  
Возвращает  
Исключения

---
void stopService(void)  
Остановить все запущенные сервисные задачи.  
Возвращает  
Исключения

---
void set_power_mode(String Mode)  
Установить режим питания устройства (например, "eco", "normal", "boost").  
Аргументы  
Mode — Строка, задающая режим питания  
Возвращает  
Исключения

---
void check_power_error()  
Проверить наличие ошибок питания и выполнить соответствующие действия (например, остановку процесса).  
Возвращает  
Исключения

---
void set_current_power(float Volt)  
Установить текущее значение мощности нагрева в вольтах.  
Аргументы  
Volt — Напряжение (мощность) в Вольтах  
Возвращает  
Исключения

---
void save_profile()  
Сохранить текущие настройки в активный профиль.  
Возвращает  
Исключения

---
void beer_finish()  
Завершить процесс затирания: отключить нагрев, насос, клапаны и сбросить состояние.  
Возвращает  
Исключения

---
void set_heater_state(float setpoint, float temp)  
Управление состоянием нагревателя на основе ПИД-регулирования.  
Аргументы  
setpoint — Целевая температура  
temp — Текущая температура  
Возвращает  
Исключения

---
void set_heater(double dutyCycle)  
Установить мощность нагревателя через ШИМ-сигнал.  
Аргументы  
dutyCycle — Скважность ШИМ в диапазоне от 0.0 до 1.0  
Возвращает  
Исключения

---
void setHeaterPosition(bool state)  
Включить или выключить нагреватель напрямую.  
Аргументы  
state — true для включения, false для выключения  
Возвращает  
Исключения

---
void run_beer_program(uint8_t num)  
Перейти к указанному этапу программы затирания и инициализировать его.  
Аргументы  
num — Номер строки программы (этапа)  
Возвращает  
Исключения

---
void StartAutoTune()  
Запустить процесс автотюнинга ПИД-регулятора.  
Возвращает  
Исключения

---
void FinishAutoTune()  
Завершить автотюнинг ПИД и применить вычисленные параметры.  
Возвращает  
Исключения

---
void set_power(bool On)  
Включить или выключить питание основных компонентов системы.  
Аргументы  
On — true для включения, false для выключения  
Возвращает  
Исключения

---
void create_data()  
Создать файл для записи данных текущей сессии (температура, этапы и т.д.).  
Возвращает  
Исключения

---
void open_valve(bool Val, bool msg)  
Открыть или закрыть клапан подачи жидкости.  
Аргументы  
Val — true для открытия, false для закрытия  
msg — true, если нужно отправить уведомление о действии  
Возвращает  
Исключения

---
void SendMsg(const String& m, MESSAGE_TYPE msg_type)  
Отправить сообщение пользователю через доступные интерфейсы (например, MQTT).  
Аргументы  
m — Текст сообщения  
msg_type — Тип сообщения (например, информационное, ошибка)  
Возвращает  
Исключения

---
String get_beer_program()  
Получить строковое описание текущей программы затирания.  
Возвращает  
Текстовое описание программы  
Исключения

---
void check_mixer_state()  
Проверить текущее состояние мешалки и насоса и при необходимости скорректировать.  
Возвращает  
Исключения

---
void set_mixer_state(bool state, bool dir)  
Установить состояние и направление вращения мешалки.  
Аргументы  
state — true для включения, false для выключения  
dir — true для реверса, false для прямого вращения  
Возвращает  
Исключения

---
bool set_mixer_pump_target(uint8_t on)  
Отправить команду на включение или выключение насоса мешалки через I2C.  
Аргументы  
on — 1 для включения, 0 для выключения  
Возвращает  
true в случае успеха, false при ошибке связи  
Исключения

---
bool set_stepper_by_time(uint16_t spd, uint8_t direction, uint16_t time)  
Управление шаговым двигателем на заданное время с указанной скоростью и направлением.  
Аргументы  
spd — Скорость двигателя (условные единицы)  
direction — Направление (0 — вперёд, 1 — назад)  
time — Время работы в миллисекундах  
Возвращает  
true если операция выполнена успешно  
Исключения

---
void HopStepperStep()  
Выполнить один шаг шагового двигателя для дозирования хмеля.  
Возвращает  
Исключения

---
void set_buzzer(bool fl)  
Включить или выключить звуковой сигнал (бuzzer).  
Аргументы  
fl — true для включения, false для выключения  
Возвращает  
Исключения

---
void set_pump_pwm(float duty)  
Установить уровень ШИМ для управления скоростью насоса.  
Аргументы  
duty — Значение ШИМ (0.0 — 1.0)  
Возвращает  
Исключения

---
void reset_sensor_counter(void)  
Сбросить счётчики датчиков и внутренние счётчики состояния процесса.  
Возвращает  
Исключения

---
bool isBoilingStarted(float currentTemp)  
Определить, началось ли кипение на основе анализа истории температур.  
Аргументы  
currentTemp — Текущее значение температуры в °C  
Возвращает  
true, если кипение зафиксировано, иначе false  
Исключения

---
static inline void resetBoilingDetector()  
Сбросить внутреннее состояние детектора кипения.  
Возвращает  
Исключения
