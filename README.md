# Проект Самовар

## Описание
Автоматизированная система управления самогонным аппаратом на базе ESP32.
Устройство контролирует температуры (ТСА, в кубе, в голове колонны, в царге и воды 
на выходе), управляет реле, шаговым двигателем с перистальтическим насосом для 
отбора из РК, сервоприводом для раздельного отбора (10 + 1 емкость). 
Имеет встроенный веб-сервер, сохраняет лог процесса, отображает графики (температуры и давление).
Реализовано аварийное отключение при выходе параметров за допустимые пределы.

## Основные возможности
- Поддержка различных режимов работы:
  - Ректификация
  - Дистилляция
  - БК (Бражная колонна)
  - НБК (Непрерывная бражная колонна)
  - Пивоварение
- Веб-интерфейс управления
- Интеграция:
  - Telegram уведомления
  - MQTT протокол
  - Blynk
  - Облачное хранилище данных
- Программируемые режимы работы через веб-интерфейс
- Встроенный интерпретатор Lua для расширения функционала
- Система безопасности и мониторинга
- Поддержка скриптового языка Lua для расширения функционала
- Возможность задать для каждого режима свои параметры в виде программы, управляющей процессом. Программа задается через веб-интерфейс, представляет собой набор строк, которые выполняются последовательно. Подробнее смотрите в документации и на форуме.
- Графическое отображение процесса
- Сохранение логов

## Требования
### Аппаратные
- ESP32
- Датчики температуры DS18B20 (5 шт)
- Датчик давления (MPX5010D или XGZ)
- LCD дисплей
- Энкодер с кнопкой
- Насос для подачи воды
- Шаговый двигатель
- Перистальтический насос
- Клапаны
- Сервопривод
- Блок питания

Схема подключения
![alt text](https://github.com/LKosoj/Samovar/blob/master/Fritzing%20scheme/Samovar_bb.png)

### Программные
- PlatformIO IDE или Arduino IDE
- Библиотеки:
  - OneWire
  - DallasTemperature
  - ESPAsyncWebServer
  - AsyncTCP
  - ESPAsyncWiFiManager
  - GyverEncoder
  - GyverButton
  - GyverPID
  - ESP32Servo
  - ArduinoJson
  - LittleFS

## Установка
1. Склонируйте репозиторий
2. Установите PlatformIO IDE или Arduino IDE
3. Установите необходимые библиотеки
4. Настройте параметры в файлах:
   - `Samovar_ini.h` - основные настройки
   - `user_config_override.h` - пользовательские настройки
5. Загрузите прошивку в ESP32
6. Загрузите файлы из папки `data` в файловую систему ESP32

## Структура проекта
- `Samovar.ino` - основной файл проекта
- `Samovar.h` - основные определения
- `logic.h` - логика работы
- `WebServer.ino` - веб-сервер
- `Blynk.ino` - интеграция с Blynk
- `beer.h` - режим пивоварения
- `distiller.h` - режим дистилляции
- `BK.h` - режим бражной колонны
- `nbk.h` - режим непрерывной бражной колонны
- `lua.h` - интерпретатор Lua

## Документация
Полная документация доступна на сайте: https://www.samovar-tool.ru/

[Техническая документация](/doc/tutorial.md)

## Поддержка
Проект некоммерческий. Обсуждение и поддержка на форуме:
https://forum.homedistiller.ru/index.php?topic=367128.0

## Демонстрация
Примеры работы системы: https://www.samovar-tool.ru/2021/03/21/o-rabote-samovara/

## Сравнение с другими проектами

### Ректификация/дистилляция
Давайте сравним функционал проекта "Самовар" с коммерческими решениями для ректификации и дистилляции, разделив их на три категории:

1.  **Базовые цифровые контроллеры** (например, популярные PID-регуляторы в коробке, контроллеры от Still Spirits и т.п.).
2.  **Продвинутые хоббийные контроллеры** (например, системы от HomeDistiller, кастомные сборки от известных производителей оборудования).
3.  **Промышленные/лабораторные ПЛК-системы** (Programmable Logic Controller — программируемые логические контроллеры).

---

### Сравнительный анализ функционала для дистилляции/ректификации

| Функциональный блок | Проект "Самовар" (DIY) | Базовый контроллер | Продвинутый хобби-контроллер | Промышленный ПЛК |
| :--- | :--- | :--- | :--- | :--- |
| **1. Основная логика управления** | **Динамическое управление процессом.** Логика зависит от стадии, температуры, давления, времени и **событий**. | **Статическое поддержание параметра.** Обычно это термостат: держит заданную температуру или мощность. | **Пошаговое программирование.** Выполнение рецепта вида: "греть до 80°С -> держать 20 мин -> греть до 90°С". | **Полностью программируемая логика.** Реализуется любая, даже самая сложная взаимосвязь между параметрами. |
| **2. Управление мощностью** | **Плавное, точное.** ПИД-регулирование мощности через внешние регуляторы (симисторы, SSR). | **Дискретное (Вкл/Выкл).** Простое реле, приводящее к инерционным скачкам температуры. | **Плавное.** Обычно ПИД-управление через ФИМ (фазо-импульсная модуляция) для SSR. | **Плавное, прецизионное.** Управление с обратной связью по мощности. |
| **3. Управление отбором продукта** | **Ключевая функция.** **Высокоточное управление шаговым двигателем насоса** или сервоприводом клапана. Скорость отбора задается в мл/час и автоматически поддерживается. | **Отсутствует.** Управляется вручную оператором. | **Обычно отсутствует или опционально.** Может управлять простым клапаном (открыт/закрыт), но редко — скоростью отбора. | **Полный контроль.** Управление любыми типами клапанов и насосов с контролем потока. |
| **4. Адаптивность к процессу** | **Очень высокая.** **Автокоррекция температуры кипения по давлению.** **Автоматическое снижение скорости отбора** при "подходе хвостов". **Полная кастомизация логики через Lua.** | **Нулевая.** Не реагирует ни на что, кроме отклонения от заданной температуры. | **Низкая.** Может переключить шаг рецепта по событию (например, по достижению температуры), но не может динамически изменять параметры текущего шага. | **Абсолютная.** Логика пишется под конкретную установку и процесс. |
| **5. Интерфейс и мониторинг** | **Современный.** Веб-интерфейс с графиками в реальном времени, удаленный доступ, локальный LCD. | **Примитивный.** Цифровой индикатор и несколько кнопок. | **Функциональный, но утилитарный.** Часто это текстовый LCD, опционально — вывод данных на ПК через RS-485/USB. | **Промышленный.** SCADA-системы с полной визуализацией процесса, архивацией, отчетами. |
| **6. Безопасность** | **Многоуровневая, настраиваемая.** Контроль температуры, давления, воды, ошибок питания. Логика аварии задается пользователем. | **Базовая.** Обычно только защита от перегрева. | **Хорошая.** Контроль нескольких датчиков, сторожевые таймеры. | **Максимальная.** Дублирование систем, сертифицированные компоненты, аппаратные защиты. |
| **7. Интеграции (IoT)** | **Встроенные.** MQTT, Telegram, Blynk "из коробки". | **Отсутствуют.** | **Редко.** Обычно это проприетарные протоколы или ModBus для связи с ПК. | **Стандарт.** OPC-UA, ModBus, Profinet и др. промышленные протоколы. |
| **8. Примерная стоимость** | **Низкая** (~$50-100 за электронику). | **Низкая** (~$50-150). | **Средняя/Высокая** (~$300-800). | **Очень высокая** (тысячи $). |

---

### Позиционирование "Самовара" относительно других проектов для дистилляции

1.  **"Самовар" на голову превосходит базовые контроллеры.** Он не просто заменяет их, а предлагает совершенно иной уровень автоматизации. Там, где базовый контроллер — это "умная розетка", "Самовар" — это "мозг" установки.

2.  **"Самовар" является прямым и очень сильным конкурентом продвинутым хобби-контроллерам.** Он не только не уступает им в основных функциях (ПИД-регулирование мощности, пошаговые программы), но и **превосходит их в двух критически важных для ректификации областях:**
    *   **Интегрированное управление отбором:** У коммерческих систем управление отбором — это, как правило, отдельное, дорогое устройство. "Самовар" делает это своей основной функцией.
    *   **Гибкость логики:** Ни один коммерческий хобби-контроллер не предлагает программирование логики на уровне Lua. Эта возможность переносит "Самовар" в полупрофессиональную лигу, позволяя реализовать алгоритмы, доступные ранее только на промышленных ПЛК.

3.  **"Самовар" заимствует концепции у промышленных ПЛК-систем.** Идея полностью программируемой логики, реагирующей на множество асинхронных событий, — это основа ПЛК. "Самовар" демократизирует этот подход, делая его доступным для хоббиста на дешевой аппаратной базе. Разумеется, он уступает в надежности, помехозащищенности и не имеет промышленных сертификатов, но с точки зрения **функциональной логики** — он стремится именно в эту высшую лигу.

**Итоговый вывод:**

Проект "Самовар" — это не просто DIY-поделка. В контексте оборудования для дистилляции/ректификации он представляет собой **систему, которая по своему функционалу оставляет далеко позади остальные DIY решения и напрямую конкурирует с дорогими продвинутыми контроллерами, превосходя их в гибкости и возможностях кастомизации.**

Его главный компромисс — это не функционал, а **"удобство против гибкости"**. Покупая коммерческий прибор, вы получаете гарантию, поддержку и готовое к работе устройство. Выбирая "Самовар", вы получаете практически безграничные возможности для автоматизации в обмен на необходимость самостоятельно собирать, настраивать и обслуживать систему.

### Сравнительный анализ функционала для режима пивоварения

Ниже приведен сравнительный анализ функционала проекта "Самовар" с другими популярными open-source/DIY проектами в области автоматизации пивоварения.

Для сравнения возьмем несколько известных проектов, представляющих разные подходы:
1.  **BrewPi / BrewPiLess:** Исторически один из самых известных проектов для **контроля ферментации** пива.
2.  **CraftBeerPi (v3/v4):** Очень популярный и модульный контроллер для **пивоварения** (затирание, кипячение), работающий на Raspberry Pi.
3.  **ArdBir / ESPurno:** Более простые контроллеры на Arduino/ESP, ориентированные в основном на процесс пивоварения.

---

### Сравнительный анализ по ключевым параметрам

| Функциональный блок | Проект "Самовар" | BrewPi / BrewPiLess | CraftBeerPi 4 | Типичные DIY-проекты (ArdBir и др.) |
| :--- | :--- | :--- | :--- | :--- |
| **1. Целевое назначение** | **Универсальный.** Дистилляция, ректификация, пивоварение, НБК. | **Специализированный.** В основном, точный контроль температуры ферментации. | **Специализированный.** Полный цикл пивоварения (затирание, кипячение). | **Специализированный.** Обычно только пивоварение (затирание). |
| **2. Гибкость автоматизации** | **Очень высокая.** Пошаговые программы + **Lua-скрипты** для любой кастомной логики. | **Средняя.** Профили температуры (график "температура-время"). | **Высокая.** Пошаговые рецепты, гибкая система плагинов для расширения. | **Низкая.** Жестко заданная логика, максимум — настройка температурных пауз. |
| **3. Управление оборудованием** | **Точное и комплексное.** Управление шаговым двигателем (точный отбор), сервоприводом (смена емкостей), плавная регулировка мощности. | **Точное.** ПИД-управление нагревом и охлаждением для поддержания температуры. | **Модульное.** Управление клапанами, насосами, мешалкой через реле. PWM для мощности. | **Базовое.** В основном, релейное управление (включил/выключил). |
| **4. Интерфейс и мониторинг** | **Комплексный.** Веб-интерфейс с графиками, файловым менеджером + локальный LCD-дисплей с энкодером. | **Минималистичный.** Веб-интерфейс для настройки профиля и просмотра графика. | **Продвинутый.** Современный веб-интерфейс, полностью настраиваемая панель приборов. | **Базовый.** Обычно только LCD-дисплей, редко — простой веб-интерфейс. |
| **5. Интеграции и IoT** | **Встроенные.** MQTT, Blynk, Telegram "из коробки". | **Ограниченные.** Интеграция с iSpindel, в некоторых форках есть MQTT. | **Широкие (через плагины).** MQTT, iSpindel, оповещения и многое другое. | **Практически отсутствуют.** |
| **6. Аппаратная платформа** | **ESP32.** Низкая стоимость, высокая производительность для real-time задач. | **ESP8266/ESP32.** | **Raspberry Pi.** Полноценный компьютер, выше стоимость и энергопотребление. | **Arduino/ESP8266.** |

---

### Заключение и позиционирование проекта "Самовар"

Проект "Самовар" занимает **уникальную нишу на стыке профессиональной гибкости и DIY-доступности**, сильно выделяясь на фоне аналогов.

**1. "Самовар" — это швейцарский нож, в то время как конкуренты — это специализированные инструменты.**
Большинство проектов (CraftBeerPi, BrewPi) созданы для решения одной задачи — пивоварения. Они делают это хорошо, но их логика и функционал не подходят для ректификации. "Самовар" изначально спроектирован как универсальная платформа, способная управлять кардинально разными процессами. Это его главное и самое сильное отличие.

**2. Уровень автоматизации "Самовара" на порядок выше.**
В то время как другие проекты предлагают параметризацию (задать температуру, время) или пошаговые рецепты, "Самовар" идет дальше, дополнительно предлагая **полноценное программирование логики через Lua**. Это позволяет опытным пользователям реализовывать сложнейшие алгоритмы, которые невозможно реализовать в других системах без модификации их исходного кода.

**3. "Все в одном" на доступной платформе.**  
"Самовар" предоставляет функционал (веб-сервер, графики, сложная логика, множество интеграций), который у конкурентов часто требует более мощной и дорогой платформы, как Raspberry Pi (в случае с CraftBeerPi). При этом он сохраняет преимущество микроконтроллеров (ESP32) — надежность и работу в режиме реального времени.

**4. "Самовар" — это не просто контроллер.**  
"Самовар" — это не просто контроллер. Это универсальная платформа, которая может управлять множеством процессов. Это позволяет опытным пользователям реализовывать сложнейшие алгоритмы, которые невозможно реализовать в других системах без модификации их исходного кода.

**Вывод:**

Проект "Самовар" не является "просто еще одним контроллером". Это **высокоуровневый процессинговый контроллер**, ориентированный на энтузиастов, которые хотят получить максимальный контроль над процессами пивоварения, ректификации, дистилляции, бражной колонны и т.д.
